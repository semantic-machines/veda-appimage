;(function (global) {
  var console = {
    log: logger("LOG"),
    error: logger("ERROR"),
    info: logger("INFO"),
    time: function (timer) {
      this[timer] = new Date();
    },
    timeEnd: function (timer) {
      var delta = new Date() - this[timer];
      this.info(timer, delta, "msec");
    }
  };
  function logger(NAME) {
    return function () {
      var args = [].slice.call(arguments);
      print.apply(global, [NAME + ":"].concat(args));
    }
  };
  global.console = console;
})(this);
// https://github.com/fluffynuts/synchronous-promise
;(function (global) {

  /* jshint node: true */
  "use strict";
  function makeArrayFrom(obj) {
    return Array.prototype.slice.apply(obj);
  }
  var
    PENDING = "pending",
    RESOLVED = "resolved",
    REJECTED = "rejected";

  function SynchronousPromise(handler) {
    this.status = PENDING;
    this._continuations = [];
    this._parent = null;
    this._paused = false;
    if (handler) {
      handler.call(
        this,
        this._continueWith.bind(this),
        this._failWith.bind(this)
      );
    }
  }

  function looksLikeAPromise(obj) {
    return obj && typeof (obj.then) === "function";
  }

  SynchronousPromise.prototype = {
    then: function (nextFn, catchFn) {
      var next = SynchronousPromise.unresolved()._setParent(this);
      if (this._isRejected()) {
        if (this._paused) {
          this._continuations.push({
            promise: next,
            nextFn: nextFn,
            catchFn: catchFn
          });
          return next;
        }
        if (catchFn) {
          try {
            var catchResult = catchFn(this._error);
            if (looksLikeAPromise(catchResult)) {
              this._chainPromiseData(catchResult, next);
              return next;
            } else {
              return SynchronousPromise.resolve(catchResult)._setParent(this);
            }
          } catch (e) {
            return SynchronousPromise.reject(e)._setParent(this);
          }
        }
        return SynchronousPromise.reject(this._error)._setParent(this);
      }
      this._continuations.push({
        promise: next,
        nextFn: nextFn,
        catchFn: catchFn
      });
      this._runResolutions();
      return next;
    },
    catch: function (handler) {
      if (this._isResolved()) {
        return SynchronousPromise.resolve(this._data)._setParent(this);
      }
      var next = SynchronousPromise.unresolved()._setParent(this);
      this._continuations.push({
        promise: next,
        catchFn: handler
      });
      this._runRejections();
      return next;
    },
    pause: function () {
      this._paused = true;
      return this;
    },
    resume: function () {
      var firstPaused = this._findFirstPaused();
      if (firstPaused) {
        firstPaused._paused = false;
        firstPaused._runResolutions();
        firstPaused._runRejections();
      }
      return this;
    },
    _findAncestry: function () {
      return this._continuations.reduce(function (acc, cur) {
        if (cur.promise) {
          var node = {
            promise: cur.promise,
            children: cur.promise._findAncestry()
          };
          acc.push(node);
        }
        return acc;
      }, []);
    },
    _setParent: function (parent) {
      if (this._parent) {
        throw new Error("parent already set");
      }
      this._parent = parent;
      return this;
    },
    _continueWith: function (data) {
      var firstPending = this._findFirstPending();
      if (firstPending) {
        firstPending._data = data;
        firstPending._setResolved();
      }
    },
    _findFirstPending: function () {
      return this._findFirstAncestor(function (test) {
        return test._isPending && test._isPending();
      });
    },
    _findFirstPaused: function () {
      return this._findFirstAncestor(function (test) {
        return test._paused;
      });
    },
    _findFirstAncestor: function (matching) {
      var test = this;
      var result;
      while (test) {
        if (matching(test)) {
          result = test;
        }
        test = test._parent;
      }
      return result;
    },
    _failWith: function (error) {
      var firstRejected = this._findFirstPending();
      if (firstRejected) {
        firstRejected._error = error;
        firstRejected._setRejected();
      }
    },
    _takeContinuations: function () {
      return this._continuations.splice(0, this._continuations.length);
    },
    _runRejections: function () {
      if (this._paused || !this._isRejected()) {
        return;
      }
      var
        error = this._error,
        continuations = this._takeContinuations(),
        self = this;
      continuations.forEach(function (cont) {
        if (cont.catchFn) {
          try {
            var catchResult = cont.catchFn(error);
            self._handleUserFunctionResult(catchResult, cont.promise);
          } catch (e) {
            var message = e.message;
            cont.promise.reject(e);
          }
        } else {
          cont.promise.reject(error);
        }
      });
    },
    _runResolutions: function () {
      if (this._paused || !this._isResolved()) {
        return;
      }
      var continuations = this._takeContinuations();
      if (looksLikeAPromise(this._data)) {
        return this._handleWhenResolvedDataIsPromise(this._data);
      }
      var data = this._data;
      var self = this;
      continuations.forEach(function (cont) {
        if (cont.nextFn) {
          try {
            var result = cont.nextFn(data);
            self._handleUserFunctionResult(result, cont.promise);
          } catch (e) {
            self._handleResolutionError(e, cont);
          }
        } else if (cont.promise) {
          cont.promise.resolve(data);
        }
      });
    },
    _handleResolutionError: function (e, continuation) {
      this._setRejected();
      if (continuation.catchFn) {
        try {
          continuation.catchFn(e);
          return;
        } catch (e2) {
          e = e2;
        }
      }
      if (continuation.promise) {
        continuation.promise.reject(e);
      }
    },
    _handleWhenResolvedDataIsPromise: function (data) {
      var self = this;
      return data.then(function (result) {
        self._data = result;
        self._runResolutions();
      }).catch(function (error) {
        self._error = error;
        self._setRejected();
        self._runRejections();
      });
    },
    _handleUserFunctionResult: function (data, nextSynchronousPromise) {
      if (looksLikeAPromise(data)) {
        this._chainPromiseData(data, nextSynchronousPromise);
      } else {
        nextSynchronousPromise.resolve(data);
      }
    },
    _chainPromiseData: function (promiseData, nextSynchronousPromise) {
      promiseData.then(function (newData) {
        nextSynchronousPromise.resolve(newData);
      }).catch(function (newError) {
        nextSynchronousPromise.reject(newError);
      });
    },
    _setResolved: function () {
      this.status = RESOLVED;
      if (!this._paused) {
        this._runResolutions();
      }
    },
    _setRejected: function () {
      this.status = REJECTED;
      if (!this._paused) {
        this._runRejections();
      }
    },
    _isPending: function () {
      return this.status === PENDING;
    },
    _isResolved: function () {
      return this.status === RESOLVED;
    },
    _isRejected: function () {
      return this.status === REJECTED;
    }
  };

  SynchronousPromise.resolve = function (result) {
    return new SynchronousPromise(function (resolve, reject) {
      if (looksLikeAPromise(result)) {
        result.then(function (newResult) {
          resolve(newResult);
        }).catch(function (error) {
          reject(error);
        });
      } else {
        resolve(result);
      }
    });
  };

  SynchronousPromise.reject = function (result) {
    return new SynchronousPromise(function (resolve, reject) {
      reject(result);
    });
  };

  SynchronousPromise.unresolved = function () {
    return new SynchronousPromise(function (resolve, reject) {
      this.resolve = resolve;
      this.reject = reject;
    });
  };

  SynchronousPromise.all = function () {
    var args = makeArrayFrom(arguments);
    if (Array.isArray(args[0])) {
      args = args[0];
    }
    if (!args.length) {
      return SynchronousPromise.resolve([]);
    }
    return new SynchronousPromise(function (resolve, reject) {
      var
        allData = [],
        numResolved = 0,
        doResolve = function () {
          if (numResolved === args.length) {
            resolve(allData);
          }
        },
        rejected = false,
        doReject = function (err) {
          if (rejected) {
            return;
          }
          rejected = true;
          reject(err);
        };
      args.forEach(function (arg, idx) {
        SynchronousPromise.resolve(arg).then(function (thisResult) {
          allData[idx] = thisResult;
          numResolved += 1;
          doResolve();
        }).catch(function (err) {
          doReject(err);
        });
      });
    });
  };

  /* jshint ignore:start */
  if (Promise === SynchronousPromise) {
    throw new Error("Please use SynchronousPromise.installGlobally() to install globally");
  }
  var RealPromise = Promise;
  SynchronousPromise.installGlobally = function(__awaiter) {
    if (Promise === SynchronousPromise) {
      return __awaiter;
    }
    var result = patchAwaiterIfRequired(__awaiter);
    Promise = SynchronousPromise;
    return result;
  };

  SynchronousPromise.uninstallGlobally = function() {
    if (Promise === SynchronousPromise) {
      Promise = RealPromise;
    }
  };

  function patchAwaiterIfRequired(__awaiter) {
    if (typeof(__awaiter) === "undefined" || __awaiter.__patched) {
      return __awaiter;
    }
    var originalAwaiter = __awaiter;
    __awaiter = function() {
      var Promise = RealPromise;
      originalAwaiter.apply(this, makeArrayFrom(arguments));
    };
    __awaiter.__patched = true;
    return __awaiter;
  }
  /* jshint ignore:end */

  global.Promise = SynchronousPromise;

})(this);
var veda=function(){"use strict";
/* Riot 1.0.4, @license MIT, (c) 2014 Muut Inc + contributors */var riot={observable:function(e){if(e.on&&e.one&&e.off&&e.trigger)return e;var t={},i=[].slice;return e.on=function(i,r){return"function"==typeof r&&i.replace(/[^\s]+/g,(function(e,i){(t[e]=t[e]||[]).push(r),r.typed=i>0})),e},e.off=function(i,r){if("*"===i)t={};else if(r)for(var n,o=t[i],a=0;n=o&&o[a];++a)n===r&&(o.splice(a,1),a--);else i.replace(/[^\s]+/g,(function(e){t[e]=[]}));return e},e.one=function(t,i){return i&&(i.one=!0),e.on(t,i)},e.trigger=function(r){var n=i.call(arguments,1),o=t[r]||[],a=0;return o.reduce(((t,i,s)=>t.then((()=>(i.one&&(o.splice(s-a,1),a++),i.apply(e,i.typed?[r].concat(n):n))))),Promise.resolve()).then((()=>e))},e}},FN={},template_escape={"\\":"\\\\","\n":"\\n","\r":"\\r","'":"\\'"},render_escape={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};function default_escape_fn(e,t){return null==e?"":(e+"").replace(/[&\"<>]/g,(function(e){return render_escape[e]}))}riot.render=function(e,t,i){return!0===i&&(i=default_escape_fn),(FN[e=e||""]=FN[e]||new Function("_","e","return '"+e.replace(/[\\\n\r']/g,(function(e){return template_escape[e]})).replace(/{\s*([\w\.]+)\s*}/g,"' + (e?e(_.$1,'$1'):_.$1||(_.$1==null?'':_.$1)) + '")+"'"))(t,i)},function(){if("undefined"!=typeof window){var e=riot.observable({}),t=window.addEventListener,i=document;t?t("popstate",r,!1):i.attachEvent("onreadystatechange",(function(){r("")})),riot.route=function(t,i){if("function"==typeof t)return e.on("pop",t);history.pushState&&history.pushState(0,0,t),i||r(t)}}function r(t){t=t.type?location.hash:t,e.trigger("pop",t)}}();const veda=riot.observable({env:"undefined"==typeof window?"server":"browser"}),serverBackend={status:"limited",query:function(e,t,i,r,n,o,a){const s=e;"object"==typeof s&&(e=s.ticket,t=s.query,i=s.sort,r=s.databases,n=s.top,o=s.limit,a=s.from);try{return Promise.resolve(query(e,t,i,r,n,o,a))}catch(e){return Promise.reject(e)}},get_individual:function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.uri);try{const i=get_individual(e,t);return i?Promise.resolve(i):Promise.reject(Error("Not found"))}catch(e){return Promise.reject(e)}}};serverBackend.reset_individual=serverBackend.get_individual,serverBackend.get_individuals=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.uris);try{return Promise.resolve(get_individuals(e,t))}catch(e){return Promise.reject(e)}},serverBackend.remove_individual=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.uri);try{return Promise.resolve(remove_individual(e,t))}catch(e){return Promise.reject(e)}},serverBackend.put_individual=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.individual);try{return Promise.resolve(put_individual(e,t))}catch(e){return Promise.reject(e)}},serverBackend.add_to_individual=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.individual);try{return Promise.resolve(add_to_individual(e,t))}catch(e){return Promise.reject(e)}},serverBackend.set_in_individual=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.individual);try{return Promise.resolve(set_in_individual(e,t))}catch(e){return Promise.reject(e)}},serverBackend.remove_from_individual=function(e,t){const i=e;"object"==typeof i&&(e=i.ticket,t=i.individual);try{return Promise.resolve(remove_from_individual(e,t))}catch(e){return Promise.reject(e)}};const fallback={get:function(e){return Promise.resolve(this[e])},put:function(e,t){return this[e]=t,Promise.resolve(t)},remove:function(e){const t=delete this[e];return Promise.resolve(t)}};function LocalDB(){return this.veda_version=veda.manifest.veda_version,this.db_name=veda.manifest.short_name,this.store_name="store",LocalDB.prototype[this.db_name+this.store_name]?Promise.resolve(LocalDB.prototype[this.db_name+this.store_name]):LocalDB.prototype[this.db_name+this.store_name]=this.initDB()}const proto=LocalDB.prototype;proto.initDB=function(){return new Promise(((e,t)=>{const i=window.indexedDB.open(this.db_name,this.veda_version);i.onsuccess=t=>{const i=t.target.result;this.db=i,console.log(`DB open success, veda_version = ${this.veda_version}`),e(this)},i.onerror=e=>{console.log("DB open error",e),t(e)},i.onblocked=function(e){alert("Пожалуйста, закройте другие открытые вкладки системы! \nPlease close all other open tabs with the system!")},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.store_name)&&(t.deleteObjectStore(this.store_name),console.log(`DB store deleted: ${this.store_name}`)),t.createObjectStore(this.store_name),console.log(`DB create success: ${this.store_name}, veda_version = ${this.veda_version}`)}})).catch((e=>(console.log("IndexedDB error, using in-memory fallback.",e),fallback)))},proto.get=function(e){return new Promise(((t,i)=>{const r=this.db.transaction([this.store_name],"readonly").objectStore(this.store_name).get(e);r.onerror=i,r.onsuccess=e=>t(e.target.result)}))},proto.put=function(e,t){return new Promise(((i,r)=>{const n=this.db.transaction([this.store_name],"readwrite").objectStore(this.store_name).put(t,e);n.onerror=r,n.onsuccess=()=>i(t)}))},proto.remove=function(e){return new Promise(((t,i)=>{const r=this.db.transaction([this.store_name],"readwrite").objectStore(this.store_name).delete(e);r.onerror=i,r.onsuccess=e=>t(e.target.result)}))};const errorCodes={0:"Server unavailable",400:"Bad request",403:"Forbidden",404:"Not found",422:"Unprocessable entity",423:"Locked",429:"Too many requests",430:"Too many password change fails",463:"Password change is not allowed",464:"Secret expired",465:"Empty password",466:"New password is equal to old",467:"Invalid password",468:"Invalid secret",469:"Password expired",470:"Ticket not found",471:"Ticket expired",472:"Not authorized",473:"Authentication failed",474:"Not ready",475:"Fail open transaction",476:"Fail commit",477:"Fail store",500:"Internal server error",501:"Not implemented",503:"Service unavailable",904:"Invalid identifier",999:"Database modified error",1021:"Disk full",1022:"Duplicate key",1118:"Size too large",4e3:"Connect error"};function BackendError(e){this.code=e.status,this.message=void 0!==this.code?`${this.code}: ${errorCodes[this.code]}`:void 0,this.stack=(new Error).stack}BackendError.prototype=Object.create(Error.prototype),BackendError.prototype.constructor=BackendError;const browserBackend={},default_timeout=15e3,query_timeout=10*default_timeout;browserBackend.ping=function(){return new Promise(((e,t)=>{const i=new XMLHttpRequest;i.onload=function(){200==this.status?e(this):t(Error("ping failed"))},i.onerror=t,i.ontimeout=t,i.open("GET","/ping"),i.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate"),i.timeout=default_timeout,i.send()}))},browserBackend.status="offline";const status={};function setStatus(e){status.line="online"===e?1:"offline"===e?0:status.line,status.ccus="ccus-online"===e?1:"ccus-offline"===e?0:status.ccus,status.line&&status.ccus?browserBackend.status="online":status.line&&!status.ccus?browserBackend.status="limited":browserBackend.status="offline",this.trigger("status",browserBackend.status)}let interval;veda.on("online offline ccus-online ccus-offline",setStatus);const duration=default_timeout,check=function(){browserBackend.ping().then((()=>{interval=clearInterval(interval),veda.trigger("online")})).catch((()=>{veda.trigger("offline")}))};function call_server(e){const t=e.method,i=e.url,r=e.data,n=e.ticket,o=e.timeout||default_timeout;let a=[],s=null;return new Promise(((e,l)=>{const d=new XMLHttpRequest;if(d.onload=function(){200==this.status?e(JSON.parse(this.response)):l(new BackendError(this))},d.onerror=function(){l(new BackendError(this))},d.ontimeout=function(){l(new BackendError(this))},n&&a.push("ticket="+n),"GET"===t){for(const e in r)void 0!==r[e]&&a.push(e+"="+encodeURIComponent(r[e]));a=a.join("&")}d.open(t,i+"?"+a,!0),d.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate"),d.timeout=o,"GET"!==t&&(d.setRequestHeader("Content-Type","application/json;charset=UTF-8"),s=JSON.stringify(r)),d.send(s)})).catch((e=>{throw 0!==e.code&&503!==e.code&&4e3!==e.code||(veda.trigger("offline"),browserBackend.check()),470!==e.code&&471!==e.code||veda.trigger("login:failed"),e}))}function call_server_put(e){return call_server(e).catch((t=>{if(0===t.code||503===t.code||4e3===t.code)return enqueueCall(e).then((e=>(console.log("Offline operation added to queue, queue length = ",e.length),{op_id:0,result:200})));throw t}))}browserBackend.check=function(){interval||(interval=setInterval(check,duration),arguments.length||check())},"undefined"!=typeof window&&(window.addEventListener("online",browserBackend.check),window.addEventListener("offline",browserBackend.check),veda.on("ccus-online",browserBackend.check),veda.on("ccus-offline",browserBackend.check)),browserBackend.get_rights=function(e,t){const i=e,r="object"==typeof i;return call_server({method:"GET",url:"/get_rights",ticket:r?i.ticket:e,timeout:default_timeout,data:{uri:r?i.uri:t}}).catch((e=>{if(0===e.code||503===e.code||4e3===e.code)return{"@":"_","rdf:type":[{data:"v-s:PermissionStatement",type:"Uri"}],"v-s:canCreate":[{data:!0,type:"Boolean"}],"v-s:canDelete":[{data:!1,type:"Boolean"}],"v-s:canRead":[{data:!0,type:"Boolean"}],"v-s:canUpdate":[{data:!0,type:"Boolean"}]};throw e}))},browserBackend.get_rights_origin=function(e,t){const i=e,r="object"==typeof i;return call_server({method:"GET",url:"/get_rights_origin",ticket:r?i.ticket:e,timeout:default_timeout,data:{uri:r?i.uri:t}}).catch((e=>{if(0===e.code||503===e.code||4e3===e.code)return[];throw e}))},browserBackend.get_membership=function(e,t){const i=e,r="object"==typeof i;return call_server({method:"GET",url:"/get_membership",ticket:r?i.ticket:e,timeout:default_timeout,data:{uri:r?i.uri:t}}).catch((e=>{if(0===e.code||503===e.code||4e3===e.code)return{"@":"_","rdf:type":[{data:"v-s:Membership",type:"Uri"}],"v-s:memberOf":[{data:"v-s:AllResourcesGroup",type:"Uri"}],"v-s:resource":[{data:r?i.uri:t,type:"Uri"}]};throw e}))},browserBackend.authenticate=function(e,t,i){"VedaNTLMFilter"==e&&(e="cfg:Guest");const r=e,n="object"==typeof r;return call_server({method:"GET",url:"/authenticate",timeout:default_timeout,data:{login:n?r.login:e,password:n?r.password:t,secret:n?r.secret:i}}).then((e=>({ticket:e.id,user_uri:e.user_uri,end_time:Math.floor((e.end_time-621355968e9)/1e4)})))},browserBackend.get_ticket_trusted=function(e,t){const i=e,r="object"==typeof i;return call_server({method:"GET",url:"/get_ticket_trusted",ticket:r?i.ticket:e,timeout:default_timeout,data:{login:r?i.login:t}})},browserBackend.is_ticket_valid=function(e){return call_server({method:"GET",url:"/is_ticket_valid",ticket:"object"==typeof e?e.ticket:e,timeout:default_timeout,data:{}}).catch((e=>{if(0===e.code||503===e.code||4e3===e.code)return!0;throw e}))},browserBackend.get_operation_state=function(e,t){const i=e,r="object"==typeof i;return call_server({method:"GET",url:"/get_operation_state",timeout:default_timeout,data:{module_id:r?i.module_id:e,wait_op_id:r?i.wait_op_id:t}})},browserBackend.wait_module=function(e,t){let i,r=1;for(let n=0;n<100&&(i=browserBackend.get_operation_state(e,t),!(i>=t));n++){const e=(new Date).getTime()+r;for(;(new Date).getTime()<e;);r+=2}},browserBackend.query=function(e,t,i,r,n,o,a,s,l){const d=e,c="object"==typeof d,u={method:"POST",url:"/query",ticket:c?d.ticket:e,timeout:query_timeout,data:{query:c?d.query:t,sort:c?d.sort:i,databases:c?d.databases:r,reopen:c?d.reopen:n,top:c?d.top:o,limit:c?d.limit:a,from:c?d.from:s,sql:c?d.sql:l}};return call_server(u).catch((d=>{if(999===d.code)return browserBackend.query(e,t,i,r,n,o,a,s,l);if(0===d.code||503===d.code||4e3===d.code){u.ticket=void 0;return(new LocalDB).then((e=>e.get(JSON.stringify(u))))}throw d})).then((e=>{if(e){u.ticket=void 0;(new LocalDB).then((t=>t.put(JSON.stringify(u),e)))}else e={result:[],count:0,estimated:0,processed:0,cursor:0,result_code:200};return e}))},browserBackend.get_individual=function(e,t,i){const r=e,n="object"==typeof r,o={method:"GET",url:"/get_individual",ticket:n?r.ticket:e,timeout:default_timeout,data:{uri:n?r.uri:t,reopen:(n?r.reopen:i)||!1}};if("online"===browserBackend.status||"offline"===browserBackend.status){return(new LocalDB).then((e=>e.get(o.data.uri))).then((e=>e||call_server(o).then((e=>((new LocalDB).then((t=>t.put(e["@"],e))).catch(console.log),e)))))}return browserBackend.reset_individual(e,t,i)},browserBackend.reset_individual=function(e,t,i){const r=e,n="object"==typeof r,o={method:"GET",url:"/get_individual",ticket:n?r.ticket:e,timeout:default_timeout,data:{uri:n?r.uri:t,reopen:(n?r.reopen:i)||!1}};return call_server(o).then((e=>((new LocalDB).then((t=>t.put(e["@"],e))),e))).catch((e=>{if(0===e.code||503===e.code||4e3===e.code){return(new LocalDB).then((e=>e.get(o.data.uri))).then((t=>{if(t)return t;throw e}))}throw e}))},browserBackend.get_individuals=function(e,t){const i=e,r="object"==typeof i,n={method:"POST",url:"/get_individuals",ticket:r?i.ticket:e,timeout:default_timeout,data:{uris:r?i.uris:t}};if("online"===browserBackend.status||"offline"===browserBackend.status){return(new LocalDB).then((e=>{const t=[],i=[];return n.data.uris.reduce(((r,n,o)=>r.then((()=>e.get(n).then((e=>(void 0!==e?t[o]=e:i.push(n),t))).catch((()=>(i.push(n),t)))))),Promise.resolve(t)).then((e=>i.length?(n.data.uris=i,call_server(n)):[])).then((i=>{for(let r=0,n=0,o=i.length;r<o;r++){for(;t[n++];);t[n-1]=i[r],e.put(i[r]["@"],i[r])}return t})).catch(console.log)}))}return call_server(n).then((e=>((new LocalDB).then((t=>{e.reduce(((e,i)=>{e.then((()=>t.put(i["@"],i)))}),Promise.resolve())})),e))).catch((e=>{if(0===e.code||503===e.code||4e3===e.code){return(new LocalDB).then((e=>{const t=n.data.uris.map((t=>e.get(t)));return Promise.all(t).then((e=>e.filter(Boolean)))}))}throw e}))},browserBackend.remove_individual=function(e,t,i,r,n){const o=e,a="object"==typeof o,s={method:"PUT",url:"/remove_individual",ticket:a?o.ticket:e,timeout:default_timeout,data:{uri:a?o.uri:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}};return call_server_put(s).then((()=>(new LocalDB).then((e=>e.remove(s.data.uri)))))},browserBackend.put_individual=function(e,t,i,r,n){const o=e,a="object"==typeof o,s={method:"PUT",url:"/put_individual",ticket:a?o.ticket:e,timeout:default_timeout,data:{individual:a?o.individual:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}};return call_server_put(s).then((()=>{(new LocalDB).then((e=>{e.put(s.data.individual["@"],s.data.individual)})).catch(console.log)}))},browserBackend.add_to_individual=function(e,t,i,r,n){const o=e,a="object"==typeof o;return call_server_put({method:"PUT",url:"/add_to_individual",ticket:a?o.ticket:e,timeout:default_timeout,data:{individual:a?o.individual:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})},browserBackend.set_in_individual=function(e,t,i,r,n){const o=e,a="object"==typeof o;return call_server_put({method:"PUT",url:"/set_in_individual",ticket:a?o.ticket:e,timeout:default_timeout,data:{individual:a?o.individual:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})},browserBackend.remove_from_individual=function(e,t,i,r,n){const o=e,a="object"==typeof o;return call_server_put({method:"PUT",url:"/remove_from_individual",ticket:a?o.ticket:e,timeout:default_timeout,data:{individual:a?o.individual:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}})},browserBackend.put_individuals=function(e,t,i,r,n){const o=e,a="object"==typeof o,s={method:"PUT",url:"/put_individuals",ticket:a?o.ticket:e,timeout:default_timeout,data:{individuals:a?o.individuals:t,assigned_subsystems:(a?o.assigned_subsystems:i)||0,prepare_events:!0,event_id:(a?o.event_id:r)||"",transaction_id:(a?o.transaction_id:n)||""}};return call_server_put(s).then((()=>{(new LocalDB).then((e=>{s.data.individuals.forEach((t=>{e.put(t["@"],t)}))})).catch(console.log)}))},browserBackend.uploadFile=function(e,t){return t="number"==typeof t?t:5,new Promise(((t,i)=>{const r=()=>{i(Error("File upload error"))},n=e.file,o=e.path,a=e.uri,s=e.progress,l=new XMLHttpRequest,d=new FormData;l.open("POST","/files",!0),l.timeout=6e5,l.upload.onprogress=s,l.onload=()=>{200===l.status?t(e):i(Error("File upload error"))},l.onerror=r,l.onabort=r,l.ontimeout=r,d.append("path",o),d.append("uri",a),n instanceof File?d.append("file",n):n instanceof Image&&d.append("content",n.src),l.send(d)})).catch((i=>{if(t>0)return browserBackend.uploadFile(e,--t);throw i}))};const memoize=e=>{const t={};return(...i)=>{const r=i[0];if(r in t)return t[r];{const i=e(r);return t[r]=i,i}}};function enqueueCall(e){"object"==typeof e&&(e.ticket=void 0);return(new LocalDB).then((t=>t.get("offline-queue").then((i=>((i=i||[]).push(JSON.stringify(e)),t.put("offline-queue",i))))))}function flushQueue(){return(new LocalDB).then((e=>e.get("offline-queue").then((t=>t&&t.length?veda.ticket?browserBackend.is_ticket_valid(veda.ticket).then((i=>i?t.reduce(((e,t)=>e.then((()=>((t=JSON.parse(t)).ticket=veda.ticket,call_server(t)))).catch((e=>{console.log("Offline queue operation failed:",t,e)}))),Promise.resolve()).then((()=>(e.remove("offline-queue"),t.length))):Promise.reject(Error("Ticket is not valid, skip queue flushing.")))):Promise.reject(Error("No ticket, skip queue flushing.")):0))))}browserBackend.loadFile=memoize((e=>new Promise(((t,i)=>{const r=()=>{i(Error("File load error"))},n=new XMLHttpRequest;n.open("GET",e,!0),n.timeout=6e5,n.onload=()=>{200===n.status?t(n.response):i(Error("File load error"))},n.onerror=r,n.onabort=r,n.ontimeout=r,n.send()})))),veda.on("online started",(()=>{"online"===browserBackend.status&&(console.log("Veda 'online', flushing queue"),flushQueue().then((e=>{console.log("Done, queue flushed",e)})).catch(console.log))}));var Backend=veda.Backend="server"===veda.env?serverBackend:browserBackend;const Util=veda.Util||{};var Util$1=veda.Util=Util;function zeroPref(e){return e>9?String(e):"0"+e}function formatString(e){return!e.language||"NONE"===e.language||veda.user&&veda.user.preferences&&veda.user.preferences.language&&e.language in veda.user.preferences.language?e:void 0}function formatDate(e){const t=e.getDate(),i=e.getMonth()+1,r=e.getFullYear(),n=e.getHours(),o=e.getMinutes(),a=e.getSeconds();if(e.getUTCHours()+e.getUTCMinutes()+e.getUTCSeconds()===0)return[zeroPref(t),zeroPref(i),r].join(".");const s=[zeroPref(t),zeroPref(i),r].join("."),l=[zeroPref(n),zeroPref(o),zeroPref(a)].join(":");return("01.01.1970"===s?"":s)+("00:00:00"===l?"":" "+(0===a?l.substr(0,5):l))}function formatNumber(e){return(e+"").replace(/.(?=(?:[0-9]{3})+\b)/g,"$& ")}function flattenIndividual(e,t,i,r){const n=e["@"];if(i=void 0!==i?i:{},t=void 0!==t?t:"",!((r=void 0!==r?r:[]).indexOf(n)>-1)){r.push(n);for(const n in e){if("@"===n)continue;const o=e[n],a=t?t+"."+n:n;for(let e=0;e<o.length;e++){const t=o[e];if("Uri"===t.type){const e=new IndividualModel(t.data);e.isNew()?flattenIndividual(e.properties,a,i,r):(i[a]=i[a]?i[a]:[],i[a].push(t))}else i[a]=i[a]?i[a]:[],i[a].push(t)}}return i}}Util.mergeMutualChanges=function(e,t,i){let r;const n={};for(r in i)Object.hasOwnProperty.call(i,r)&&(n[r]=i[r]);const o=Util.diff(e,i),a=Util.diff(t,i),s=Util.diff(e,t),l=Util.diff(t,e);for(r in a.missing)Object.hasOwnProperty.call(a.missing,r)&&delete n[r];for(r in o.missing)Object.hasOwnProperty.call(o.missing,r)&&delete n[r];for(r in a.added)Object.hasOwnProperty.call(a.added,r)&&(n[r]=a.added[r]);for(r in o.added)Object.hasOwnProperty.call(o.added,r)&&(n[r]=o.added[r]);for(r in a.differ)Object.hasOwnProperty.call(a.differ,r)&&(n[r]=a.differ[r]);for(r in o.diff)Object.hasOwnProperty.call(o.diff,r)&&(n[r]=o.differ[r]);return{merged:n,conflicts:{high:s.differ,low:l.differ}}},Util.diff=function(e,t){const i={added:{},missing:{},differ:{}};let r,n,o,a,s,l;for(r in t)if(r in e){if("@"===r){e[r]!==t[r]&&(i.differ[r]=e[r]);continue}for(n=t[r],a=n.length,l=a===e[r].length,s=0;s<a&&l;s++)o=n[s],l=l&&Util.hasValue(e,r,o);l||(i.differ[r]=e[r])}else i.missing[r]=t[r];for(r in e)r in t||(i.added[r]=e[r]);return i},Util.decimalDatetimeReviver=function(e,t){return"data"===e&&"Datetime"===this.type?new Date(t):"data"===e&&"Decimal"===this.type?parseFloat(t):t},Util.hasValue=function(e,t,i){const r=!!(e&&e[t]&&e[t].length);return i?!(!r||!e[t].filter((e=>e.type===i.type&&e.data.valueOf()===i.data.valueOf())).length):r},Util.toJson=function(e){return JSON.stringify(e,null,2)},Util.simpleHash=function(e){let t,i=0;if(0===e.length)return i;for(let r=0;r<e.length;r++)t=e.charCodeAt(r),i=(i<<5)-i+t,i&=i;return i},Util.processQuery=function(e,t,i,r,n,o,a,s){const l=function(f){const p=f||0;Backend.query({ticket:veda.ticket,query:e,sql:t,sort:i||"'v-s:created' desc",from:p,top:n,limit:r}).then((e=>{const t=e.cursor,i=e.estimated;r>i&&(r=i),c.apply(d,e.result),t/r-u>=.05&&(u=t/r,console.log("Fetching progress:",Math.floor(100*u)+"%","("+t,"of",r+")")),t===i||t>=r?(console.log((new Date).toString(),"Fetching done:",r),console.timeEnd("Fetching total"),d.splice(r-t||r),Util.processResult(d,o,a,s)):l(e.cursor)}))};"object"==typeof e&&(i=e.sort,r=e.limit,n=e.queryDelta,o=e.processDelta,a=e.pause,s=e.fn,t=e.sql,e=e.vql),console.log((new Date).toISOString(),"Process query results |||","query:",e||t," | ","limit:",r," | ","query delta:",n," | ","process delta:",o," | ","pause:",a);const d=[],c=[].push;let u=0;console.time("Fetching total"),l()},Util.processResult=function(e,t,i,r){const n=function(){e.splice(0,t).reduce(((e,t)=>e.then((()=>r(t))).catch((e=>{console.log("Error processing item:",t),console.log(e,e.stack)}))),Promise.resolve()).then((()=>{(o-e.length)/o-a>=.05&&(a=(o-e.length)/o,console.log("Processing progress:",Math.floor(100*a)+"%","("+(o-e.length),"of",o+")")),e.length?setTimeout?setTimeout(n,i):n():(console.log("Processing done:",o),console.timeEnd("Processing total"))}))},o=e.length;let a=0;console.log((new Date).toISOString(),"Process results |||","total:",o," | ","delta:",t," | ","pause:",i),console.time("Processing total"),n()},Util.genUri=function(){const e=Util.guid();return/^\d/.test(e)?"d:a"+e:"d:"+e},Util.guid=function(){let e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/x/g,(function(t){const i=(e+36*Math.random())%36|0;return e=Math.floor(e/36),i.toString(36)}))},Util.isInteger=function(e){return e%1==0},Util.formatValue=function(e){let t;switch(!0){case e instanceof Date:t=formatDate(e);break;case e instanceof Number||"number"==typeof e:t=formatNumber(e);break;case e instanceof String||"string"==typeof e:t=formatString(e);break;default:t=void 0!==e?e.toString():e}return t},Util.forSubIndividual=function(e,t,i,r){void 0!==e[t]&&e[t].forEach((e=>{e.id==i&&r(e)}))},Util.removeSubIndividual=function(e,t,i){if(void 0!==e[t])return e[t].filter((e=>e.id!==i))},Util.flatten=function(e,t){const i=Object.prototype.toString,r=[],n=t&&e||e.slice();let o;if(!e.length)return r;o=n.pop();do{"[object Array]"===i.call(o)?n.push(...o):r.push(o)}while(n.length&&void 0!==(o=n.pop()));return r.reverse(),r},Util.unique=function(e){const t={},i=[];for(let r=0;r<e.length;r++)t[e[r]]||(t[e[r]]=!0,i.push(e[r]));return i},Number.isFinite=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&Number.isFinite(e)&&!(e%1)},Number.isFloat=Number.isFloat||function(e){return"number"==typeof e&&Number.isFinite(e)&&e%1},Util.queryFromIndividualPT=function(e,t){const i=function(e){const t=[];let i=-1;const r=Object.keys(e.properties).map((r=>{if(r.indexOf(".")>=0||r.indexOf("*")>=0)throw new Error("VQL style property nesting: "+r);if("@"===r)return;i++;const n="veda_pt.`"+r+"` as p"+i;t[i]=n;const o=e.get(r).sort(((e,t)=>e<t?-1:e===t?0:1));let a;switch(!0){case Number.isInteger(o[0]):a="p"+i+".int[1] >= "+o[0]+" AND p"+i+".int[1] <= "+o[o.length-1];break;case Number.isFloat(o[0]):a="p"+i+".dec[1] >= "+o[0]+" AND p"+i+".dec[1] <= "+o[o.length-1];break;case o[0]instanceof Date:let e=new Date(o[0]),t=new Date(o[o.length-1]);e.setHours(0,0,0,0),t.setHours(23,59,59,999),e=Math.floor(e.valueOf()/1e3),t=Math.floor(t.valueOf()/1e3),a="p"+i+".date[1] >= toDateTime("+e+") AND p"+i+".date[1] <= toDateTime("+t+")";break;case"boolean"==typeof o[0]:a=o.map((e=>"p"+i+".int[1] = "+(e?1:0))).join(" OR ");break;case o[0]instanceof String:a=o.filter(Boolean).map((e=>e.trim().split("\n").map((e=>{const t=e.trim().replace(/[-*\s]+/g," ").split(" ");return t.length&&"arrayStringConcat(p"+i+".str, ' ') LIKE '%"+t.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case o[0]instanceof IndividualModel:a=o.filter(Boolean).map((e=>e.isNew()?void 0:"has(p"+i+".str, '"+e.id+"')")).filter(Boolean).join(" OR ")}return a?a.indexOf(" OR ")>0?"( "+a+" )":a:void 0})).filter(Boolean).join(" AND ");return"SELECT DISTINCT id FROM "+t.reduce(((e,t,i)=>e?e+" JOIN "+t+" ON p"+(i-1)+".id = p"+i+".id":t),"")+(r?" WHERE "+r:"")},r=/[^a-zA-Z0-9]/g;try{let e=i;const n=function(e){if("string"==typeof e||e instanceof String)return e.replace(/'(.+?)'\s+(\w+)/gi,(function(e,t,i){const n=veda.ontology.properties[t].get("rdfs:range")[0],o=t.replace(r,"_");let a;switch(n.id){case"xsd:dateTime":a=o+".date "+i;break;case"xsd:boolean":case"xsd:integer":a=o+".int "+i;break;case"xsd:decimal":a=o+".dec "+i;break;case"xsd:string":default:a=o+".str "+i}return a}))}(t);return e=e&&n?e+" ORDER BY "+n:e,e}catch(e){console.log(e)}},Util.queryFromIndividualTT_SUB=function(e,t,i){const r=function(e){if(e.id in visited)return;visited[e.id]=!0;let t=Object.keys(e.properties).map(((t,i)=>{if(t.indexOf(".")>=0||t.indexOf("*")>=0)throw new Error("VQL style property nesting: "+t);if("@"===t||"rdf:type"===t)return;const n=e.get(t).sort(((e,t)=>e<t?-1:e===t?0:1)),o=t.replace(re,"_");let a;switch(!0){case Number.isInteger(n[0]):a=o+"_int[1] >= "+n[0]+" AND "+o+"_int[1] <= "+n[n.length-1];break;case Number.isFloat(n[0]):a=o+"_dec[1] >= "+n[0]+" AND "+o+"_dec[1] <= "+n[n.length-1];break;case n[0]instanceof Date:let e=new Date(n[0]),t=new Date(n[n.length-1]);e.setHours(0,0,0,0),t.setHours(23,59,59,999),e=Math.floor(e.valueOf()/1e3),t=Math.floor(t.valueOf()/1e3),a=o+"_date[1] >= toDateTime("+e+") AND "+o+"_date[1] <= toDateTime("+t+")";break;case"boolean"==typeof n[0]:a=n.map((e=>o+"_int[1] = "+(e?1:0))).join(" OR ");break;case n[0]instanceof String:a=n.filter(Boolean).map((e=>e.trim().split("\n").map((e=>{const t=e.trim().replace(/[-*\s]+/g," ").split(" ");return/\.\*$/.test(o)&&(o=o.replace("*","text")),/\.text$/.test(o)?t.length&&o+" LIKE '%"+t.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'":t.length&&"lowerUTF8(arrayStringConcat("+o+"_str, ' ')) LIKE lowerUTF8('%"+t.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%')"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case n[0]instanceof IndividualModel:a=n.filter(Boolean).map((e=>{if(e.isNew()){const t=r(e);return t?o+"_str IN ( "+t+" )":void 0}return"has("+o+"_str, '"+e+"')"})).filter(Boolean).join(" OR ")}return a?a.indexOf(" OR ")>0?"( "+a+" )":a:void 0})).filter(Boolean).join(" AND ");return i||(t+=t?" AND ":"",t+="NOT v_s_deleted_int = [1]"),Object.keys(visited).length>1&&!t?void 0:e.get("rdf:type").map((e=>"SELECT id FROM "+("veda_tt.`"+e.id+"`")+(t?" WHERE "+t:""))).filter(Boolean).join(" UNION ALL ")};try{let i=r(e);const n=function(e){let t;return("string"==typeof e||e instanceof String)&&(t=e.replace(/'(.+?)'\s+(\w+)/gi,(function(e,t){const i=veda.ontology.properties[t].get("rdfs:range")[0];let r=t.replace(re,"_");switch(i.id){case"xsd:dateTime":r+="_date";break;case"xsd:boolean":case"xsd:integer":r+="_int";break;case"xsd:decimal":r+="_dec";break;case"xsd:string":default:r+="_str"}return r}))),t?"id, "+t:"id"}(t);i=i&&n?i+" GROUP BY "+n:i;const o=function(e){if("string"==typeof e||e instanceof String)return e.replace(/'(.+?)'\s+(\w+)/gi,(function(e,t,i){const r=veda.ontology.properties[t].get("rdfs:range")[0],n=t.replace(re,"_");let o;switch(r.id){case"xsd:dateTime":o=n+"_date "+i;break;case"xsd:boolean":case"xsd:integer":o=n+"_int "+i;break;case"xsd:decimal":o=n+"_dec "+i;break;case"xsd:string":default:o=n+"_str "+i}return o}))}(t);return i=i?i+" HAVING sum(sign) > 0":i,i=i&&o?i+" ORDER BY "+o:i,i}catch(e){console.log(e)}},Util.queryFromIndividualTT_JOIN=function(e,t,i){let r=0;const n=/[^a-zA-Z0-9]/g;try{return e["rdf:type"].map(((o,a)=>{let s="",l="";const d=d||{};!function e(t,o,a){if(!t.hasValue("rdf:type"))return;r++,a=a||0;const c=t.get("rdf:type")[a].id,u="t"+r;d[t.id]=u;const f="veda_tt.`"+c+"` AS "+u;s+=o?" JOIN "+f+" ON "+o+" = ["+u+".id]":f;i||(l+=l?" AND ":"",l+="NOT "+u+".v_s_deleted_int = [1]");const p=Object.keys(t.properties).map(((i,r)=>{if(i.indexOf(".")>=0||i.indexOf("*")>=0)throw new Error("VQL style property nesting: "+i);if("@"===i||"rdf:type"===i)return;const o=t.get(i).sort(((e,t)=>e<t?-1:e===t?0:1)),a=u+"."+i.replace(n,"_");let s;switch(!0){case Number.isInteger(o[0]):s=a+"_int[1] >= "+o[0]+" AND "+a+"_int[1] <= "+o[o.length-1];break;case Number.isFloat(o[0]):s=a+"_dec[1] >= "+o[0]+" AND "+a+"_dec[1] <= "+o[o.length-1];break;case o[0]instanceof Date:let t=new Date(o[0]),i=new Date(o[o.length-1]);t.setHours(0,0,0,0),i.setHours(23,59,59,999),t=Math.floor(t.valueOf()/1e3),i=Math.floor(i.valueOf()/1e3),s=a+"_date[1] >= toDateTime("+t+") AND "+a+"_date[1] <= toDateTime("+i+")";break;case"boolean"==typeof o[0]:s=o.map((e=>a+"_int[1] = "+(e?1:0))).join(" OR ");break;case o[0]instanceof String:s=o.filter(Boolean).map((e=>e.trim().split("\n").map((e=>{const t=e.trim().replace(/[-*\s]+/g," ").split(" ");return/\.\*$/.test(a)&&(a=a.replace("*","text")),/\.text$/.test(a)?t.length&&a+" LIKE '%"+t.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%'":t.length&&"lowerUTF8(arrayStringConcat("+a+"_str, ' ')) LIKE lowerUTF8('%"+t.join("% %").replace(/\'/g,"\\'").replace(/\"/g,"'")+"%')"})).filter(Boolean).join(" OR "))).filter(Boolean).join(" OR ");break;case o[0]instanceof IndividualModel:s=o.filter(Boolean).map((t=>t.isNew()&&!(t.id in d)?e(t,a+"_str"):t.isNew()&&t.id in d?"has("+a+"_str, "+d[t.id]+".id)":"has("+a+"_str, '"+t+"')")).filter(Boolean).join(" OR ")}return s?s.indexOf(" OR ")>0?"( "+s+" )":s:void 0})).filter(Boolean).join(" AND ");if(!p)return;l?l+=" AND "+p:l=p}(e,void 0,a);let c=s?"SELECT id FROM "+s:"";c=c&&l?c+" WHERE "+l:c;const u=function(e){let t;("string"==typeof e||e instanceof String)&&(t=e.replace(/'(.+?)'\s+(\w+)/gi,(function(e,t){const i=veda.ontology.properties[t].get("rdfs:range")[0];let r=t.replace(n,"_");switch(i.id){case"xsd:dateTime":r+="_date";break;case"xsd:boolean":case"xsd:integer":r+="_int";break;case"xsd:decimal":r+="_dec";break;case"xsd:string":default:r+="_str"}return r})));return t?"id, "+t:"id"}(t);c=c&&u?c+" GROUP BY "+u:c;const f=function(e){if("string"==typeof e||e instanceof String)return e.replace(/'(.+?)'\s+(\w+)/gi,(function(e,t,i){const r=veda.ontology.properties[t].get("rdfs:range")[0],o=t.replace(n,"_");let a;switch(r.id){case"xsd:dateTime":a=o+"_date "+i;break;case"xsd:boolean":case"xsd:integer":a=o+"_int "+i;break;case"xsd:decimal":a=o+"_dec "+i;break;case"xsd:string":default:a=o+"_str "+i}return a}))}(t);return c=c?c+" HAVING sum(sign) > 0":c,c=c&&f?c+" ORDER BY "+f:c,c})).join(" UNION ALL ")}catch(e){console.log(e)}},Util.queryFromIndividual=function(e){const t=flattenIndividual(e.properties);if(e.hasValue("*")&&e.get("*")[0].indexOf("==")>0)return e.get("*")[0];const i=Object.getOwnPropertyNames(t).map((e=>{if("@"===e||"v-s:isDraft"===e)return;const i=t[e].sort(((e,t)=>e.data<t.data?-1:e.data===t.data?0:1));let r;switch(i[0].type){case"Integer":case"Decimal":r="'"+e+"'==["+i[0].data+","+i[i.length-1].data+"]";break;case"Datetime":const t=new Date(i[0].data),n=new Date(i[i.length-1].data);t.setHours(0,0,0,0),n.setHours(23,59,59,999),r="'"+e+"'==["+t.toISOString()+","+n.toISOString()+"]";break;case"Boolean":r=i.map((t=>"'"+e+"'=='"+t.data+"'")).join(" || ");break;case"String":r=i.filter((e=>!!e&&!!e.valueOf())).map((t=>{const i=t.data;if(i.match(/[\+\-\*]/))return"'"+e+"'=='"+i+"'";return i.trim().split("\n").map((t=>{const i=t.trim().replace(/[-*\s]+/g," ").split(" ");return t=i.map((e=>"+"+e+"*")).join(" "),"'"+e+"'=='"+t+"'"})).join(" || ")})).join(" || ");break;case"Uri":r=i.filter((e=>!!e&&!!e.valueOf())).map((t=>"'"+e+"'=='"+t.data+"'")).join(" || ")}return r?"( "+r+" )":void 0})).filter((e=>void 0!==e)).join(" && ");return i?"( "+i+" )":void 0},Util.complexLabel=function(e){e=e.properties||e;const t={};t[e["@"]]=e;const i=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.*Z$/i,r=function(e){return t[e]?t[e]:t[e]=get_individual(veda.ticket,e)},n=function(e,t,...n){const o=r(t);if(!o)return"";let a=[o];for(let t,o=0;t=n[o];o++){if(o===n.length-1){const r=[];return a.forEach((n=>{if(n[t]){const o=n[t].reduce(((t,r)=>{if(r.lang&&"NONE"!==r.lang&&r.lang.toLowerCase()!==e.toLowerCase())return t;{let e=r.data;return(e instanceof Date||i.test(e))&&(e=new Date(e),e=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().substr(0,10)),t+e}}),"");r.push(o)}})),r.join(", ")}const s=[];if(a.forEach((e=>{Util.hasValue(e,t)&&e[t].forEach((e=>{s.push(r(e.data))}))})),!s.length)return"";a=s}return""};try{const t=r("v-ui:AvailableLanguage")["rdf:value"].map((e=>{const t=e.data;return r(t)["rdf:value"][0].data}));return e["rdf:type"].reduce(((i,o)=>{const a=o.data,s=r(a);if(!s||!Util.hasValue(s,"v-s:labelPattern"))return i;const l=s["v-s:labelPattern"][0].data;return t.forEach((t=>{const r={data:l.replace(/{(\s*([^{}]+)\s*)}/g,(function(i,r){let o=null;if(-1!=r.indexOf(" ")){const e=r.split(" ");r=e[0],o=e[1].substring(1,e[1].length-1).split(",")}const a=r.split(".");"@"===a[0]&&(a[0]=e["@"]);const s=n.apply({},[t].concat(a));return null==o?s:s.substring(+o[0],+o[1])})),lang:t,type:"String"};i.push(r)})),i}),[])}catch(e){return console.log("Complex label error",e,e.stack),[]}},Util.areEqual=function(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const i in e)if(e.hasOwnProperty(i)){if(!t.hasOwnProperty(i))return!1;if(e[i]!==t[i]){if("object"!=typeof e[i])return!1;if(!Util.areEqual(e[i],t[i]))return!1}}for(const i in t)if(t.hasOwnProperty(i)&&!e.hasOwnProperty(i))return!1;return!0};var IndividualModel=veda.IndividualModel=IndividualModel$1;function IndividualModel$1(e,t,i){if("object"!=typeof e||e["@"]||(t=e.cache,i=e.init,e=e.uri),this._={cache:"boolean"==typeof t?t:t||!0,init:void 0===i||i,isNew:void 0===e,isSync:"object"==typeof e,isLoaded:"object"==typeof e,isInited:!1,pending:{},uri:e},"object"==typeof e?(this.properties=e,this.original=JSON.stringify(e)):this.properties={},this._.cache){let t;if("string"==typeof e?(this.id=e,t=veda.cache.get(this.id)):"object"==typeof e?(t=veda.cache.get(this.id),t&&!t.isLoaded()&&(t.properties=e)):void 0===e&&(this.id=Util$1.genUri()),t)return t;veda.cache.set(this,this._.cache)}return riot.observable(this),this.on("rdf:type",this.init),this.on("beforeSave",beforeSaveHandler),this}function beforeSaveHandler(){const e=new Date,t=veda.appointment?veda.appointment:veda.user;this.hasValue("v-s:creator")||this.set("v-s:creator",[t]),this.hasValue("v-s:created")||this.set("v-s:created",[e]),"cfg:Administrator"!==veda.user.id&&(!this.hasValue("v-s:lastEditor")||!this.hasValue("v-s:edited")||this.get("v-s:lastEditor")[0].id!==t.id||e-this.get("v-s:edited")[0]>1e3)&&(this.set("v-s:edited",[e]),this.set("v-s:lastEditor",[t]))}const proto$1=IndividualModel$1.prototype;function unique(e){const t={},i=[];for(let r,n=0;n<e.length;n++)r=e[n].type+e[n].data+(e[n].lang||""),t[r]||(t[r]=!0,i.push(e[n]));return i}function parser(e){if("String"===e.type&&e.data){const t=new String(e.data);return e.lang&&"NONE"!==e.lang&&(t.language=e.lang),t}return"Uri"===e.type?new IndividualModel$1(e.data):"Datetime"===e.type?new Date(Date.parse(e.data)):"Decimal"===e.type?parseFloat(e.data):"Integer"===e.type?parseInt(e.data):"Boolean"===e.type?Boolean(e.data):void 0}proto$1.get=function(e){return this.properties[e]?this.properties[e].map(parser).filter((e=>void 0!==e)):[]},proto$1.set=function(e,t,i){this.isSync(!1),Array.isArray(t)||(t=[t]);const r=unique(t.map(serializer).filter(Boolean));return JSON.stringify(r)===JSON.stringify(this.properties[e]||[])||(r.length?this.properties[e]=r:delete this.properties[e],i)?Promise.resolve(this):(t=this.get(e),this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t))))},IndividualModel$1.defineProperty=function(e){Object.defineProperty(proto$1,e,{get:function(){return this.get(e)},set:function(t){return this.set(e,t)},configurable:!1,enumerable:!1})};const reg_uri=/^[a-z][a-z-0-9]*:([a-zA-Z0-9-_])*$/,reg_date=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/,reg_ml_string=/^(.*)@([a-z]{2})$/ims;function serializer(e){if("number"==typeof e)return{type:Util$1.isInteger(e)?"Integer":"Decimal",data:e};if("boolean"==typeof e)return{type:"Boolean",data:e};if(e instanceof Date)return{type:"Datetime",data:e.toISOString().split(".")[0]+"Z"};if(e instanceof IndividualModel$1)return{type:"Uri",data:e.id};if("string"==typeof e||e instanceof String){if(reg_uri.test(e))return{type:"Uri",data:e.valueOf()};if(reg_date.test(e))return{type:"Datetime",data:e.valueOf()};if(reg_ml_string.test(e))return{type:"String",data:e.replace(reg_ml_string,"$1"),lang:e.replace(reg_ml_string,"$2").toUpperCase()};if(e.length)return{type:"String",data:e.valueOf(),lang:e.language||"NONE"}}}function addSingleValue(e,t){if(null!=t){const i=serializer(t);this.properties[e].push(i)}}function removeSingleValue(e,t){if(null!=t){const i=serializer(t);this.properties[e]=(this.properties[e]||[]).filter((e=>!!(e.data!=i.data||e.lang&&i.lang&&e.lang!==i.lang)))}}function toggleSingleValue(e,t){null!=t&&(this.hasValue(e,t)?removeSingleValue.call(this,e,t):addSingleValue.call(this,e,t))}function prefetch(e,t,i,...r){const n=(i=Util$1.unique(i)).filter((t=>{const i=veda.cache.get(t);return i&&e.indexOf(i)<0&&e.push(i),!i}));return(n.length?Backend.get_individuals(veda.ticket,n):Promise.resolve([])).then((n=>{const o=[];return n.forEach((t=>{if(t){const i=new IndividualModel$1(t);e.indexOf(i)<0&&e.push(i)}})),t-1==0?e:(i.forEach((e=>{const t=new IndividualModel$1(e).properties;Object.keys(t).forEach((e=>{"@"===e||r.length&&r.indexOf(e)<0||t[e].forEach((e=>{"Uri"===e.type&&o.push(e.data)}))}))})),o.length?prefetch.apply(this,[e,t-1,o].concat(r)):e)}))}Object.defineProperty(proto$1,"id",{get:function(){return this.properties["@"]},set:function(e){const t=this.properties&&this.properties["@"];this.properties["@"]=e,t&&this._.cache&&veda.cache.get(t)&&(veda.cache.remove(t),veda.cache.set(this,this._.cache))}}),Object.defineProperty(proto$1,"membership",{get:function(){return this.isNew()?(this._.membership=new IndividualModel$1({cache:!1}),Promise.resolve(this._.membership)):Backend.get_membership(veda.ticket,this.id).then((e=>this._.membership=new IndividualModel$1({uri:e,cache:!1}))).catch((e=>(console.log("membership error",this.id,e),this._.membership=new IndividualModel$1({cache:!1}))))},configurable:!1,enumerable:!1}),proto$1.memberOf=function(){return this.membership.then((e=>e.hasValue("v-s:memberOf")?e.properties["v-s:memberOf"].map((e=>e.data)):[]))},proto$1.isMemberOf=function(e){return this.membership.then((t=>t.hasValue("v-s:memberOf",e)))},Object.defineProperty(proto$1,"rights",{get:function(){return this.isNew()?(this._.rights=new IndividualModel$1({cache:!1}),this._.rights["v-s:canCreate"]=[!0],this._.rights["v-s:canRead"]=[!0],this._.rights["v-s:canUpdate"]=[!0],this._.rights["v-s:canDelete"]=[!0],Promise.resolve(this._.rights)):Backend.get_rights(veda.ticket,this.id).then((e=>this._.rights=new IndividualModel$1(e,!1))).catch((e=>(console.log("rights error",this.id,e),this._.rights=new IndividualModel$1({cache:!1}))))},configurable:!1,enumerable:!1}),proto$1.can=function(e){return e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),this.rights.then((t=>t.hasValue("v-s:can"+e,!0)))},proto$1.canCreate=function(){return this.can("Create")},proto$1.canRead=function(){return this.can("Read")},proto$1.canUpdate=function(){return this.can("Update")},proto$1.canDelete=function(){return this.can("Delete")},Object.defineProperty(proto$1,"rightsOrigin",{get:function(){return Backend.get_rights_origin(veda.ticket,this.id).then((e=>this._.rightsOrigin=Promise.all(e.map((e=>new IndividualModel$1(e,!1)))))).catch((e=>(console.log("rights error",this.id,e),this._.rightsOrigin=[])))},configurable:!1,enumerable:!1}),proto$1.load=function(){return this.isLoading()&&"undefined"!=typeof window?this.isLoading():this.isLoading(this.trigger("beforeLoad").then((()=>{if(this.isLoaded()&&("online"===Backend.status||"offline"===Backend.status))return this;if(this.isLoaded()&&"limited"===Backend.status)return this.reset();{const e=this._.uri;if("string"==typeof e)return Backend.get_individual(veda.ticket,e).then((e=>{this.isNew(!1),this.isSync(!0),this.isLoaded(!0),this.properties=e,this.original=JSON.stringify(e)}));"object"==typeof e?(this.isNew(!1),this.isSync(!0),this.isLoaded(!0),this.properties=e):void 0===e&&(this.isNew(!0),this.isSync(!1),this.isLoaded(!1))}})).then((()=>this.init())).then((()=>this.trigger("afterLoad"))).then((()=>(this.isLoading(!1),this))).catch((e=>{throw console.log("load individual error",this.id,e.stack),this.isLoading(!1),e})))},proto$1.save=function(e){return null==e&&(e=!0),this.isSync()?Promise.resolve(this):this.isSaving()&&this.isSync()&&"undefined"!=typeof window?this.isSaving():this.isSaving(this.trigger("beforeSave").then((()=>{Object.keys(this.properties).reduce(((e,t)=>("@"===t||e[t].length||delete e[t],e)),this.properties);const t=this.original?JSON.parse(this.original):{"@":this.id},i=Util$1.diff(this.properties,t);return(this.isNew()||e?Backend.put_individual(veda.ticket,this.properties):Promise.all([i.added&&Object.keys(i.added).length?(i.added["@"]=this.id,Backend.add_to_individual(veda.ticket,i.added)):void 0,i.differ&&Object.keys(i.differ).length?(i.differ["@"]=this.id,Backend.set_in_individual(veda.ticket,i.differ)):void 0,i.missing&&Object.keys(i.missing).length?(i.missing["@"]=this.id,Backend.remove_from_individual(veda.ticket,i.missing)):void 0])).then((()=>{this.original=JSON.stringify(this.properties),this.isNew(!1),this.isSync(!0),this.isLoaded(!0)}))})).then((()=>this.trigger("afterSave"))).then((()=>(this.isSaving(!1),this))).catch((e=>{throw console.log("save individual error",this.id,e),this.isSaving(!1),e})))},proto$1.reset=function(e){if(this.isResetting()&&"undefined"!=typeof window)return this.isResetting();const t=t=>{this.original=JSON.stringify(t);const i=Util$1.diff(this.properties,t);return e||this.isSync()||!this.isLoaded()?(this.properties=t,this.isNew(!1),this.isSync(!0),this.isLoaded(!0),Promise.all(Object.keys(i.added).concat(Object.keys(i.differ),Object.keys(i.missing)).map((e=>{const t=this.get(e);return this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t)))})))):Promise.all(Object.keys(i.missing).map((e=>this.set(e,t[e].map(parser))))).then((()=>Promise.all(Object.keys(i.differ).map((e=>{const i=t[e].map(parser).filter((t=>!this.hasValue(e,t)&&t instanceof IndividualModel$1));return this.addValue(e,i)})))))};return this.isResetting(this.trigger("beforeReset").then((()=>this.isNew()?null:Backend.reset_individual(veda.ticket,this.id).then(t))).then((()=>this.trigger("afterReset"))).then((()=>(this.isResetting(!1),this))).catch((e=>{throw console.log("reset individual error",this.id,e.stack),this.isResetting(!1),e})))},proto$1.delete=function(){return this.isDeleting()&&"undefined"!=typeof window?this.isDeleting():this.isDeleting(this.trigger("beforeDelete").then((()=>{if(!this.isNew())return this["v-s:deleted"]=[!0],this.addValue("rdf:type","v-s:Deletable"),this.save()})).then((()=>this.trigger("afterDelete"))).then((()=>(this.isDeleting(!1),this))).catch((e=>{throw console.log("delete individual error",this.id,e),this.isDeleting(!1),e})))},proto$1.remove=function(){return this.isRemoving()&&"undefined"!=typeof window?this.isRemoving():this.isRemoving(this.trigger("beforeRemove").then((()=>{if(this._.cache&&veda.cache&&veda.cache.get(this.id)&&veda.cache.remove(this.id),!this.isNew())return Backend.remove_individual(veda.ticket,this.id)})).then((()=>this.trigger("afterRemove"))).then((()=>(this.isRemoving(!1),this))).catch((e=>{throw console.log("remove individual error",this.id,e),this.isRemoving(!1),e})))},proto$1.recover=function(){return this.isRecovering()&&"undefined"!=typeof window?this.isRecovering():this.isRecovering(this.trigger("beforeRecover").then((()=>(this["v-s:deleted"]=[!1],this.save()))).then((()=>this.trigger("afterRecover"))).then((()=>(this.isRecovering(!1),this))).catch((e=>{throw console.log("recover individual error",this.id,e),this.isRecovering(!1),e})))},proto$1.hasValue=function(e,t){if(!e&&null!=t){let e=!1;for(const i in this.properties)"@"!==i&&(e=e||this.hasValue(i,t));return e}let i=!(!this.properties[e]||!this.properties[e].length);if(null!=t){const r=serializer(t);i=i&&!!this.properties[e].filter((e=>!(e.type!==r.type||e.data!==r.data||e.lang&&r.lang&&e.lang!==r.lang))).length}return i},proto$1.addValue=function(e,t,i){return null==t?Promise.resolve(this):(this.properties[e]=this.properties[e]||[],Array.isArray(t)?t.forEach((t=>addSingleValue.call(this,e,t))):addSingleValue.call(this,e,t),this.isSync(!1),i?Promise.resolve(this):(t=this.get(e),this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t)))))},proto$1.removeValue=function(e,t,i){return this.properties[e]&&this.properties[e].length&&null!=t?(Array.isArray(t)?t.forEach((t=>removeSingleValue.call(this,e,t))):removeSingleValue.call(this,e,t),this.isSync(!1),i?Promise.resolve(this):(t=this.get(e),this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t))))):Promise.resolve(this)},proto$1.toggleValue=function(e,t,i){return null==t?Promise.resolve(this):(this.properties[e]=this.properties[e]||[],Array.isArray(t)?t.forEach((t=>toggleSingleValue.call(this,e,t))):toggleSingleValue.call(this,e,t),this.isSync(!1),i?Promise.resolve(this):(t=this.get(e),this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t)))))},proto$1.clearValue=function(e,t){if(!this.properties[e]||!this.properties[e].length)return Promise.resolve(this);if(delete this.properties[e],this.isSync(!1),!t){const t=[];return this.trigger("propertyModified",e,t).then((()=>this.trigger(e,t)))}return Promise.resolve(this)},proto$1.is=function(e){const t=function(i){if(r)return r;if(i.hasValue("rdfs:subClassOf")){if(i.hasValue("rdfs:subClassOf",e.id))return r=r||!0;{const e=i.get("rdfs:subClassOf");return Promise.all(e.map(t)).then((e=>e.reduce(((e,t)=>e||t),!1)))}}return r=r||!1};"string"==typeof e.valueOf()&&(e=new IndividualModel$1(e.valueOf()));const i=this.get("rdf:type");let r=i.reduce(((t,i)=>t||this.hasValue("rdf:type",e.id)),!1);return r?Promise.resolve(r):Promise.all(i.map(t)).then((e=>e.reduce(((e,t)=>e||t),!1)))},proto$1.init=function(e){if(!e&&(this.isInited()||!this._.init))return Promise.resolve(this);const t=this.hasValue("rdf:type","owl:Class")||this.hasValue("rdf:type","rdfs:Class");if(this.hasValue("v-ui:hasModel")&&!t)return this.get("v-ui:hasModel")[0].load().then((e=>(e.modelFn||(e.modelFn=new Function("veda",e["v-s:script"][0])),e.modelFn.call(this,veda),this.isInited(!0),this)));{const e=this.get("rdf:type").map((e=>e.load()));return Promise.all(e).then((e=>{const t=[];return e.map((e=>{e.hasValue("v-ui:hasModel")&&t.push(e.get("v-ui:hasModel")[0].load())})),Promise.all(t)})).then((e=>(e.map((e=>{e.modelFn||(e.modelFn=new Function("veda",e.get("v-s:script")[0])),e.modelFn.call(this,veda)})),this.isInited(!0),this)))}},proto$1.clone=function(){const e=JSON.parse(JSON.stringify(this.properties));e["@"]=Util$1.genUri();const t=new IndividualModel$1(e);return t.isNew(!0),t.isSync(!1),t.clearValue("v-s:updateCounter"),t.init()},proto$1.isInited=function(e){return void 0!==e?this._.isInited=e:this._.isInited},proto$1.isSync=function(e){return void 0!==e?this._.isSync=e:this._.isSync},proto$1.isNew=function(e){return void 0!==e?this._.isNew=e:this._.isNew},proto$1.isLoaded=function(e){return void 0!==e?this._.isLoaded=e:this._.isLoaded},proto$1.isPending=function(e,t){return void 0!==t?this._.pending[e]=t:this._.pending[e]},proto$1.isLoading=function(e){return this.isPending("load",e)},proto$1.isSaving=function(e){return this.isPending("save",e)},proto$1.isResetting=function(e){return this.isPending("reset",e)},proto$1.isDeleting=function(e){return this.isPending("delete",e)},proto$1.isRemoving=function(e){return this.isPending("remove",e)},proto$1.isRecovering=function(e){return this.isPending("recover",e)},proto$1.toJson=function(){return this.properties},proto$1.toString=function(){return this.hasValue("rdfs:label")?this.get("rdfs:label").map(Util$1.formatValue).join(" "):this.hasValue("rdf:type")?this.get("rdf:type")[0].toString()+": "+this.id:this.id},proto$1.valueOf=function(){return this.id},proto$1.getPropertyChain=function(...e){const t=e.shift();return this.load().then((()=>this.hasValue(t)?e.length?this.getPropertyChain.apply(this[t][0],e):this[t]:[])).catch((e=>{console.log(e)}))},proto$1.getChainValue=function(...e){let t=this;Array.isArray(t)||(t=[t]);const i=e.shift(),r=t.map((e=>e.load()));return Promise.all(r).then((t=>{const r=t.reduce(((e,t)=>e.concat(t[i])),[]);return e.length?proto$1.getChainValue.apply(r,e):r})).catch((e=>(console.log(e),[])))},proto$1.hasChainValue=function(e,...t){return this.getChainValue(...t).then((t=>t.reduce(((t,i)=>t||e.valueOf()==i.valueOf()),!1)))},proto$1.prefetch=function(e,...t){return e=e||1,this.load().then((()=>prefetch.apply(this,[[],e,[this.id]].concat(t))))};var OntologyModel=veda.OntologyModel=OntologyModel$1;function OntologyModel$1(){return OntologyModel$1.prototype._singletonInstance?OntologyModel$1.prototype._singletonInstance:(this.ontology=[],this.ontologies={},this.datatypes={},this.classes={},this.properties={},this.specifications={},this.models={},this.classTree={},this.templates={},OntologyModel$1.prototype._singletonInstance=this.init())}const proto$2=OntologyModel$1.prototype;proto$2.init=function(){return"undefined"!=typeof window?Backend.loadFile("/ontology.json").then((e=>(this.ontology=JSON.parse(e),this.processOntology()))).catch((e=>{throw console.log("Ontology load error.",e.stack),e})):Backend.query(veda.ticket,"'rdf:type' == 'owl:Ontology' || 'rdf:type' == 'rdfs:Class' || 'rdf:type' == 'rdf:Property' || 'rdf:type' == 'rdfs:Datatype' || 'rdf:type' == 'v-ui:PropertySpecification' || 'rdf:type' == 'v-ui:ClassModel'").then((e=>{const t=e.result;return Backend.get_individuals(veda.ticket,t)})).then((e=>(this.ontology=e,console.log("Ontology length:",e.length),this.processOntology())))},proto$2.getClassProperties=function(e){const t=this.classTree,i=e=>{const r=t[e];let n;return r?(n=r.properties,[].concat.apply(n,r.superClasses.map(i))):i("rdfs:Resource")};return Util$1.unique(i(e))},proto$2.getClassSpecifications=function(e){const t=this.classTree,i=e=>{const r=t[e];let n;if(r){n=r.specifications;r.superClasses.map(i).map((e=>{for(const t in e)n[t]||(n[t]=e[t])}))}else n=i("rdfs:Resource");return n};return i(e)},proto$2.getClassTemplate=function(e){const t=this.templates[e];return t?t[0]:null},proto$2.processOntology=function(){const e=this.ontology,t=this.ontologies,i=this.datatypes,r=this.classes,n=this.properties,o=this.specifications,a=this.classTree,s=this.models,l=this.templates,d=e.map((e=>{if('{"@":""}'!==JSON.stringify(e))return new IndividualModel(e,1,!1)}));d.forEach((e=>{try{if(!e)return;const a=e.properties["rdf:type"][0].data,d=e.id;switch(a){case"rdfs:Class":case"owl:Class":r[d]=e;break;case"rdf:Property":case"owl:DatatypeProperty":case"owl:ObjectProperty":case"owl:OntologyProperty":case"owl:AnnotationProperty":n[d]=e,IndividualModel.prototype.hasOwnProperty(d)||IndividualModel.defineProperty(d);break;case"v-ui:PropertySpecification":case"v-ui:DatatypePropertySpecification":case"v-ui:ObjectPropertySpecification":o[d]=e;break;case"owl:Ontology":t[d]=e;break;case"rdfs:Datatype":i[d]=e;break;case"v-ui:ClassModel":s[d]=e;break;case"v-ui:TemplateSpecification":const a=e.properties["v-ui:forClass"][0].data;l[a]?l[a].push(e):l[a]=[e]}}catch(t){console.log("Ontology init error, uri =",e.id,t.stack)}})),Object.keys(r).forEach((e=>{try{const t=r[e];if(a[t.id]||(a[t.id]={superClasses:[],properties:[],specifications:{}}),"rdfs:Resource"===t.id)return;t.hasValue("rdfs:subClassOf")||(t["rdfs:subClassOf"]=[r["rdfs:Resource"]]),t["rdfs:subClassOf"].map((e=>{a[t.id].superClasses.push(e.id)}))}catch(t){console.log("Ontology init error, uri =",e,t.stack)}})),Object.keys(n).forEach((e=>{try{const t=n[e];if(!t["rdfs:domain"])return;t["rdfs:domain"].map((e=>{a[e.id].properties.push(t.id)}))}catch(t){console.log("Ontology init error, uri =",e,t.stack)}})),Object.keys(o).forEach((e=>{try{const t=o[e];if(!t["v-ui:forClass"])return;t["v-ui:forClass"].map((e=>{t["v-ui:forProperty"].map((i=>{a[e.id].specifications[i.id]=t.id}))}))}catch(t){console.log("Ontology init error, uri =",e,t.stack)}})),Object.keys(l).forEach((e=>{try{l[e]=l[e].sort(((e,t)=>e.properties["v-s:loadPriority"]?t.properties["v-s:loadPriority"]?e.properties["v-s:loadPriority"][0].data-t.properties["v-s:loadPriority"][0].data:-1:1)).map((e=>e.properties["v-ui:defaultTemplate"][0].data))}catch(t){console.log("Ontology init error, uri =",e,t.stack)}}));const c=d.map(((e,t)=>e.init().catch((t=>console.log("Ontology individual init error, uri =",e.id,t.stack)))));return"undefined"!=typeof window?Promise.all(c).then((()=>this)):Promise.resolve(this)};var UserModel=veda.UserModel=UserModel$1;function UserModel$1(e){return IndividualModel.call(this,e)}UserModel$1.prototype=Object.create(IndividualModel.prototype),UserModel$1.prototype.constructor=UserModel$1;const proto$3=UserModel$1.prototype;function UpdateService(){const e=this;if(UpdateService.prototype._singletonInstance)return UpdateService.prototype._singletonInstance;this.list={};const t=2500+Math.round(2500*Math.random()),i=3e5;let r=[];let n,o,a=t,s=Date.now();return UpdateService.prototype._singletonInstance=l();function l(){return Backend.reset_individual(veda.ticket,"cfg:ClientUpdateServicePort").then((t=>{const i=t["rdf:value"]&&t["rdf:value"][0].data,r="http:"===window.location.protocol?"ws:":"wss:",n=i||window.location.port,o=r+"//"+window.location.hostname+(n?":"+n:"")+"/ccus",a=new WebSocket(o);return a.onopen=u,a.onclose=v,a.onerror=p,a.onmessage=f,a.receiveMessage=c,a.sendMessage=d,e.socket=a,e})).catch((e=>{a=a<i?1.1*a:i,console.log("init socket error, retry in",a/1e3,"sec"),setTimeout(l,a)}))}function d(e){const t=this;"="!==e&&"-*"!==e&&0!==e.indexOf("ccus")?(r.push(e),n||(n=setTimeout((()=>{const e=r.join(",");1===t.readyState&&t.send(e),r=[],n=void 0}),1e3))):1===t.readyState&&t.send(e)}function c(t){if(""===t)return void(s=Date.now());let i=0===t.indexOf("=")?t.substr(1):t;if(0!==i.length){i=i.split(",");for(let t=0;t<i.length;t++)try{const r=i[t].split("="),n=r[0];if(!n)continue;const o=parseInt(r[1]),a=new IndividualModel(n);if(a.hasValue("v-s:updateCounter",o))continue;e.list[n]&&(e.list[n].updateCounter=o),e.list[n].action?e.list[n].action.call(a,o):0!==o&&a.reset()}catch(e){console.log("error: individual update service failed",e)}}}function u(i){a=t,console.log("client: websocket opened",i.target.url),this.sendMessage("ccus="+veda.ticket),e.restore(),veda.trigger("ccus-online"),o=setInterval((()=>{if(Date.now()-s>2e4)return console.log("client: ping missed, close socket"),veda.trigger("ccus-offline"),clearInterval(o),void this.close()}),1e4)}function f(e){const t=e.data;this.receiveMessage(t)}function p(e){console.log("client: ccus error",e),this.close()}function v(e){a=a<i?1.1*a:i,console.log("client: websocket closed",e.target.url,"| re-connect in",a/1e3,"sec"),setTimeout(l,a),veda.trigger("ccus-offline"),clearInterval(o)}}proto$3.getLanguage=function(){return this.preferences&&this.preferences.language?Object.keys(this.preferences.language):void 0},proto$3._init=function(){return this.load().then(this.initAspect.bind(this)).then(this.initAppointment.bind(this)).then(this.initPreferences.bind(this)).then(this.initLanguage.bind(this)).then((()=>{if("cfg:Guest"!==this.id)return this.save()})).catch((e=>{console.log("User init error",e.stack)}))},proto$3.initAspect=function(){const e=this.id+"_aspect";return(this.hasValue("v-s:hasAspect")?this["v-s:hasAspect"][0]:new veda.IndividualModel(e)).load().catch((t=>{console.log("personal aspect load error",t);const i=new IndividualModel(e);return i["rdf:type"]="v-s:PersonalAspect",i["v-s:owner"]=this,i["rdfs:label"]="PersonalAspect_"+this.id,"cfg:Guest"!==this.id?i.save():i})).catch((e=>{throw console.log("personal aspect save error",e),e})).then((e=>{this.hasValue("v-s:hasAspect")||(this["v-s:hasAspect"]=e),this.aspect=e}))},proto$3.initAppointment=function(){if(this.hasValue("v-s:defaultAppointment"))veda.appointment=this["v-s:defaultAppointment"][0];else{if(!this.hasValue("v-s:hasAppointment"))return veda.appointment=void 0;this["v-s:defaultAppointment"]=[this["v-s:hasAppointment"][0]],veda.appointment=this["v-s:defaultAppointment"][0]}return this.on("v-s:defaultAppointment",(()=>{const e=this.hasValue("v-s:defaultAppointment")&&this["v-s:defaultAppointment"][0];e&&e.load().then((e=>{veda.appointment=e})),this.save()})),veda.appointment.load()},proto$3.initPreferences=function(){const e=this.id+"_pref";return(this.hasValue("v-ui:hasPrefences")?this["v-ui:hasPrefences"][0]:new veda.IndividualModel(e)).load().catch((t=>{console.log("personal preferences load error",t);const i=new IndividualModel(e);return i["v-s:owner"]=this,i["rdf:type"]="v-ui:Preferences",i["rdfs:label"]="Preferences_"+this.id,this["v-ui:hasPreferences"]=i,"cfg:Guest"!==this.id?i.save():i})).catch((e=>{throw console.log("personal preferences save error",e),e})).then((e=>(this.hasValue("v-ui:hasPreferences")||(this["v-ui:hasPreferences"]=e),this.preferences=e,e)))},proto$3.initLanguage=function(e){const t=()=>{e.language=e["v-ui:preferredLanguage"].reduce(((e,t)=>(e[t.id.substr(t.id.indexOf(":")+1)]=t,e)),{}),veda.trigger("language:changed")},i=function(){e.displayedElements=e["v-ui:displayedElements"][0]||10},r=()=>{if("cfg:Guest"!==this.id)return e.save()};if(!e.hasValue("v-ui:preferredLanguage")||!e.hasValue("v-ui:displayedElements")){const t=10,i=new IndividualModel("v-ui:RU");e["v-ui:preferredLanguage"]=[i],e["v-ui:displayedElements"]=[t]}return e.on("v-ui:preferredLanguage",t),e.on("v-ui:displayedElements",i),e.on("v-ui:preferredLanguage v-ui:displayedElements",r),t(),i(),r()};const proto$4=UpdateService.prototype;function AppModel(e){return riot.observable(this),this.manifest=e,this.ticket=this.ticket||"",this.ontology={},this.cache={limit:2e4,count:0,delta:1e3,storage:{},expire:{},get:function(e){return this.storage[e]},set:function(e,t){let i=this.count;const r=this.limit,n=this.delta;if(i>=r){const e=Object.keys(this.expire);for(let t,o=1;(t=e[o])&&r-i<n;o++)this.expire[t]=this.expire[t].filter((e=>r-i>=n||(delete this.storage[e.id],i--,!1))),0===this.expire[t].length&&delete this.expire[t];this.count=i,console.log("veda.cache limit ("+this.limit+" elements) reached, "+this.delta+" removed.")}const o="number"==typeof t?t:Date.now();if(e.expires=o,this.storage[e.id]=e,this.expire[o]=this.expire[o]||[],this.expire[o].push(e),this.count++,"undefined"!=typeof window&&1!==o){(new UpdateService).then((t=>{t.subscribe(e.id)}))}},remove:function(e){const t=this.storage[e].expires;if(this.expire[t]=this.expire[t].filter((t=>t.id!==e)),0===this.expire[t].length&&delete this.expire[t],this.count--,"undefined"!=typeof window){(new UpdateService).then((t=>{t.unsubscribe(e)}))}return delete this.storage[e]},clear:function(){if(this.count=0,this.storage={},this.expire={},"undefined"!=typeof window){(new UpdateService).then((e=>{e.unsubscribe()}))}}},this.init=function(e){return(new OntologyModel).then((t=>(this.ontology=t,this.user=new UserModel(e),this.user._init())))},this}proto$4.subscribe=function(e,t){const i=this;if(this.list[e])++this.list[e].subscribeCounter;else{const r=new IndividualModel(e);r.load().catch((e=>{console.log("subscribed individual load error",e)})).then((()=>{const n=r.hasValue("v-s:updateCounter")?r.get("v-s:updateCounter")[0]:0;i.list[e]={subscribeCounter:1,updateCounter:n},t&&(i.list[e].action=t),i.socket.sendMessage("+"+e+"="+n)}))}},proto$4.unsubscribe=function(e){e?this.list[e]&&this.list[e].subscribeCounter>1?--this.list[e].subscribeCounter:(delete this.list[e],this.socket.sendMessage("-"+e)):(this.list={},this.socket.sendMessage("-*"))},proto$4.restore=function(){this.socket.sendMessage("-*");for(const e in this.list)Object.hasOwnProperty.call(this.list,e)&&this.socket.sendMessage("+"+e+"="+this.list[e].updateCounter)};var Sha256={hash:function(e,t){(t=void 0===t||t)&&(e=Utf8.encode(e));for(var i=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],r=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],n=(e+=String.fromCharCode(128)).length/4+2,o=Math.ceil(n/16),a=new Array(o),s=0;s<o;s++){a[s]=new Array(16);for(var l=0;l<16;l++)a[s][l]=e.charCodeAt(64*s+4*l)<<24|e.charCodeAt(64*s+4*l+1)<<16|e.charCodeAt(64*s+4*l+2)<<8|e.charCodeAt(64*s+4*l+3)}a[o-1][14]=8*(e.length-1)/Math.pow(2,32),a[o-1][14]=Math.floor(a[o-1][14]),a[o-1][15]=8*(e.length-1)&4294967295;var d,c,u,f,p,v,h,_,g=new Array(64);for(s=0;s<o;s++){for(var m=0;m<16;m++)g[m]=a[s][m];for(m=16;m<64;m++)g[m]=Sha256.sigma1(g[m-2])+g[m-7]+Sha256.sigma0(g[m-15])+g[m-16]&4294967295;d=r[0],c=r[1],u=r[2],f=r[3],p=r[4],v=r[5],h=r[6],_=r[7];for(m=0;m<64;m++){var w=_+Sha256.Sigma1(p)+Sha256.Ch(p,v,h)+i[m]+g[m],k=Sha256.Sigma0(d)+Sha256.Maj(d,c,u);_=h,h=v,v=p,p=f+w&4294967295,f=u,u=c,c=d,d=w+k&4294967295}r[0]=r[0]+d&4294967295,r[1]=r[1]+c&4294967295,r[2]=r[2]+u&4294967295,r[3]=r[3]+f&4294967295,r[4]=r[4]+p&4294967295,r[5]=r[5]+v&4294967295,r[6]=r[6]+h&4294967295,r[7]=r[7]+_&4294967295}return Sha256.toHexStr(r[0])+Sha256.toHexStr(r[1])+Sha256.toHexStr(r[2])+Sha256.toHexStr(r[3])+Sha256.toHexStr(r[4])+Sha256.toHexStr(r[5])+Sha256.toHexStr(r[6])+Sha256.toHexStr(r[7])},ROTR:function(e,t){return t>>>e|t<<32-e},Sigma0:function(e){return Sha256.ROTR(2,e)^Sha256.ROTR(13,e)^Sha256.ROTR(22,e)},Sigma1:function(e){return Sha256.ROTR(6,e)^Sha256.ROTR(11,e)^Sha256.ROTR(25,e)},sigma0:function(e){return Sha256.ROTR(7,e)^Sha256.ROTR(18,e)^e>>>3},sigma1:function(e){return Sha256.ROTR(17,e)^Sha256.ROTR(19,e)^e>>>10},Ch:function(e,t,i){return e&t^~e&i},Maj:function(e,t,i){return e&t^e&i^t&i},toHexStr:function(e){for(var t="",i=7;i>=0;i--)t+=(e>>>4*i&15).toString(16);return t}},Utf8={encode:function(e){var t=e.replace(/[\u0080-\u07ff]/g,(function(e){var t=e.charCodeAt(0);return String.fromCharCode(192|t>>6,128|63&t)}));return t=t.replace(/[\u0800-\uffff]/g,(function(e){var t=e.charCodeAt(0);return String.fromCharCode(224|t>>12,128|t>>6&63,128|63&t)}))},decode:function(e){var t=e.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,(function(e){var t=(15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2);return String.fromCharCode(t)}));return t=t.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,(function(e){var t=(31&e.charCodeAt(0))<<6|63&e.charCodeAt(1);return String.fromCharCode(t)}))}};const Codelet={};veda.Codelet=Codelet,Codelet.down_right_and_store=function(e,t){return Codelet.change_rights(e,t,[{data:"-r--"}])},Codelet.change_rights=function(e,t,i){return Codelet.change_rights_actor(e,t,[{data:"-r--"}],"actor")},Codelet.change_rights_actor=function(e,t,i,r,n,o){try{let a;a=n||e.getInputVariable("docId");const s=[];if(i[0].data.indexOf("r")>=0&&s.push("v-s:canRead"),i[0].data.indexOf("u")>=0&&s.push("v-s:canUpdate"),a){let i;o?i=o:(i=e.getLocalVariable(r)?e.getLocalVariable(r):e.getExecutor(),i||(i=t.getInputVariable(r)),i||(i=[i]));for(let n=0;n<i.length;n++){let o=[i[n]];print("@JS3 executor=",veda.Util.toJson(o));const l=veda.Workflow.get_properties_chain(o,[{$get:"v-s:employee"}],void 0);if(print("@JS4 employee=",veda.Util.toJson(l)),l){const i=veda.Util.getUri(l);i?veda.Util.addRight(ticket,i,veda.Util.getUri(a),s):print("ERR! change_rights_actor: undefined employee_uri, actor=["+r+"], executor="+veda.Util.toJson(o)+", doc_id="+veda.Util.getUri(a)+", process="+veda.Util.getUri(e)+", task="+veda.Util.getUri(t))}if(o=veda.Workflow.get_properties_chain(o,[{$get:"v-s:occupation"}],o),o||print("@JS executor undefined, actor=",e.getLocalVariable(r)),o){const i=veda.Util.getUri(o);i?veda.Util.addRight(ticket,i,veda.Util.getUri(a),s):print("ERR! change_rights_actor: undefined executor_uri, actor=["+r+"], executor="+veda.Util.toJson(o)+", doc_id="+veda.Util.getUri(a)+", process="+veda.Util.getUri(e)+", task="+veda.Util.getUri(t))}}}return[veda.Workflow.get_new_variable("right",veda.Util.newStr("acl1"))]}catch(e){print(e.stack)}},Codelet.restore_right=function(e){try{return[veda.Workflow.get_new_variable("result",veda.Util.newStr("Ok"))]}catch(e){print(e.stack)}},Codelet.complete_process=function(e,t,i){Codelet.change_process_status(e,t,"v-wf:Completed",i)},Codelet.interrupt_process=function(e,t,i){Codelet.change_process_status(e,t,"v-wf:Interrupted",i)},Codelet.change_process_status=function(e,t,i,r){const n=t["v-wf:inVars"];if(n)for(let o=0;o<n.length;o++){const a=get_individual(t.ticket,n[o].data);if(a&&a["v-wf:variableName"][0]&&"docId"==a["v-wf:variableName"][0].data){const n=get_individual(e,a["v-wf:variableValue"][0].data);if(!n["v-wf:isProcess"])continue;for(let o=0;o<n["v-wf:isProcess"].length;o++)if(n["v-wf:isProcess"][o].data==t["@"]){delete n["v-wf:isProcess"],n["v-wf:hasStatusWorkflow"]=veda.Util.newUri(i),put_individual(e,n,r);break}}}},Codelet.change_document_workflow_status=function(e,t){const i=e.getInputVariable("docId");if(i){const r={"@":veda.Util.getUri(i)};r["v-wf:hasStatusWorkflow"]=veda.Util.newUri(t),set_in_individual(e.ticket,r,_event_id)}return[veda.Workflow.get_new_variable("workflowStatus",veda.Util.newStr(t))]},Codelet.change_document_status=function(e,t){if(t){const i=e.getInputVariable("setStatus");if(i&&1==i[0].data){const i=e.getInputVariable("docId");if(i){const r={"@":veda.Util.getUri(i)};if(r["v-s:hasStatus"]=veda.Util.newUri(t),"v-s:StatusExecuted"==t)r["v-s:dateFact"]=veda.Util.newDate(Date.now());else if("v-s:StatusExecution"==t){const t=get_individual(e.ticket,veda.Util.getUri(i));if(t&&!t["v-s:dateToPlan"]&&t["v-s:count"]&&t["v-s:count"].length>0){r["v-s:dateFromPlan"]=veda.Util.newDate((new Date).setHours(0,0,0,0));const e=t["v-s:count"][0].data,i=new Date(Date.now()+864e5*e).setHours(0,0,0,0);r["v-s:dateToPlan"]=veda.Util.newDate(i)}}set_in_individual(e.ticket,r,_event_id)}}}return[veda.Workflow.get_new_variable("status",veda.Util.newStr(t))]},Codelet.createPermissionStatement=function(e,t){print("###### Start Codelet.createPermissionStatement ######");const i=e.getInputVariable("docId");let r,n;if(print("docId:",veda.Util.toJson(i)),"rework"===t?(r=e.getLocalVariable("responsible"),n=i[0].data+"-pf-rework"):"task"===t&&(r=e.getLocalVariable("actor"),n=i[0].data+"-pf-task"),print("subjectAppointmentUri: ",veda.Util.toJson(r)),r){const e=get_individual(ticket,r[0].data);if(e){const t={"@":n,"rdf:type":veda.Util.newUri("v-s:PermissionStatement"),"v-s:useFilter":veda.Util.newUri("v-s:StatusStarted"),"v-s:permissionObject":i,"v-s:permissionSubject":e["v-s:employee"].concat(e["v-s:occupation"]),"v-s:canUpdate":veda.Util.newBool("true")};print("@@@@@responsible:",veda.Util.toJson(e["v-s:employee"].concat(e["v-s:occupation"]))),put_individual(ticket,t,_event_id),print("put_individual: ",n)}else print("Error create_permission_statement_executor: not found subjectAppointment: ",r)}else print("Error create_permission_statement_executor: not found local variable 'responsible'");return print("###### Finish Codelet.createPermissionStatement ######"),veda.Util.newStr(n)},Codelet.deletePermissionStatement=function(e,t){print("###### Start Codelet.deletePermissionStatement ######");const i=e.getInputVariable("docId");let r;print("docId:",veda.Util.toJson(i)),"rework"===t?r=i[0].data+"-pf-rework":"task"===t&&(r=i[0].data+"-pf-task");const n={"@":r,"v-s:deleted":veda.Util.newBool("true")};return set_in_individual(ticket,n),print("###### Finish Codelet.deletePermissionStatement ######"),veda.Util.newStr("empty")},Codelet.is_exists_net_executor=function(e){try{const t=void 0!==e.getExecutor();return[veda.Workflow.get_new_variable("res",veda.Util.newBool(t))]}catch(e){print(e.stack)}},Codelet.get_type_of_docId=function(e){try{let t="?";if(e){const i=e.getInputVariable("docId");if(i){const r=get_individual(e.ticket,i[0].data);r&&(t=r["rdf:type"][0].data)}}return[veda.Workflow.get_new_variable("res",veda.Util.newUri(t))]}catch(e){print(e.stack)}},Codelet.is_in_docflow_and_set_if_true=function(e){try{const t=!1;if(e){const t=e.getInputVariable("docId");if(t){const i=veda.Util.getUri(e.src_data["v-wf:forProcess"]),r=get_individual(e.ticket,i);if(r){const i=veda.Util.getUri(r["v-wf:instanceOf"]),n={"@":i+"_"+t[0].data,"rdf:type":[{data:"v-wf:Variable",type:"Uri"}]};put_individual(e.ticket,n,_event_id);const o={"@":t[0].data,"v-wf:isProcess":veda.Util.newUri(r["@"])};print("$ add_to_document >>"+veda.Util.toJson(o)),add_to_individual(ticket,o,_event_id)}}}return[veda.Workflow.get_new_variable("result",veda.Util.newUri(t))]}catch(e){print(e.stack)}},Codelet.distribution=function(e,t){},Codelet.add_value_to_document=function(e,t){try{let e;if(t){e=t.getInputVariable("src_uri");let i=t.getInputVariable("name_uri");const r=t.getInputVariable("value");let n;if(i&&r&&(n=get_individual(t.ticket,veda.Util.getUri(e)),n)){i=veda.Util.getUri(i);let e=n[i];e||(e=[]);for(const t in r)Object.hasOwnProperty.call(r,t)&&e.push(r[t]);n[i]=e,put_individual(ticket,n,_event_id)}}return[veda.Workflow.get_new_variable("res",e)]}catch(e){print(e.stack)}},Codelet.set_value_to_document=function(e,t){try{let e;if(t){e=t.getInputVariable("src_uri");let i=t.getInputVariable("name_uri");const r=t.getInputVariable("value");let n;i&&r&&(n=get_individual(t.ticket,veda.Util.getUri(e)),n&&(i=veda.Util.getUri(i),n[i]=r,put_individual(ticket,n,_event_id)))}return[veda.Workflow.get_new_variable("res",e)]}catch(e){print(e.stack)}},Codelet.create_use_transformation=function(e,t){try{const i=[];if(t){const r=t.getInputVariable("src_uri"),n=t.getInputVariable("transformation_uri");if(n){const o=get_individual(t.ticket,veda.Util.getUri(n));if(o){const n=get_individual(t.ticket,veda.Util.getUri(r));if(n){const r=veda.Util.transformation(t.ticket,n,o,null,null,veda.Util.newUri(e.src_data["@"]));for(let e=0;e<r.length;e++)put_individual(ticket,r[e],_event_id),i.push({data:r[e]["@"],type:"Uri"})}}}}return[veda.Workflow.get_new_variable("res",i)]}catch(e){print(e.stack)}},Codelet.find_long_terms=function(e,t,i){let r=get_from_ght("cid");if(r){const i=get_individual(e,t);if(i){let r=!1;for(const n in i)if(Object.hasOwnProperty.call(i,n)){const o=i[n];if("@"!=n){const e=[];for(const i in o)if(Object.hasOwnProperty.call(o,i)){const a=o[i],s=get_from_ght(a.data);s&&(print("found: value>63,"+t+" "+n+"="+a.data+" -> "+s),a.data=s,r=!0),e.push(a)}1==r&&(i[n]=e)}else if(get_from_ght(o)){const r=get_from_ght(o);r&&(print("found: uri>63,"+o+"(remove) -> "+r),i["@"]=r,put_individual(e,i,""),remove_individual(e,t,""))}}1==r&&put_individual(e,i,"")}}else{let t=0;r=new_uris_consumer(),put_to_ght("cid",r),print("new cid="+r);let i="?";for(;i;)if(i=uris_pop(r),i&&(uris_commit_and_next(r,!0),i.length>63)){const r=get_individual(e,i);if(r&&veda.Util.hasValue(r,"rdf:type",{data:"v-s:Appointment",type:"Uri"})){let e=Sha256.hash(i);e="d:appt_"+e.substr(0,50),put_to_ght(i,e),t++}}print("found appointments : "+t)}},Codelet.onto_rename=function(e,t,i){try{if(t["@"]===i["@"])return;const r=i["v-s:argument"],n=veda.Util.loadVariablesUseField(e,r);for(const e in r)if(Object.hasOwnProperty.call(r,e)){if(r[e].data===t["@"])return}const o=n.rename_template;let a=!1,s=!1;const l=t["@"],d={};for(const e in o)if(Object.hasOwnProperty.call(o,e)){const t=o[e].split(",");if(!t||2!=t.length)continue;const i=t[0],r=t[1];d[i]=r;const n=i.replace(":","_"),a=r.replace(":","_");n!==i&&(d[n]=a)}for(const e in t)if(Object.hasOwnProperty.call(t,e)){const i=t[e];if("@"!=e){for(const r in d)if(Object.hasOwnProperty.call(d,r)&&e===r){t[d[r]]=i,delete t[r]}for(const e in i)if(Object.hasOwnProperty.call(i,e)){const t=i[e];for(const e in d)if(Object.hasOwnProperty.call(d,e)&&("Uri"==t.type||"String"==t.type)){const i=d[e],r=veda.Util.replace_word(t.data,e,i);r!==t.data&&(a=!0,t.data=r)}}}else for(const e in d)if(Object.hasOwnProperty.call(d,e)){const r=d[e],n=veda.Util.replace_word(i,e,r);n!==i&&(s=!0,t["@"]=n)}}s?(remove_individual(e,l,""),put_individual(e,t,"")):a&&put_individual(e,t,"")}catch(e){"undefined"==typeof window?print(e.stack):console.log(e.stack)}};const Workflow=veda.Workflow||{};veda.Workflow=Workflow,Workflow.prepare_decision_form=function(e,t,i){try{const r=t;if(r["sys:source"])return;const n=i;let o=null;n&&(o=n["v-wf:takenDecision"]);const a=r["v-wf:takenDecision"];if(!a&&!o)return;const s=veda.Util.hasValue(r,"v-wf:enforceProcessing",{data:!0,type:"Boolean"});if(o&&!s)return void(a?a.length==o.length&&veda.Util.getUri(a)==veda.Util.getUri(o)||(veda.Util.set_err_on_indv("attempt set another decision "+veda.Util.toJson(a)+", restore previous decision",t,"prepare decision form"),veda.Util.set_field_to_document("v-wf:takenDecision",o,r["@"])):(veda.Util.set_err_on_indv("attempt clear decision["+veda.Util.getUri(o)+"], restore previous decision",t,"prepare decision form"),veda.Util.set_field_to_document("v-wf:takenDecision",o,r["@"])));if(r["v-wf:isCompleted"]&&1==r["v-wf:isCompleted"][0].data)return;const l=t["v-wf:onWorkOrder"],d=get_individual(e,veda.Util.getUri(l));if(!d)return void veda.Util.set_err_on_indv("WorkOrder["+veda.Util.getUri(l)+"], not found",t,"prepare decision form");const c=d["v-wf:executor"];let u;c&&c.length>0&&(u=c[0]);const f=d["v-wf:forWorkItem"],p=get_individual(e,veda.Util.getUri(f));if(!p)return void veda.Util.set_err_on_indv("invalid WorkOrder["+veda.Util.getUri(l)+"], field v-wf:forWorkItem["+veda.Util.getUri(f)+"], not found",t,"prepare decision form");const v=p["v-wf:isCompleted"];if(v&&!0===v[0].data)return void veda.Util.set_err_on_indv("WorkItem["+veda.Util.getUri(f)+"], already is completed, skip decision form...",t,"prepare decision form");const h=p["v-wf:forProcess"],_=veda.Util.getUri(h),g=get_individual(e,_);if(!g)return void veda.Util.set_err_on_indv("invalid WorkItem["+veda.Util.getUri(f)+"], field v-wf:forProcess["+veda.Util.getUri(h)+"], not found",t,"prepare decision form");const m=g["v-wf:isStopped"];if(m&&!0===m[0].data)return;const w=p["v-wf:forNetElement"],k=get_individual(e,veda.Util.getUri(w));if(!k)return void veda.Util.set_err_on_indv("invalid WorkItem["+veda.Util.getUri(f)+"], field v-wf:forNetElement["+veda.Util.getUri(w)+"], not found",t,"prepare decision form");const U=veda.Util.getUri(k["v-wf:completeDecisionTransform"]);if(!U)return void veda.Util.set_err_on_indv("invalid net_element["+veda.Util.getUri(w)+"], field v-wf:completeDecisionTransform["+U+"], not found",t,"prepare decision form");const y=get_individual(e,U);if(!y)return void veda.Util.set_err_on_indv("invalid net_element["+veda.Util.getUri(w)+"], field v-wf:completeDecisionTransform["+U+"], not found",t,"prepare decision form");const b=veda.Util.transformation(e,r,y,u,l,h),O=Workflow.store_items_and_set_minimal_rights(e,b);b.length>0&&(veda.Util.set_field_to_document("v-wf:outVars",O,d["@"]),d["v-wf:outVars"]=O,veda.Util.set_field_to_document("v-wf:isCompleted",veda.Util.newBool(!0),t["@"]),Workflow.mapToJournal(k["v-wf:completedExecutorJournalMap"],e,g,p,d,null,veda.Util.getJournalUri(d["@"])))}catch(e){print(e.stack)}},Workflow.prepare_work_order=function(ticket,document){try{const _work_order=document,f_executor=document["v-wf:executor"],executor=get_individual(ticket,veda.Util.getUri(f_executor));if(f_executor&&!executor)return;const f_forWorkItem=veda.Util.getUri(document["v-wf:forWorkItem"]),work_item=get_individual(ticket,f_forWorkItem);if(!work_item)return;const forProcess=work_item["v-wf:forProcess"],forProcess_uri=veda.Util.getUri(forProcess),_process=get_individual(ticket,forProcess_uri);if(!_process)return;const isStopped=_process["v-wf:isStopped"];if(isStopped&&!0===isStopped[0].data)return;const trace_journal_uri=Workflow.create_new_trace_subjournal(f_forWorkItem,_work_order,"prepare_work_order:"+_work_order["@"],"v-wf:WorkOrderStarted");let journal_uri;trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"обработка рабочего задания",veda.Util.toJson(document));let f_inVars=work_item["v-wf:inVars"];f_inVars||(f_inVars=[]);const forNetElement=work_item["v-wf:forNetElement"],net_element=get_individual(ticket,veda.Util.getUri(forNetElement));if(!net_element)return;const f_local_outVars=document["v-wf:outVars"];let task_output_vars=[];const f_useSubNet=document["v-wf:useSubNet"];if(!f_local_outVars)if(journal_uri=Workflow.create_new_subjournal(f_forWorkItem,_work_order["@"],net_element["rdfs:label"],"v-wf:WorkOrderStarted"),executor||Workflow.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap"),executor){const is_appointment=veda.Util.hasValue(executor,"rdf:type",{data:"v-s:Appointment",type:"Uri"}),is_position=veda.Util.hasValue(executor,"rdf:type",{data:"v-s:Position",type:"Uri"}),is_codelet=veda.Util.hasValue(executor,"rdf:type",{data:"v-s:Codelet",type:"Uri"});if(is_codelet){Workflow.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap");const expression=veda.Util.getFirstValue(executor["v-s:script"]);if(!expression)return;const task=new Workflow.Context(work_item,ticket),process=new Workflow.Context(_process,ticket),codelet_output_vars=eval(expression);if(codelet_output_vars&&codelet_output_vars.length>0){const e=Workflow.store_items_and_set_minimal_rights(ticket,codelet_output_vars);_work_order["v-wf:outVars"]=e,put_individual(ticket,_work_order,_event_id)}}else if((is_appointment||is_position)&&!f_useSubNet){const e=[];for(let t=0;t<f_inVars.length;t++){const i=get_individual(ticket,f_inVars[t].data);e.push(i)}let t,i=work_item;for(;!t;){const e=veda.Util.getUri(i["v-wf:previousWorkItem"]);if(!e)break;const r=get_individual(ticket,e);if(!r)break;const n=veda.Util.getUri(r["v-wf:forNetElement"]);if(!n)break;const o=get_individual(ticket,n);if(!o)break;if("v-wf:Task"==o["rdf:type"][0].data){t=r["v-wf:forNetElement"];break}i=r}let r={"@":"-","rdf:type":[{data:"v-wf:Variable",type:"Uri"}],"v-wf:variableName":[{data:"curTask",type:"String"}],"v-wf:variableValue":forNetElement};e.push(r),t&&(r={"@":"-","rdf:type":[{data:"v-wf:Variable",type:"Uri"}],"v-wf:variableName":[{data:"prevTask",type:"String"}],"v-wf:variableValue":t},e.push(r)),Workflow.mapToJournal(net_element["v-wf:startingExecutorJournalMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingExecutorJournalMap");const n=veda.Util.getUri(net_element["v-wf:startDecisionTransform"]);if(!n)return;const o=get_individual(ticket,n);if(!o)return;const a=veda.Util.transformation(ticket,e,o,f_executor,veda.Util.newUri(document["@"]),forProcess);trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"v-wf:startDecisionTransform","transform_result="+veda.Util.toJson(a));const s=[];if(a)for(let e=0;e<a.length;e++){if(null==a[e]["v-s:created"]?a[e]["v-s:created"]=veda.Util.newDate(new Date):a[e]["v-s:edited"]=veda.Util.newDate(new Date),null==a[e]["v-s:creator"]&&(a[e]["v-s:creator"]=veda.Util.newUri("cfg:VedaSystem")),put_individual(ticket,a[e],_event_id),s.push({data:a[e]["@"],type:"Uri"}),is_appointment){const t=executor["v-s:employee"];t&&veda.Util.addRight(ticket,t[0].data,a[e]["@"],["v-s:canRead","v-s:canUpdate"]);const i=executor["v-s:occupation"];i&&veda.Util.addRight(ticket,i[0].data,a[e]["@"],["v-s:canRead","v-s:canUpdate"])}is_position&&veda.Util.addRight(ticket,executor["@"],a[e]["@"],["v-s:canRead","v-s:canUpdate"])}const l={"@":document["@"],"v-wf:decisionFormList":s};add_to_individual(ticket,l,_event_id),_work_order["v-wf:decisionFormList"]=s,Workflow.mapToMessage(net_element["v-wf:startingMessageMap"],ticket,_process,work_item,_work_order,null,journal_uri,trace_journal_uri,"v-wf:startingMessageMap")}!veda.Util.hasValue(executor,"rdf:type",{data:"v-wf:Net",type:"Uri"})&&!f_useSubNet||is_codelet||Workflow.create_new_subprocess(ticket,f_useSubNet,f_executor,net_element,f_inVars,document,trace_journal_uri)}else net_element["v-wf:completedMapping"]?task_output_vars=Workflow.create_and_mapping_variables(ticket,net_element["v-wf:completedMapping"],_process,work_item,null,null,!0,trace_journal_uri,"v-wf:completedMapping"):task_output_vars.push({data:"v-wf:complete",type:"Uri"}),0==task_output_vars.length&&task_output_vars.push({data:"v-wf:complete",type:"Uri"}),task_output_vars.length>0&&(document["v-wf:outVars"]=task_output_vars,put_individual(ticket,document,_event_id));let is_goto_to_next_task=!1,is_have_enforce_order=!1;const work_item_result=[],wosResultsMapping=net_element["v-wf:wosResultsMapping"],workOrderList=work_item["v-wf:workOrderList"];if(workOrderList)for(let e=0;e<workOrderList.length;e++){let t;t=workOrderList[e].data!=document["@"]?get_individual(ticket,workOrderList[e].data):document,is_have_enforce_order=is_have_enforce_order||veda.Util.hasValue(t,"v-wf:enforceProcessing",{data:!0,type:"Boolean"});const i=t["v-wf:outVars"];if(i){const e={};e.workOrder=t["@"];let r=!1;for(let t=0;t<i.length;t++){const n=get_individual(ticket,i[t].data);if(n)if(wosResultsMapping);else{let t,i;const o=n["v-wf:variableName"];o&&(t=o[0].data);const a=n["v-wf:variableValue"];a&&(i=a),void 0!==t&&(e[t]=i,r=!0)}}r&&work_item_result.push(e)}}work_item_result.length==workOrderList.length?is_goto_to_next_task=!0:trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"[WO4.0] не все задания выполнены","stop. work_item_result"+veda.Util.toJson(work_item_result)+", workOrderList=",veda.Util.toJson(workOrderList)),trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"[WO4] work_item_result",veda.Util.toJson(work_item_result));const workItemList=[];if(is_goto_to_next_task)if(!is_have_enforce_order&&work_item["v-wf:isCompleted"]&&1==work_item["v-wf:isCompleted"][0].data)veda.Util.traceToJournal(ticket,trace_journal_uri,"[WO4] work_item already is completed, stop. ",veda.Util.toJson(work_item));else{journal_uri=veda.Util.getJournalUri(_work_order["@"]),work_item_result.length>0&&(work_item_result[0].complete||Workflow.mapToJournal(net_element["v-wf:completedJournalMap"],ticket,_process,work_item,null,net_element["rdfs:label"],journal_uri)),net_element["v-wf:completedMapping"]&&(task_output_vars=Workflow.create_and_mapping_variables(ticket,net_element["v-wf:completedMapping"],_process,work_item,null,work_item_result,!0,trace_journal_uri,"v-wf:completedMapping"));const hasFlows=net_element["v-wf:hasFlow"];if(hasFlows){const split=veda.Util.getUri(net_element["v-wf:split"]);for(let i=0;i<hasFlows.length;i++){const flow=get_individual(ticket,hasFlows[i].data);if(!flow)continue;const flowsInto=flow["v-wf:flowsInto"];if(!flowsInto)continue;const predicate=flow["v-wf:predicate"];if(predicate){const expression=veda.Util.getFirstValue(predicate);if(expression)try{const task_result=new Workflow.WorkItemResult(work_item_result),task=new Workflow.Context(work_item,ticket),process=new Workflow.Context(_process,ticket),res1=eval(expression);if(trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"in flow expression",veda.Util.toJson(expression)+", res ="+veda.Util.toJson(res1)),!0===res1){const e=get_individual(ticket,veda.Util.getUri(flowsInto));if(e){const t=Workflow.create_work_item(ticket,forProcess_uri,e["@"],work_item["@"],_event_id,trace_journal_uri);workItemList.push({data:t,type:"Uri"})}if("v-wf:XOR"==split)break}}catch(e){trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"in flow expression",veda.Util.toJson(expression)+", ",veda.Util.toJson(e.stack)),print(e.stack)}}else if(!split||"v-wf:None"==split){const e=get_individual(ticket,veda.Util.getUri(flowsInto));if(e){const t=Workflow.create_work_item(ticket,forProcess_uri,e["@"],work_item["@"],_event_id,trace_journal_uri);workItemList.push({data:t,type:"Uri"})}}}}work_item["v-wf:isCompleted"]=[{data:!0,type:"Boolean"}],workItemList.length>0&&(work_item["v-wf:workItemList"]=workItemList),task_output_vars.length>0&&(work_item["v-wf:outVars"]=task_output_vars),put_individual(ticket,work_item,_event_id),Workflow.remove_empty_branches_from_journal(journal_uri)}}catch(e){print(e.stack)}},Workflow.prepare_work_item=function(ticket,document){const work_item=document;try{const forProcess=veda.Util.getUri(work_item["v-wf:forProcess"]),_process=get_individual(ticket,forProcess);if(!_process)return;const instanceOf=veda.Util.getUri(_process["v-wf:instanceOf"]),_net=get_individual(ticket,instanceOf);if(!_net)return;const forNetElement=document["v-wf:forNetElement"],netElement=get_individual(ticket,veda.Util.getUri(forNetElement));if(!netElement)return;let trace_journal_uri;const isCompleted=document["v-wf:isCompleted"];if(isCompleted&&!0===isCompleted[0].data)return trace_journal_uri=Workflow.get_trace_journal(document,_process),trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"prepare_work_item:completed, exit",work_item["@"]),void Workflow.remove_empty_branches_from_journal(veda.Util.getJournalUri(work_item["@"]));trace_journal_uri=Workflow.create_new_trace_subjournal(forProcess,work_item,netElement["@"]+"' - ["+veda.Util.getValues(netElement["rdfs:label"])+"] - "+work_item["@"],"v-wf:WorkItemStarted");const f_join=netElement["v-wf:join"];if(f_join&&"v-wf:AND"==veda.Util.getUri(f_join)){const e=[],t={},i=_net["v-wf:consistsOf"];if(i)for(let r=0;r<i.length;r++){const n=get_individual(ticket,i[r].data);if(n)if(veda.Util.hasValue(n,"rdf:type",{data:"v-wf:Flow",type:"Uri"}))veda.Util.getUri(n["v-wf:flowsInto"])==netElement["@"]&&e.push(n);else if(veda.Util.hasValue(n,"rdf:type",{data:"v-wf:Task",type:"Uri"})){const e=n["v-wf:hasFlow"];if(e)for(let i=0;i<e.length;i++)t[e[i].data]=n["@"]}}const r=Workflow.find_in_work_item_tree(ticket,_process,"v-wf:forNetElement",veda.Util.getUri(forNetElement));if(r.length>e.length&&print("ERR! AND join: check v-wf:consistsOf in net["+instanceOf+"] for net element ["+veda.Util.getUri(forNetElement)+"]"),r.length!=e.length)return;let n=0,o;for(let i=0;i<e.length;i++){const a=t[e[i]["@"]];for(let e=0;e<r.length;e++){const t=veda.Util.getUri(r[e].parent["v-wf:forNetElement"]);if(o=r[e].work_item["v-s:isExecuted"],o)return;if(a==t){n++;break}}}if(n!=e.length)return}document["v-s:isExecuted"]=veda.Util.newBool(!0),put_individual(ticket,document,_event_id);let is_completed=!1;const workItemList=[];let is_goto_to_next_task=!1,task_output_vars=[],journal_uri;if(veda.Util.hasValue(netElement,"rdf:type",{data:"v-wf:Task",type:"Uri"})){journal_uri=Workflow.create_new_subjournal(forProcess,work_item["@"],netElement["rdfs:label"],"v-wf:WorkItemStarted"),trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"Is task");let work_item__inVars=[];netElement["v-wf:startingMapping"]&&(work_item__inVars=Workflow.create_and_mapping_variables(ticket,netElement["v-wf:startingMapping"],_process,document,null,null,!0,trace_journal_uri,"v-wf:startingMapping"),work_item__inVars.length>0&&(document["v-wf:inVars"]=work_item__inVars));const executor_list=[],f_subNet=netElement["v-wf:subNet"],f_executor=netElement["v-wf:executor"];if(f_executor)for(let i=0;i<f_executor.length;i++){const executor=get_individual(ticket,f_executor[i].data);if(executor)if(veda.Util.hasValue(executor,"rdf:type",{data:"v-wf:ExecutorDefinition",type:"Uri"})){const expression=veda.Util.getFirstValue(executor["v-wf:executorExpression"]);if(!expression)return;const task=new Workflow.Context(document,ticket),process=new Workflow.Context(_process,ticket);try{const result=eval(expression);if(trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"определение исполнителя ["+expression+"]","executors="+veda.Util.toJson(result)),void 0!==result&&result.length>0)for(let e=0;e<result.length;e++){const t=get_individual(ticket,result[e].data);t&&executor_list.push(result[e])}}catch(e){trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"исполнители не были определены ["+expression+"]",e.stack)}}else trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"установлен исполнитель ","executor="+veda.Util.toJson(f_executor[i].data)),executor_list.push(f_executor[i]);else trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"исполнитель не найден"," uri=["+f_executor[i].data+"]")}else f_subNet&&executor_list.push(f_subNet[0]);0==executor_list.length?executor_list.push(null):Workflow.mapToJournal(netElement["v-wf:startingJournalMap"],ticket,_process,document,null,netElement["rdfs:label"],journal_uri);const work_order_list=[],work_order_uri_list=[];for(let e=0;e<executor_list.length;e++){const t=veda.Util.genUri()+"-wo",i={"@":t,"rdf:type":[{data:"v-wf:WorkOrder",type:"Uri"}],"v-wf:forWorkItem":[{data:document["@"],type:"Uri"}]};f_subNet&&(i["v-wf:useSubNet"]=f_subNet),trace_journal_uri&&(i["v-wf:isTrace"]=veda.Util.newBool(!0)),null!=executor_list[e]&&(i["v-wf:executor"]=executor_list[e]),work_order_list.push(i),work_order_uri_list.push({data:t,type:"Uri"})}work_order_uri_list.length>0&&(document["v-wf:workOrderList"]=work_order_uri_list),(work_item__inVars>0||work_order_uri_list.length>0)&&put_individual(ticket,document,_event_id);for(let e=0;e<work_order_list.length;e++)put_individual(ticket,work_order_list[e],_event_id)}else if(veda.Util.hasValue(netElement,"rdf:type",{data:"v-wf:InputCondition",type:"Uri"})||veda.Util.hasValue(netElement,"rdf:type",{data:"v-wf:Condition",type:"Uri"})){if("s-wf:InterlayerNet_ic"==netElement["@"]){const e={"@":_process["v-wf:executor"][0].data};e["v-wf:hasStatusWorkflow"]=veda.Util.newUri("v-wf:IsSent"),set_in_individual(ticket,e,_event_id)}is_goto_to_next_task=!0}else if(veda.Util.hasValue(netElement,"rdf:type",{data:"v-wf:OutputCondition",type:"Uri"})){if(trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"Is output condition ",""),"s-wf:InterlayerNet_oc"==netElement["@"]){const e={"@":_process["v-wf:executor"][0].data};e["v-wf:hasStatusWorkflow"]=veda.Util.newUri("v-wf:Completed"),set_in_individual(ticket,e,_event_id)}const e=_process["v-wf:parentWorkOrder"];if(e){const t=get_individual(ticket,veda.Util.getUri(e));t&&(_net["v-wf:completedMapping"]?task_output_vars=Workflow.create_and_mapping_variables(ticket,_net["v-wf:completedMapping"],_process,work_item,null,null,!0,trace_journal_uri,"v-wf:completedMapping"):task_output_vars.push({data:"v-wf:complete",type:"Uri"}),task_output_vars.length>0&&(t["v-wf:outVars"]=task_output_vars,put_individual(ticket,t,_event_id)))}is_completed=!0,document["v-wf:isCompleted"]=[{data:is_completed,type:"Boolean"}];const t={"@":forProcess,"v-wf:isCompleted":[{data:is_completed,type:"Boolean"}]};veda.Codelet.complete_process(ticket,_process,_event_id),set_in_individual(ticket,t,_event_id)}if(1==is_goto_to_next_task){const hasFlows=netElement["v-wf:hasFlow"];if(hasFlows)for(let i=0;i<hasFlows.length;i++){const flow=get_individual(ticket,hasFlows[i].data);if(!flow)continue;const flowsInto=flow["v-wf:flowsInto"];if(!flowsInto)continue;let resultEval=!0;try{const predicate=flow["v-wf:predicate"];if(predicate){const expression=veda.Util.getFirstValue(predicate),task=new Workflow.Context(work_item,ticket),process=new Workflow.Context(_process,ticket);resultEval=eval(expression)}}catch(e){print(e.stack)}if(!resultEval)continue;const nextNetElement=get_individual(ticket,veda.Util.getUri(flowsInto));if(!nextNetElement)continue;const work_item_uri=Workflow.create_work_item(ticket,forProcess,nextNetElement["@"],document["@"],_event_id,trace_journal_uri);workItemList.push({data:work_item_uri,type:"Uri"}),document["v-wf:isCompleted"]=veda.Util.newBool(!0),document["v-s:isExecuted"]=veda.Util.newBool(!1),document["v-s:created"]=veda.Util.newDate(new Date),is_completed=!0}}workItemList.length>0&&(document["v-wf:workItemList"]=workItemList),(1==is_completed||workItemList.length>0)&&put_individual(ticket,document,_event_id)}catch(e){print(e.stack)}},Workflow.prepare_process=function(e,t){const i=veda.Util.hasValue(t,"v-s:deleted");if(veda.Util.hasValue(t,"v-wf:isCompleted")||i)return;const r=t,n=Workflow.get_trace_journal(t,r);n&&veda.Util.traceToJournal(e,n,"prepare_process",t["@"]);const o=r["v-wf:inVars"]||[],a=veda.Util.getUri(t["v-wf:instanceOf"]),s=get_individual(e,a);if(!s)return;const l=s["v-wf:localVariable"];if(l)for(let i=0;i<l.length;i++){const r=get_individual(e,l[i].data);if(!r)continue;const n=veda.Util.getUri(r["v-wf:varDefineScope"]);if(n&&"v-wf:Net"===n){const i=Workflow.generate_variable(e,r,null,t,null,null);i&&(put_individual(e,i,_event_id),o.push({data:i["@"],type:"Uri"}))}}const d=[],c=s["v-wf:consistsOf"];if(c)for(let i=0;i<c.length;i++){const r=c[i].data,o=get_individual(e,r);if(o){if(veda.Util.hasValue(o,"rdf:type",{data:"v-wf:InputCondition",type:"Uri"})){const i=Workflow.create_work_item(e,t["@"],r,null,_event_id,n);d.push({data:i,type:"Uri"});break}}else print("NET ELEMENT UNDFINED:",r)}o.length>0&&(t["v-wf:inVars"]=o),d.length>0&&(t["v-wf:workItemList"]=d),t["v-wf:isCompleted"]=veda.Util.newBool(!1),(o.length>0||d.length>0)&&put_individual(e,t,_event_id)},Workflow.prepare_start_form=function(e,t){let i,r;if(t["v-wf:processedDocument"]){i=t["v-wf:processedDocument"][0].data,r=t["v-wf:processedDocument"];const n=get_individual(e,i);veda.Util.hasValue(n,"rdf:type",{data:"v-wf:DecisionForm",type:"Uri"})&&(i=n["v-wf:onDocument"]?n["v-wf:onDocument"][0].data:n["@"],r=n["v-wf:onDocument"]||[{data:t["@"],type:"Uri"}],t["v-wf:processedDocument"]=r,t["v-wf:hasParentTask"]=[{data:n["@"],type:"Uri"}],n["v-wf:hasChildTask"]=(n["v-wf:hasChildTask"]||[]).concat(veda.Util.newUri(t["@"])),put_individual(e,n,_event_id))}else i=t["@"],r=[{data:t["@"],type:"Uri"}];let n=t["v-wf:isTrace"];n=!(!n||1!=veda.Util.getFirstValue(n));const o=t["v-wf:hasStatusWorkflow"];if(!o)return;if("v-wf:ToBeSent"!=veda.Util.getUri(o))return void print("[WORKFLOW]:prepare_start_form, not ready to start.");if(t["v-wf:isProcess"])return void print("[WORKFLOW]:prepare_start_form, already started.");veda.Util.hasValue(t,"v-wf:processedDocument")&&veda.Util.addToGroup(e,veda.Util.getUri(t["v-wf:processedDocument"]),t["@"],["v-s:canRead"]);const a=veda.Util.genUri()+"-prs",s=t["v-s:creator"];let l;if(veda.Util.hasValue(t,"v-s:creator")){const i=t["v-s:creator"][0].data,r=get_individual(e,i);veda.Util.hasValue(r,"v-s:employee")&&(l=r["v-s:employee"][0].data)}const d=t["v-wf:forNet"],c=get_individual(e,veda.Util.getUri(d));if(!c)return;const u=[],f=veda.Util.getUri(t["v-wf:useTransformation"]);if(print("@js transform_link=",f),f){const i=get_individual(e,f);if(!i)return;const r=veda.Util.transformation(e,t,i,null,null,veda.Util.newUri(a));for(let t=0;t<r.length;t++)put_individual(e,r[t],_event_id),u.push({data:r[t]["@"],type:"Uri"})}const p={"@":a,"rdf:type":veda.Util.newUri("v-wf:Process"),"v-wf:instanceOf":d};let v;p["rdfs:label"]=[{data:"экземпляр маршрута :"+veda.Util.getFirstValue(c["rdfs:label"]),type:"String"}],n&&(p["v-wf:isTrace"]=veda.Util.newBool(!0)),u.length>0&&(p["v-wf:inVars"]=u),p["v-wf:hasStartForm"]=veda.Util.newUri(t["@"]),n&&(v=Workflow.create_new_journal(e,veda.Util.getTraceJournalUri(a),veda.Util.getJournalUri(i),c["rdfs:label"],!0),v&&(veda.Util.traceToJournal(e,v,"started new process",veda.Util.toJson(p)),p["v-wf:traceJournal"]=veda.Util.newUri(v))),put_individual(e,p,_event_id);const h=veda.Util.getJournalUri(i);if(!get_individual(e,h)){const t={"@":h,"rdf:type":veda.Util.newUri("v-s:Journal"),"v-s:onDocument":r,"v-s:created":[{data:new Date,type:"Datetime"}]};put_individual(e,t,_event_id)}Workflow.create_new_journal(e,veda.Util.getJournalUri(a),h,c["rdfs:label"]);const _=veda.Util.genUri()+"-psr",g={"@":_,"rdf:type":veda.Util.newUri("v-s:ProcessStarted"),"v-s:processJournal":veda.Util.newUri(veda.Util.getJournalUri(a)),"v-wf:onProcess":veda.Util.newUri(a),"v-s:onDocument":r,"v-s:created":[{data:new Date,type:"Datetime"}]};s&&(g["v-s:actor"]=s),put_individual(e,g,_event_id);const m={"@":veda.Util.genUri()+"-mbh","rdf:type":veda.Util.newUri("v-s:Membership"),"v-s:resource":veda.Util.newUri(a),"v-s:memberOf":r,"rdfs:comment":veda.Util.newStr("Process is in document group")};put_individual(e,m,_event_id),add_to_individual(e,{"@":i+"j","v-s:childRecord":veda.Util.newUri(_)},_event_id),t["v-wf:hasStatusWorkflow"]=veda.Util.newUri("v-wf:IsSent"),t["v-wf:hasStartForm"]=veda.Util.newUri(t["@"]),t["v-wf:isProcess"]=(t["v-wf:isProcess"]||[]).concat(veda.Util.newUri(a)),put_individual(e,t,_event_id),l&&veda.Util.addRight(e,l,a,["v-s:canRead","v-s:canUpdate","v-s:canDelete"]),veda.Util.addRight(e,"v-wf:WorkflowReadUser",a,["v-s:canRead"])};var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t,i){return e(i={path:t,exports:{},require:function(e,t){return commonjsRequire(e,null==t?i.path:t)}},i.exports),i.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var mustache=createCommonjsModule((function(e,t){e.exports=function(){
/*!
     * mustache.js - Logic-less {{mustache}} templates with JavaScript
     * http://github.com/janl/mustache.js
     */
var e=Object.prototype.toString,t=Array.isArray||function(t){return"[object Array]"===e.call(t)};function i(e){return"function"==typeof e}function r(e){return t(e)?"array":typeof e}function n(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(e,t){return null!=e&&"object"==typeof e&&t in e}function a(e,t){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(t)}var s=RegExp.prototype.test;function l(e,t){return s.call(e,t)}var d=/\S/;function c(e){return!l(d,e)}var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function f(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return u[e]}))}var p=/\s*/,v=/\s+/,h=/\s*=/,_=/\s*\}/,g=/#|\^|\/|>|\{|&|=|!/;function m(e,i){if(!e)return[];var r,o,a,s=!1,l=[],d=[],u=[],f=!1,m=!1,y="",b=0;function S(){if(f&&!m)for(;u.length;)delete d[u.pop()];else u=[];f=!1,m=!1}function j(e){if("string"==typeof e&&(e=e.split(v,2)),!t(e)||2!==e.length)throw new Error("Invalid tags: "+e);r=new RegExp(n(e[0])+"\\s*"),o=new RegExp("\\s*"+n(e[1])),a=new RegExp("\\s*"+n("}"+e[1]))}j(i||O.tags);for(var I,$,C,x,V,P,E=new U(e);!E.eos();){if(I=E.pos,C=E.scanUntil(r))for(var B=0,D=C.length;B<D;++B)c(x=C.charAt(B))?(u.push(d.length),y+=x):(m=!0,s=!0,y+=" "),d.push(["text",x,I,I+1]),I+=1,"\n"===x&&(S(),y="",b=0,s=!1);if(!E.scan(r))break;if(f=!0,$=E.scan(g)||"name",E.scan(p),"="===$?(C=E.scanUntil(h),E.scan(h),E.scanUntil(o)):"{"===$?(C=E.scanUntil(a),E.scan(_),E.scanUntil(o),$="&"):C=E.scanUntil(o),!E.scan(o))throw new Error("Unclosed tag at "+E.pos);if(V=">"==$?[$,C,I,E.pos,y,b,s]:[$,C,I,E.pos],b++,d.push(V),"#"===$||"^"===$)l.push(V);else if("/"===$){if(!(P=l.pop()))throw new Error('Unopened section "'+C+'" at '+I);if(P[1]!==C)throw new Error('Unclosed section "'+P[1]+'" at '+I)}else"name"===$||"{"===$||"&"===$?m=!0:"="===$&&j(C)}if(S(),P=l.pop())throw new Error('Unclosed section "'+P[1]+'" at '+E.pos);return k(w(d))}function w(e){for(var t,i,r=[],n=0,o=e.length;n<o;++n)(t=e[n])&&("text"===t[0]&&i&&"text"===i[0]?(i[1]+=t[1],i[3]=t[3]):(r.push(t),i=t));return r}function k(e){for(var t,i=[],r=i,n=[],o=0,a=e.length;o<a;++o)switch((t=e[o])[0]){case"#":case"^":r.push(t),n.push(t),r=t[4]=[];break;case"/":n.pop()[5]=t[2],r=n.length>0?n[n.length-1][4]:i;break;default:r.push(t)}return i}function U(e){this.string=e,this.tail=e,this.pos=0}function y(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function b(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}U.prototype.eos=function(){return""===this.tail},U.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var i=t[0];return this.tail=this.tail.substring(i.length),this.pos+=i.length,i},U.prototype.scanUntil=function(e){var t,i=this.tail.search(e);switch(i){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,i),this.tail=this.tail.substring(i)}return this.pos+=t.length,t},y.prototype.push=function(e){return new y(e,this)},y.prototype.lookup=function(e){var t,r=this.cache;if(r.hasOwnProperty(e))t=r[e];else{for(var n,s,l,d=this,c=!1;d;){if(e.indexOf(".")>0)for(n=d.view,s=e.split("."),l=0;null!=n&&l<s.length;)l===s.length-1&&(c=o(n,s[l])||a(n,s[l])),n=n[s[l++]];else n=d.view[e],c=o(d.view,e);if(c){t=n;break}d=d.parent}r[e]=t}return i(t)&&(t=t.call(this.view)),t},b.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},b.prototype.parse=function(e,t){var i=this.templateCache,r=e+":"+(t||O.tags).join(":"),n=void 0!==i,o=n?i.get(r):void 0;return null==o&&(o=m(e,t),n&&i.set(r,o)),o},b.prototype.render=function(e,t,i,r){var n=this.getConfigTags(r),o=this.parse(e,n),a=t instanceof y?t:new y(t,void 0);return this.renderTokens(o,a,i,e,r)},b.prototype.renderTokens=function(e,t,i,r,n){for(var o,a,s,l="",d=0,c=e.length;d<c;++d)s=void 0,"#"===(a=(o=e[d])[0])?s=this.renderSection(o,t,i,r,n):"^"===a?s=this.renderInverted(o,t,i,r,n):">"===a?s=this.renderPartial(o,t,i,n):"&"===a?s=this.unescapedValue(o,t):"name"===a?s=this.escapedValue(o,t,n):"text"===a&&(s=this.rawValue(o)),void 0!==s&&(l+=s);return l},b.prototype.renderSection=function(e,r,n,o,a){var s=this,l="",d=r.lookup(e[1]);function c(e){return s.render(e,r,n,a)}if(d){if(t(d))for(var u=0,f=d.length;u<f;++u)l+=this.renderTokens(e[4],r.push(d[u]),n,o,a);else if("object"==typeof d||"string"==typeof d||"number"==typeof d)l+=this.renderTokens(e[4],r.push(d),n,o,a);else if(i(d)){if("string"!=typeof o)throw new Error("Cannot use higher-order sections without the original template");null!=(d=d.call(r.view,o.slice(e[3],e[5]),c))&&(l+=d)}else l+=this.renderTokens(e[4],r,n,o,a);return l}},b.prototype.renderInverted=function(e,i,r,n,o){var a=i.lookup(e[1]);if(!a||t(a)&&0===a.length)return this.renderTokens(e[4],i,r,n,o)},b.prototype.indentPartial=function(e,t,i){for(var r=t.replace(/[^ \t]/g,""),n=e.split("\n"),o=0;o<n.length;o++)n[o].length&&(o>0||!i)&&(n[o]=r+n[o]);return n.join("\n")},b.prototype.renderPartial=function(e,t,r,n){if(r){var o=this.getConfigTags(n),a=i(r)?r(e[1]):r[e[1]];if(null!=a){var s=e[6],l=e[5],d=e[4],c=a;0==l&&d&&(c=this.indentPartial(a,d,s));var u=this.parse(c,o);return this.renderTokens(u,t,r,c,n)}}},b.prototype.unescapedValue=function(e,t){var i=t.lookup(e[1]);if(null!=i)return i},b.prototype.escapedValue=function(e,t,i){var r=this.getConfigEscape(i)||O.escape,n=t.lookup(e[1]);if(null!=n)return"number"==typeof n&&r===O.escape?String(n):r(n)},b.prototype.rawValue=function(e){return e[1]},b.prototype.getConfigTags=function(e){return t(e)?e:e&&"object"==typeof e?e.tags:void 0},b.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!t(e)?e.escape:void 0};var O={name:"mustache.js",version:"4.1.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){S.templateCache=e},get templateCache(){return S.templateCache}},S=new b;return O.clearCache=function(){return S.clearCache()},O.parse=function(e,t){return S.parse(e,t)},O.render=function(e,t,i,n){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+r(e)+'" was given as the first argument for mustache#render(template, view, partials)');return S.render(e,t,i,n)},O.escape=f,O.Scanner=U,O.Context=y,O.Writer=b,O}()}));const Workflow$1=veda.Workflow||{};veda.Workflow=Workflow$1,Workflow$1.create_work_item=function(e,t,i,r,n,o){try{const a=veda.Util.genUri()+"-wit",s={"@":a,"rdf:type":[{data:"v-wf:WorkItem",type:"Uri"}],"v-wf:forProcess":[{data:t,type:"Uri"}],"v-wf:forNetElement":[{data:i,type:"Uri"}],"v-s:created":[{data:new Date,type:"Datetime"}],"v-s:creator":[{data:"cfg:VedaSystem",type:"Uri"}]};return o&&(s["v-wf:isTrace"]=veda.Util.newBool(!0)),null!==r&&(s["v-wf:previousWorkItem"]=[{data:r,type:"Uri"}]),put_individual(e,s,n),a}catch(e){print(e.stack)}},Workflow$1.WorkItemResult=function(e){this.work_item_result=e,this.getValue=function(e){for(const t in this.work_item_result)if(Object.hasOwnProperty.call(this.work_item_result,t))return this.work_item_result[t][e]},this.compare=function(e,t){if(!t||t.length<1)return!1;if(!this.work_item_result||0==this.work_item_result.length)return!1;let i=0;for(const r in this.work_item_result)if(Object.hasOwnProperty.call(this.work_item_result,r)){const n=this.work_item_result[r][e];if(n&&n.length==t.length)for(const e in n)if(Object.hasOwnProperty.call(n,e)){for(const r in t)n[e].data==t[r].data&&n[e].type==t[r].type&&i++;if(i==t.length)return!0}}return!1},this.is_exists_result=function(){if(!this.work_item_result||this.work_item_result.length<1)return!1;for(let e=0;e<this.work_item_result.length;e++)if(this.work_item_result[e].result)return!0;return!1},this.is_all_executors_taken_decision=function(e,t){if(!t||t.length<1)return!1;let i=0;for(let r=0;r<this.work_item_result.length;r++){const n=this.work_item_result[r][e];n&&n.length>0&&n[0].data==t[0].data&&n[0].type==t[0].type&&i++}return i==this.work_item_result.length},this.is_some_executor_taken_decision=function(e,t){if(!t||t.length<1)return!1;for(let i=0;i<this.work_item_result.length;i++){const r=this.work_item_result[i][e];if(r&&r.length>0&&r[0].data==t[0].data&&r[0].type==t[0].type)return!0}return!1}},Workflow$1.is_some_content_value=function(e,t){for(let i=0;i<e.length;i++)for(let r=0;r<t.length;r++)if(e[i].type==t[r].type&&e[i].data==t[r].data)return!0;return!1},Workflow$1.Context=function(e,t){this.src_data=e,this.ticket=t,this.getDecisionForms=function(){return this.src_data["v-wf:decisionFormList"]},this.getExecutor=function(){return this.src_data["v-wf:executor"]},this.getLabel=function(){return this.src_data["rdfs:label"]},this.get_results=function(){return this.src_data},this.if_all_executors_taken_decision=function(e,t){try{let i=0;for(let t=0;t<this.src_data.length;t++)this.src_data[t].result==e&&i++;return i==this.src_data.length?[{data:e,type:"Uri"}]:[{data:t,type:"Uri"}]}catch(e){return print(e.stack),!1}},this.getInputVariable=function(e){return this.getVariableValueIO(e,"v-wf:inVars")},this.getLocalVariable=function(e){return this.getVariableValueIO(e,"v-wf:localVars")},this.getOutVariable=function(e){return this.getVariableValueIO(e,"v-wf:outVars")},this.getVariableValueIO=function(e,t){try{const i=this.src_data[t];if(i)for(let t=0;t<i.length;t++){const r=get_individual(this.ticket,i[t].data);if(!r)continue;if(veda.Util.getFirstValue(r["v-wf:variableName"])==e){return r["v-wf:variableValue"]}}}catch(e){return print(e.stack),!1}},this.print_variables=function(e){try{const t=this.src_data[e];if(t)for(let e=0;e<t.length;e++){get_individual(this.ticket,t[e].data)}}catch(e){return print(e.stack),!1}},this.get_result_value=function(e,t){try{if(this.src_data&&this.src_data.length>0){const i=this.src_data[0][e];return i?[{data:i,type:t}]:null}}catch(e){return print(e.stack),!1}}},Workflow$1.get_new_variable=function(e,t){try{const i={"@":veda.Util.genUri()+"-var","rdf:type":[{data:"v-wf:Variable",type:"Uri"}],"v-wf:variableName":[{data:e,type:"String"}],"v-s:created":[{data:new Date,type:"Datetime"}]};return t&&(i["v-wf:variableValue"]=t),i}catch(e){throw print(e.stack),e}},Workflow$1.store_items_and_set_minimal_rights=function(e,t){try{const i=[];for(let r=0;r<t.length;r++)null==t[r]["v-s:created"]?t[r]["v-s:created"]=veda.Util.newDate(new Date):t[r]["v-s:edited"]=veda.Util.newDate(new Date),null==t[r]["v-s:creator"]&&(t[r]["v-s:creator"]=veda.Util.newUri("cfg:VedaSystem")),put_individual(e,t[r],_event_id),i.push({data:t[r]["@"],type:"Uri"}),veda.Util.addRight(e,"v-wf:WorkflowReadUser",t[r]["@"],["v-s:canRead"]);return i}catch(e){print(e.stack)}},Workflow$1.generate_variable=function(e,t,i,r,n,o){try{const n=veda.Util.getFirstValue(t["v-wf:varDefineName"]),o=Workflow$1.get_new_variable(n,i),a=veda.Util.getUri(t["v-wf:varDefineScope"]);if(a){let t;if("v-wf:Net"==a&&(t=r["@"]),t){o["v-wf:variableScope"]=[{data:t,type:"Uri"}];let a,s=r["v-wf:localVars"];if(s){for(let t=0;t<s.length;t++){const i=get_individual(e,s[t].data);if(!i)continue;const r=veda.Util.getFirstValue(i["v-wf:variableName"]);if(r&&r==n){a=i;break}}a&&(a["v-wf:variableValue"]=i,put_individual(e,a,_event_id))}else s=[];if(!a){const t=Workflow$1.get_new_variable(n,i);put_individual(e,t,_event_id);const o={"@":r["@"],"v-wf:localVars":[{data:t["@"],type:"Uri"}]};add_to_individual(e,o,_event_id),s.push(veda.Util.newUri(t["@"])[0]),r["v-wf:localVars"]=s}}}return o}catch(e){throw print(e.stack),e}},Workflow$1.create_and_mapping_variables=function(ticket,mapping,_process,_task,_order,_task_result,f_store,trace_journal_uri,trace_comment){try{const _trace_info=[],new_vars=[];if(!mapping)return[];let process,task,order,task_result;_process&&(process=new Workflow$1.Context(_process,ticket)),_task&&(task=new Workflow$1.Context(_task,ticket)),_order&&(order=new Workflow$1.Context(_order,ticket)),_task_result&&(task_result=new Workflow$1.WorkItemResult(_task_result));for(let i=0;i<mapping.length;i++){const map=get_individual(ticket,mapping[i].data);if(map){const expression=veda.Util.getFirstValue(map["v-wf:mappingExpression"]);if(!expression)continue;try{const res1=eval(expression);if(!res1)continue;const mapToVariable_uri=veda.Util.getUri(map["v-wf:mapToVariable"]);if(!mapToVariable_uri)continue;const def_variable=get_individual(ticket,mapToVariable_uri);if(!def_variable)continue;const new_variable=Workflow$1.generate_variable(ticket,def_variable,res1,_process,_task,_task_result);new_variable&&(1==f_store?(put_individual(ticket,new_variable,_event_id),trace_journal_uri&&_trace_info.push(new_variable),new_vars.push({data:new_variable["@"],type:"Uri"})):new_vars.push(new_variable))}catch(e){trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables","err: expression: "+expression+"\n"+e.stack)}}else trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables","map not found :"+mapping[i].data)}return trace_journal_uri&&veda.Util.traceToJournal(ticket,trace_journal_uri,"create_and_mapping_variables",trace_comment+" = '"+veda.Util.getUris(mapping)+"' \n\nout = \n"+veda.Util.toJson(_trace_info)),new_vars}catch(e){return print(e.stack),[]}},Workflow$1.find_in_work_item_tree=function(e,t,i,r){try{const n=[],o=t["v-wf:workItemList"];return o&&Workflow$1.rsffiwit(e,o,i,r,n,t),n}catch(e){print(e.stack)}},Workflow$1.rsffiwit=function(e,t,i,r,n,o){try{for(let a=0;a<t.length;a++){const s=get_individual(e,t[a].data);if(s){const t=s[i],a=s["v-wf:isCompleted"];t&&veda.Util.getUri(t)==r&&!a&&n.push({parent:o,work_item:s});const l=s["v-wf:workItemList"];l&&Workflow$1.rsffiwit(e,l,i,r,n,s)}}}catch(e){print(e.stack)}},Workflow$1.create_new_journal=function(e,t,i,r,n){try{if(!get_individual(e,t)){const o={"@":t,"rdf:type":[{data:"v-s:Journal",type:"Uri"}],"v-s:created":[{data:new Date,type:"Datetime"}]};i&&(Workflow$1.create_new_journal(e,i,null,"",n),o["v-s:parentJournal"]=veda.Util.newUri(i)),r&&(o["rdfs:label"]=r),n&&(o["v-wf:isTrace"]=veda.Util.newBool(!0)),put_individual(e,o,_event_id)}return t}catch(e){print(e.stack)}},Workflow$1.mapToJournal=function(e,t,i,r,n,o,a,s,l){try{if(a&&e){let d=[];if(r&&o&&(r["rdfs:label"]=o),d=Workflow$1.create_and_mapping_variables(t,e,i,r,n,null,!1,s,l),d){const e=veda.Util.newJournalRecord(a);for(let t=0;t<d.length;t++){const i=d[t],r=veda.Util.getFirstValue(i["v-wf:variableName"]),n=i["v-wf:variableValue"];e[r]=n}veda.Util.logToJournal(t,a,e)}}}catch(e){print(e.stack)}},Workflow$1.getAppName=function(){const e=get_individual(ticket,"v-s:vedaInfo");return e?veda.Util.getFirstValue(e["rdfs:label"]):""},Workflow$1.mapToMessage=function(e,t,i,r,n,o,a,s,l){try{if(a&&e){i["@"];let o=[];if(o=Workflow$1.create_and_mapping_variables(t,e,i,r,n,null,!1,s,l),o){const e={"@":veda.Util.genUri()+"-msg","v-s:created":[{data:new Date,type:"Datetime"}]};let i;for(let r=0;r<o.length;r++){const n=o[r],a=veda.Util.getFirstValue(n["v-wf:variableName"]),s=n["v-wf:variableValue"];"$template"==a&&(i=get_individual(t,veda.Util.getUri(s))),a.indexOf(":")>0&&(e[a]=s)}if(i){let r=i["v-s:notificationLanguage"];const a=veda.Util.getFirstValue(i["v-s:notificationSubject"]),s=veda.Util.getFirstValue(i["v-s:notificationBody"]);if(r){const e=get_individual(t,r);r=e&&e["rdf:value"]?veda.Util.getFirstValue(e["rdf:value"]).toLowerCase():"RU"}else r="RU";const l={app_name:Workflow$1.getAppName};for(let e=0;e<o.length;e++){const i=o[e],n=veda.Util.getFirstValue(i["v-wf:variableName"]);if("$template"==n||n.indexOf(":")>0)continue;const a=i["v-wf:variableValue"],s=[];for(const e in a)if(Object.hasOwnProperty.call(a,e)){let i=a[e];if("Uri"==i.type){const e=get_individual(t,i.data);if(null==e){s.push("ERR! individual ["+i.data+"] not found, var.name="+n);continue}if(null==e["rdfs:label"]){s.push("ERR! individual ["+i.data+"] not contains rdfs:label, var.name="+n);continue}i=veda.Util.getFirstValueUseLang(e["rdfs:label"],r),i||(i=veda.Util.getFirstValue(e["rdfs:label"])),s.push(i)}else{let e="";i.lang!=r&&""!=i.lang&&null!=i.lang&&"NONE"!=i.lang||(e=i.data,s.push(e))}}l[n]=s}const d=mustache.render(a,l).replace(/&#x2F;/g,"/"),c=mustache.render(s,l).replace(/&#x2F;/g,"/");e["v-s:subject"]=veda.Util.newStr(d,r),e["v-s:messageBody"]=veda.Util.newStr(c,r),e["v-wf:onWorkOrder"]=veda.Util.newUri(n["@"]),e["v-s:hasMessageType"]=i["v-s:hasMessageType"],put_individual(t,e,_event_id)}}}}catch(e){print(e.stack)}},Workflow$1.create_new_subjournal=function(e,t,i,r){return Workflow$1._create_new_subjournal(!1,e,t,i,r)},Workflow$1.create_new_trace_subjournal=function(e,t,i,r){const n=t["v-wf:isTrace"];if(!n||n&&0==veda.Util.getFirstValue(n))return;const o=t["@"],a=Workflow$1._create_new_subjournal(!0,e,o,i,r),s={"@":o,"v-wf:traceJournal":veda.Util.newUri(a),"v-s:created":[{data:new Date,type:"Datetime"}]};return add_to_individual(ticket,s,_event_id),a},Workflow$1._create_new_subjournal=function(e,t,i,r,n){let o,a;1==e?(o=veda.Util.getTraceJournalUri(i),a=veda.Util.getTraceJournalUri(t)):(o=veda.Util.getJournalUri(i),a=veda.Util.getJournalUri(t));if(get_individual(ticket,o))return o;Workflow$1.create_new_journal(ticket,o,a,r,e);const s=veda.Util.newJournalRecord(a);return s["rdf:type"]=[{data:n,type:"Uri"}],r&&(Array.isArray(r)?s["rdfs:label"]=r:s["rdfs:label"]=[{data:r,type:"String"}]),s["v-s:subJournal"]=[{data:o,type:"Uri"}],veda.Util.logToJournal(ticket,a,s,!0),put_individual(ticket,s,_event_id),o},Workflow$1.get_trace_journal=function(e,t){const i=e["v-wf:isTrace"];return i&&1==veda.Util.getFirstValue(i)?veda.Util.getTraceJournalUri(t["@"]):void 0},Workflow$1.create_new_subprocess=function(e,t,i,r,n,o,a){try{const s=o["@"];let l;l=t||i,a&&veda.Util.traceToJournal(e,a,"[WO2.4] executor= "+veda.Util.getUri(i)+" used net",veda.Util.getUri(l));const d=get_individual(e,veda.Util.getUri(l));if(d){const c=veda.Util.genUri()+"-prs",u={"@":c,"rdf:type":[{data:"v-wf:Process",type:"Uri"}],"v-wf:instanceOf":l,"v-wf:parentWorkOrder":[{data:s,type:"Uri"}],"v-s:created":[{data:new Date,type:"Datetime"}]};let f="экземпляр маршрута :"+veda.Util.getFirstValue(d["rdfs:label"])+", запущен из "+veda.Util.getFirstValue(r["rdfs:label"]);if(t&&(f+=", для "+veda.Util.getUri(i)),u["rdfs:label"]=[{data:f,type:"String"}],n&&(u["v-wf:inVars"]=n),t&&(u["v-wf:executor"]=i),a){veda.Util.traceToJournal(e,a,"new_process=",veda.Util.getUri(l),veda.Util.toJson(u)),u["v-wf:isTrace"]=veda.Util.newBool(!0);const t=veda.Util.getTraceJournalUri(c);t&&(Workflow$1.create_new_journal(e,t,null,d["rdfs:label"]),u["v-wf:traceJournal"]=veda.Util.newUri(t))}put_individual(e,u,_event_id),Workflow$1.create_new_subjournal(s,c,"запущен подпроцесс","v-wf:SubProcessStarted"),o["v-wf:isProcess"]=[{data:c,type:"Uri"}],put_individual(e,o,_event_id)}}catch(e){print(e.stack)}},Workflow$1.get_properties_chain=function(e,t,i){let r,n=[];if(t.length<1)return n;try{r=get_individual(ticket,veda.Util.getUri(e)),r&&Workflow$1.traversal(r,t,0,n),!i||null!=n&&0!=n.length||(n=i)}catch(e){print(e.stack)}return n},Workflow$1.traversal=function(e,t,i,r){const n=t[i];let o,a,s;for(const e in n)if(Object.hasOwnProperty.call(n,e)){const t=e;"$get"==t&&(o=n[e]),"$go"==t&&(a=n[e]),"$eq"==t&&(s=n[e])}if(a){const n=e[a];for(const e in n)if(Object.hasOwnProperty.call(n,e)){const o=get_individual(ticket,n[e].data);Workflow$1.traversal(o,t,i+1,r)}}if(o){let t=!0;if(s){t=!1;const i=Object.keys(s);if(i){const r=i[0],n=e[r];if(n){const e=s[r];for(const i in n)if(n[i].type==e[0].type&&n[i].data==e[0].data){t=!0;break}}}}else t=!0;if(t&&null!=e){const t=e[o];for(const e in t)Object.hasOwnProperty.call(t,e)&&r.push(t[e])}}},Workflow$1.remove_empty_branches_from_journal=function(e){const t=get_individual(ticket,e);if(t&&!t["v-s:childRecord"]){const i=veda.Util.getUri(t["v-s:parentJournal"]);if(i){const t=get_individual(ticket,i)["v-s:childRecord"];if(t)for(let r=0;r<t.length;r++){const n=t[r].data,o=get_individual(ticket,n);if(o&&veda.Util.getUri(o["v-s:subJournal"])==e){remove_from_individual(ticket,{"@":i,"v-s:childRecord":[{data:n,type:"Uri"}]},_event_id);break}}}}},Workflow$1.getSystemUrl=function(e){const t=get_individual(ticket,e[0].data);let i=!1;t["v-s:origin"]&&"ExternalUser"===t["v-s:origin"][0].data&&(i=!0);const r=i?veda.Util.newUri("cfg:SystemInfoExternal"):veda.Util.newUri("v-s:vedaInfo");return veda.Util.getFirstValue(Workflow$1.get_properties_chain(r,[{$get:"v-s:appUrl"}]))},Workflow$1.getInboxUrl=function(e){const t=get_individual(ticket,e[0].data);let i=!1;t["v-s:origin"]&&"ExternalUser"===t["v-s:origin"][0].data&&(i=!0);const r=i?veda.Util.newUri("cfg:SystemInfoExternal"):veda.Util.newUri("v-s:vedaInfo");return veda.Util.getFirstValue(Workflow$1.get_properties_chain(r,[{$get:"v-wf:appInboxUrl"}]))},Workflow$1.isSubUnitOf=function(e,t,i){if(0==e.length)return!1;print("@@@@@isSubUnitOf run"),i=i||0;const r=get_individual(ticket,e[0].data);return!veda.Util.hasValue(r,"v-s:parentUnit")||i>16?(print("@@@@@isSubUnitOf parentUnit empty"),!1):veda.Util.hasValue(r,"v-s:parentUnit",{data:t,type:"Uri"})?(print("@@@@@isSubUnitOf parentUnit match"),!0):Workflow$1.isSubUnitOf(r["v-s:parentUnit"],t,i+1)};const Numerator={};function getNewValue(ticket,individual,rule,scope){try{return eval(rule["v-s:numerationGetNextValue"][0].data)(ticket,scope)}catch(e){print("getNewValue error",e.stack)}}function getScope(ticket,individual,rule){try{return eval(rule["v-s:numerationScope"][0].data)(ticket,individual)}catch(e){print(e.stack)}}function createScope(e,t){try{const i={"@":t,"rdfs:label":[{data:t,type:"String"}],"rdf:type":[{data:"v-s:NumerationScopeClass",type:"Uri"}]};return put_individual(e,i,_event_id),i}catch(e){print(e.stack)}}function commitValue(e,t,i,r){try{let n=null,o=null;if(t["v-s:numerationCommitedInterval"]){for(const r in t["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(t["v-s:numerationCommitedInterval"],r)){const a=t["v-s:numerationCommitedInterval"][r].data,s=get_individual(e,a);try{if(s["v-s:numerationCommitedIntervalBegin"][0].data<=i&&i<=s["v-s:numerationCommitedIntervalEnd"][0].data)return!1;s["v-s:numerationCommitedIntervalBegin"][0].data==i+1?n=s:s["v-s:numerationCommitedIntervalEnd"][0].data==i-1&&(o=s)}catch(e){print("ERR! intervalUri=",a),print(e.stack)}}if(null!=o&&null!=n){o["rdfs:label"][0].data=o["v-s:numerationCommitedIntervalBegin"][0].data+" - "+n["v-s:numerationCommitedIntervalEnd"][0].data,o["v-s:numerationCommitedIntervalEnd"][0].data=n["v-s:numerationCommitedIntervalEnd"][0].data,put_individual(e,o,r),add_to_individual(e,{"@":n["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);const i=[];for(const e in t["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(t["v-s:numerationCommitedInterval"],e)){const r=t["v-s:numerationCommitedInterval"][e];r.data!=n["@"]&&i.push(r)}t["v-s:numerationCommitedInterval"]=i,put_individual(e,t,r)}else if(null!=o)o["rdfs:label"][0].data=o["v-s:numerationCommitedIntervalBegin"][0].data+" - "+i,o["v-s:numerationCommitedIntervalEnd"][0].data=i,put_individual(e,o,r);else if(null!=n)n["rdfs:label"][0].data=i+" - "+n["v-s:numerationCommitedIntervalEnd"][0].data,n["v-s:numerationCommitedIntervalBegin"][0].data=i,put_individual(e,n,r);else{const n={"@":Util$1.genUri()+"-intv","rdfs:label":[{data:i+" - "+i,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i,type:"Integer"}]};put_individual(e,n,r),t["v-s:numerationCommitedInterval"].push({data:n["@"],type:"Uri"}),put_individual(e,t,r)}}else{const n={"@":Util$1.genUri()+"-intv","rdfs:label":[{data:i+" - "+i,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i,type:"Integer"}]};put_individual(e,n,r),t["v-s:numerationCommitedInterval"]=[{data:n["@"],type:"Uri"}],put_individual(e,t,r)}return!0}catch(e){print(e.stack)}}function revokeValue(e,t,i,r){try{const n=[];for(const o in t["v-s:numerationCommitedInterval"])if(Object.hasOwnProperty.call(t["v-s:numerationCommitedInterval"],o)){const a=t["v-s:numerationCommitedInterval"][o],s=get_individual(e,a.data);if(s["v-s:numerationCommitedIntervalBegin"][0].data==i)s["v-s:numerationCommitedIntervalBegin"][0].data<s["v-s:numerationCommitedIntervalEnd"][0].data?(put_individual(e,{"@":s["@"],"rdfs:label":[{data:i+1+" - "+s["v-s:numerationCommitedIntervalEnd"][0].data,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i+1,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:s["v-s:numerationCommitedIntervalEnd"][0].data,type:"Integer"}]},r),n.push(a)):add_to_individual(e,{"@":s["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);else if(s["v-s:numerationCommitedIntervalEnd"][0].data==i)s["v-s:numerationCommitedIntervalBegin"][0].data<s["v-s:numerationCommitedIntervalEnd"][0].data?(put_individual(e,{"@":s["@"],"rdfs:label":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data+" - "+(i-1),type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i-1,type:"Integer"}]},r),n.push(a)):add_to_individual(e,{"@":s["@"],"v-s:deleted":[{data:!0,type:"Boolean"}]},!1);else if(s["v-s:numerationCommitedIntervalBegin"][0].data<i&&i<s["v-s:numerationCommitedIntervalEnd"][0].data){put_individual(e,{"@":s["@"],"rdfs:label":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data+" - "+(i-1),type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:s["v-s:numerationCommitedIntervalBegin"][0].data,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:i-1,type:"Integer"}]},r),n.push(a);const t={data:Util$1.genUri()+"-intv",type:"Uri"};put_individual(e,{"@":t.data,"rdfs:label":[{data:i+1+" - "+s["v-s:numerationCommitedIntervalEnd"][0].data,type:"String"}],"rdf:type":[{data:"v-s:NumerationCommitedIntervalClass",type:"Uri"}],"v-s:numerationCommitedIntervalBegin":[{data:i+1,type:"Integer"}],"v-s:numerationCommitedIntervalEnd":[{data:s["v-s:numerationCommitedIntervalEnd"][0].data,type:"Integer"}]},r),n.push(t)}else n.push(a)}t["v-s:numerationCommitedInterval"]=n,put_individual(e,t,r)}catch(e){print(e.stack)}}veda.Numerator=Numerator,Numerator.numerate=function(e,t,i,r,n){try{const i=Util$1.hasValue(t,"v-s:deleted",{data:!0,type:"Boolean"}),o=r&&Util$1.hasValue(r,"v-s:deleted",{data:!0,type:"Boolean"});t["rdf:type"]&&t["rdf:type"].length&&t["rdf:type"].forEach((a=>{const s=get_individual(e,a.data);if(!s||!s["v-s:hasNumeration"])return;const l=get_individual(e,s["v-s:hasNumeration"][0].data),d=l["v-s:enumeratedProperty"][0].data;let c=parseInt(t[d]&&t[d].length&&t[d][0].data||0);const u=parseInt(r&&r[d]&&r[d][0].data||0);if(!c||!u||c!==u||i!==o){const o=get_individual(e,l["v-s:hasNumerationRule"][0].data),a=getScope(e,t,o),s=get_individual(e,a)||createScope(e,a);if(c||u){if(!c&&u)t[d]=Util$1.newStr(u.toString()),put_individual(e,t,n);else if(c&&!r)commitValue(e,s,c,n);else if(c&&i)revokeValue(e,s,c,n);else if(c&&u&&c!==u){commitValue(e,s,c,n);const t=getScope(e,r,o),i=get_individual(e,t);revokeValue(e,i,u,n)}}else c=getNewValue(e,t,o,s),commitValue(e,s,c,n),t[d]=Util$1.newStr(c.toString()),put_individual(e,t,n)}}))}catch(e){print(e.stack)}},Numerator.getNextValueSimple=function(e,t,i){if("string"==typeof t)try{t=get_individual(e,t)}catch(e){return""+i}if(void 0===t||!t["v-s:numerationCommitedInterval"]||0===t["v-s:numerationCommitedInterval"].length)return""+i;let r=0;return t["v-s:numerationCommitedInterval"].forEach((t=>{const i=t.data;try{(t=get_individual(e,i))["v-s:numerationCommitedIntervalEnd"][0].data>r&&(r=t["v-s:numerationCommitedIntervalEnd"][0].data)}catch(e){print("ERR! intervalUri = ",i),print(e.stack)}})),""+(r+1)};const Util$2=veda.Util||{};veda.Util=Util$2,Util$2.Sha256=Sha256,Util$2.Mustache=mustache,Util$2.addToGroup=function(e,t,i,r,n){const o={"@":Util$2.genUri()+"-mbh","rdf:type":Util$2.newUri("v-s:Membership"),"v-s:memberOf":Util$2.newUri(t),"v-s:resource":Util$2.newUri(i)};(r||[]).forEach((e=>{o[e]=Util$2.newBool(!0)})),(n||[]).forEach((e=>{o[e]=Util$2.newBool(!1)}));const a=put_individual(e,o);return[o,a]},Util$2.removeFromGroup=function(e,t,i){const r={"@":Util$2.genUri()+"-mbh","rdf:type":Util$2.newUri("v-s:Membership"),"v-s:memberOf":Util$2.newUri(t),"v-s:resource":Util$2.newUri(i),"v-s:deleted":Util$2.newBool(!0)};return[r,put_individual(e,r)]},Util$2.addRight=function(e,t,i,r,n){if(void 0===t||void 0===i){const e=new Error("Util.addRight: INVALID ARGS");return console.log("subj_uri =",t),console.log("obj_uri =",i),void console.log("Error stack:",e.stack)}const o={"@":Util$2.genUri()+"-r","rdf:type":Util$2.newUri("v-s:PermissionStatement"),"v-s:permissionObject":Util$2.newUri(i),"v-s:permissionSubject":Util$2.newUri(t)};(r||[]).forEach((e=>{o[e]=Util$2.newBool(!0)})),(n||[]).forEach((e=>{o[e]=Util$2.newBool(!1)}));const a=put_individual(e,o);return[o,a]},Util$2.clone=function(e){let t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(let i=0,r=e.length;i<r;i++)t[i]=Util$2.clone(e[i]);return t}if(e instanceof Object){t={};for(const i in e)e.hasOwnProperty(i)&&(t[i]=Util$2.clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},Util$2.getPropertyChain=function(...e){let t=e[0];const i=e.length;let r,n,o;for("string"==typeof t&&(t=get_individual(veda.ticket,t)),r=1;r<i;r++){if(n=e[r],Util$2.hasValue(t,n)){if(r===i-1)return t[n].map((e=>e.data));if(o=t[n][0].type,t=t[n][0].data,"Uri"===o){t=get_individual(veda.ticket,t);continue}}return}return t},Util$2.newUri=function(e){return[{data:e,type:"Uri"}]},Util$2.newStr=function(e,t){const i={data:e,type:"String"};return t&&"NONE"!==t&&(i.lang=t),[i]},Util$2.newStrFromBundle=function(e,t,i){i||(i=" ");return e["rdfs:label"][0]+i+t["rdfs:label"][0]},Util$2.newBool=function(e){return[{data:e,type:"Boolean"}]},Util$2.newInt=function(e){return[{data:e,type:"Integer"}]},Util$2.newDecimal=function(e){return[{data:e,type:"Decimal"}]},Util$2.newDate=function(e){return[{data:e,type:"Datetime"}]},Util$2.addDay=function(e,t){e||(e=new Date);try{e.setDate(e.getDate()+t)}catch(e){console.log(e)}return e},Util$2.getValues=function(e){const t=[];if(e)for(const i in e)e.hasOwnProperty(i)&&t.push(e[i].data);return t},Util$2.getUris=function(e){const t=[];if(e)for(const i in e)e.hasOwnProperty(i)&&t.push(e[i].data);return t},Util$2.getStrings=function(e){const t=[];if(e)for(const i in e)e.hasOwnProperty(i)&&t.push(e[i].data);return t},Util$2.getUri=function(e){if(e&&e.length>0)return e[0].data},Util$2.getFirstValue=function(e){if(e&&e.length>0)return"Integer"==e[0].type?parseInt(e[0].data,10):"Datetime"==e[0].type?new Date(e[0].data):e[0].data},Util$2.getFirstValueUseLang=function(e,t){for(const i in e)if(e[i].lang==t)return e[i].data;return null},Util$2.getJournalUri=function(e){return e+"j"},Util$2.getTraceJournalUri=function(e){return e+"t"},Util$2.newJournalRecord=function(e){return{"@":Util$2.genUri()+"-jr","rdf:type":[{data:"v-s:JournalRecord",type:"Uri"}],"v-s:parentJournal":[{data:e,type:"Uri"}],"v-s:created":[{data:new Date,type:"Datetime"}]}},Util$2.logToJournal=function(e,t,i){put_individual(e,i,_event_id);const r={"@":t,"v-s:childRecord":[{data:i["@"],type:"Uri"}]};add_to_individual(e,r,_event_id)},Util$2.traceToJournal=function(e,t,i,r){const n=Util$2.newJournalRecord(t);n["rdf:type"]=[{data:"v-wf:TraceRecord",type:"Uri"}],n["rdfs:label"]=[{data:i,type:"String"}],n["rdfs:comment"]=[{data:r,type:"String"}],Util$2.logToJournal(e,t,n,!0)},Util$2.isTecnicalChange=function(e,t){if(e["v-s:actualVersion"]&&e["v-s:actualVersion"][0].data!=e["@"]&&(t=get_individual(ticket,e["v-s:actualVersion"][0].data)),!t)return!1;for(const i in e)if("@"!==i)if(e[i]&&!t[i]||e[i]&&!t[i]||e[i].length!==t[i].length){if(!Util$2.isTechnicalAttribute(i,t[i]))return!1}else for(const r in e[i])if(e[i][r].data.valueOf()!=t[i][r].data.valueOf()&&!Util$2.isTechnicalAttribute(i,t[i][r].data))return!1;return!0},Util$2.isTechnicalAttribute=function(e,t){return!t&&"v-s:actualVersion"===e||(!t&&"v-s:previousVersion"===e||(!t&&"v-s:nextVersion"===e||"v-wf:hasStatusWorkflow"===e))},Util$2.loadVariablesUseField=function(e,t){const i={};for(const r in t)if(Object.hasOwnProperty.call(t,r)){const n=t[r].data;if(n){const t=get_individual(e,n);if(Util$2.hasValue(t,"rdf:type",{data:"v-s:Variable",type:"Uri"})){const e=Util$2.getFirstValue(t["v-s:variableName"]),r=Util$2.getValues(t["v-s:variableValue"]);i[e]=r}}}return i},Util$2.isAlphaNumeric=function(e){if(!e)return!1;return!!/[a-zA-Z0-9]/.test(e)},Util$2.replace_word=function(e,t,i){let r=e,n=!1;const o=t.indexOf("*"),a=i.indexOf("*");if(o>0&&o>0){t=t.substring(0,o),i=i.substring(0,a);let r,s=e.indexOf(t);if(s>=0){s+=t.length;let o=s,a=e.charAt(o);for(;Util$2.isAlphaNumeric(a);)o++,a=e.charAt(o);o>s&&(r=e.substring(s,o),t+=r,i+=r,n=!0)}}else if(e.length==t.length&&(n=!0),0==n){const i=e.indexOf(t);if(i&&i>=0){print("$replace_word #1 pos=",i);const r=e[i+t.length];print("$replace_word #2 last_ch=["+r+"]"),r&&0==Util$2.isAlphaNumeric(r)&&(print("$replace_word !isAlphaNumeric last_ch=",r),n=!0)}}return n&&(r=e.replace(new RegExp(t,"g"),i)),r},Util$2.create_version=function(e,t,i,r,n){if(!t["v-s:actualVersion"]||t["v-s:actualVersion"][0].data===t["@"]){const o=get_individual(e,r),a=Util$2.getUri(o["v-s:defaultAppointment"])||Util$2.getUri(o["v-s:hasAppointment"])||r,s=Util$2.genUri()+"-vr",l=veda.Util.clone(i);if(l["@"]=s,l["v-s:actualVersion"]=[{data:t["@"],type:"Uri"}],l["v-s:nextVersion"]=[{data:t["@"],type:"Uri"}],veda.Util.hasValue(t,"v-s:previousVersion")&&(l["v-s:previousVersion"]=[{data:t["v-s:previousVersion"][0].data,type:"Uri"}]),l["rdf:type"]=l["rdf:type"].concat([{data:"v-s:Version",type:"Uri"}]),put_individual(e,l,n),veda.Util.addToGroup(e,t["@"],l["@"],["v-s:canRead"]),t["v-s:previousVersion"]){const i=get_individual(e,Util$2.getUri(t["v-s:previousVersion"]));i["v-s:nextVersion"]=[{data:l["@"],type:"Uri"}],put_individual(e,i,n)}t["v-s:actualVersion"]=[{data:t["@"],type:"Uri"}],t["v-s:previousVersion"]=[{data:l["@"],type:"Uri"}],t["v-s:edited"]=[{data:new Date,type:"Datetime"}],t["v-s:lastEditor"]=Util$2.newUri(a),put_individual(e,t,n)}},Util$2.recursiveCall=function(e,t,i,r){t[e["@"]]?print("WARNING! Recursive path "+Util$2.toJson(t)+" > "+e.a):(t[e["@"]]=Object.keys(t).length,e["v-wf:decisionFormList"]&&e["v-wf:decisionFormList"].forEach((e=>{const t=get_individual(i,e.data);t["v-wf:isCompleted"]&&0!=t["v-wf:isCompleted"][0].data||(t["v-s:deleted"]=Util$2.newBool(!0),t["v-wf:isStopped"]=Util$2.newBool(!0),put_individual(i,t,r))})),e["v-wf:workItemList"]&&e["v-wf:workItemList"].forEach((e=>{Util$2.recursiveCall(get_individual(i,e.data),t,i,r)})),e["v-wf:workOrderList"]&&e["v-wf:workOrderList"].forEach((e=>{Util$2.recursiveCall(get_individual(i,e.data),t,i,r)})),e["v-wf:isProcess"]&&e["v-wf:isProcess"].forEach((e=>{const n=get_individual(i,e.data);n["v-wf:isCompleted"]&&0!=n["v-wf:isCompleted"][0].data||(n["v-wf:isStopped"]=Util$2.newBool(!0),put_individual(i,n,r)),Util$2.recursiveCall(n,t,i,r)})))},Util$2.set_err_on_indv=function(e,t,i){const r={"@":Util$2.genUri()+"-err","rdf:type":Util$2.newUri("v-s:BugReport"),"v-s:created":Util$2.newDate(new Date),"rdfs:comment":Util$2.newStr(i),"v-s:errorMessage":Util$2.newStr(e),"v-s:resource":Util$2.newUri(t["@"])};put_individual(ticket,r,_event_id);const n={"@":t["@"],"v-s:hasError":Util$2.newUri(r["@"])};add_to_individual(ticket,n,_event_id),print("ERR! "+i+":"+e)},Util$2.set_field_to_document=function(e,t,i){const r={"@":i};r[e]=t,set_in_individual(ticket,r,_event_id)},Util$2.transformation=function(ticket,individuals,transform,executor,work_order,process){try{const out_data0={};let element;!0!==Array.isArray(individuals)&&(individuals=[individuals]);let rules=transform["v-wf:transformRule"];if(!rules||!rules.length)return;const tmp_rules=[];for(const e in rules)if(Object.hasOwnProperty.call(rules,e)){const t=get_individual(ticket,rules[e].data);if(!t){print("not read rule [",Util$2.toJson(t),"]");continue}tmp_rules.push(t)}rules=tmp_rules;let out_data0_el={};const putFieldOfIndividFromElement=function(e,t){const i=get_individual(ticket,Util$2.getUri(element));if(!i)return;let r;r=out_data0_el[e],r||(r=[]),r.push(i[t]),out_data0_el[e]=r},putFieldOfObject=function(e,t){let i;i=out_data0_el[e],i||(i=[]),i.push(individual[t]),out_data0_el[e]=i},putUri=function(e,t){let i;i=out_data0_el[e],i||(i=[]),i.push({data:t,type:"Uri"}),out_data0_el[e]=i},setUri=function(e,t){out_data0_el[e]=[{data:t,type:"Uri"}]},putString=function(e,t){let i;i=out_data0_el[e],i||(i=[]),i.push({data:t,type:"String"}),out_data0_el[e]=i},setString=function(e,t){const i=[];i.push({data:t,type:"String"}),out_data0_el[e]=i},setDatetime=function(e,t){const i=[];i.push({data:t,type:"Datetime"}),out_data0_el[e]=i},putDatetime=function(e,t){let i;i=out_data0_el[e],i||(i=[]),i.push({data:t,type:"Datetime"}),out_data0_el[e]=i},putBoolean=function(e,t){let i;i=out_data0_el[e],i||(i=[]),i.push({data:t,type:"Boolean"}),out_data0_el[e]=i},setBoolean=function(e,t){const i=[];i.push({data:t,type:"Boolean"}),out_data0_el[e]=i},putInteger=function(e,t){let i=out_data0_el[e];i||(i=[]),i.push({data:t,type:"Integer"}),out_data0_el[e]=i},setInteger=function(e,t){const i=[];i.push({data:t,type:"Integer"}),out_data0_el[e]=i},putExecutor=function(e){let t=out_data0_el[e];if(t||(t=[]),!0===Array.isArray(executor))for(const e in executor)Object.hasOwnProperty.call(executor,e)&&t.push(executor[e]);else t.push(executor);out_data0_el[e]=t},putWorkOrder=function(e){let t=out_data0_el[e];if(t||(t=[]),!0===Array.isArray(work_order))for(const e in work_order)Object.hasOwnProperty.call(work_order,e)&&t.push(work_order[e]);else t.push(work_order);out_data0_el[e]=t},putThisProcess=function(e){let t=out_data0_el[e];if(t||(t=[]),!0===Array.isArray(process))for(const e in process)Object.hasOwnProperty.call(process,e)&&t.push(process[e]);else t.push(process);out_data0_el[e]=t},removeThisProcess=function(e){let t=out_data0_el[e];if(t||(t=[]),!0===Array.isArray(process))for(const e in process)Object.hasOwnProperty.call(process,e)&&(t=t.filter((t=>t.data!==process[e])));else t=t.filter((e=>e.data!==process));out_data0_el[e]=t};for(const key in individuals)if(Object.hasOwnProperty.call(individuals,key)){const individual=individuals[key],objectContentStrValue=function(e,t){if(individual[e]){let i=!1;for(const r in individual[e])t===individual[e][r].data&&(i=!0);return i}},iteratedObject=Object.keys(individual);for(let key2=0;key2<iteratedObject.length;key2++){element=individual[iteratedObject[key2]];const putValue=function(e){let t=out_data0_el[e];if(t||(t=[]),"@"==iteratedObject[key2])t.push({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(const e in element)Object.hasOwnProperty.call(element,e)&&t.push(element[e]);else t.push(element);out_data0_el[e]=t},putValueFrom=function(e,t,i){let r,n,o=out_data0_el[e];o||(o=[]),r=!0===Array.isArray(element)?Util$2.getUri(element):element.data?element.data:element,n=get_individual(ticket,r);for(let e=0;e<t.length-1;e++){if(!n||!n[t[e]])return;const i=Array.isArray(n[t[e]])&&n[t[e]][0].data?n[t[e]][0].data:n[t[e]];n=get_individual(ticket,i)}n&&n[t[t.length-1]]&&(o=o.concat(n[t[t.length-1]]),out_data0_el[e]=o)},putFrontValue=function(e){let t=out_data0_el[e];if(t||(t=[]),"@"==iteratedObject[key2])t.unshift({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(const e in element)Object.hasOwnProperty.call(element,e)&&t.unshift(element[e]);else t.unshift(element);out_data0_el[e]=t},putElement=function(){const e=iteratedObject[key2];if("@"==e)return;let t=[];if(t=out_data0_el[e],t||(t=[]),!0===Array.isArray(element))for(const e in element)Object.hasOwnProperty.call(element,e)&&t.push(element[e]);else t.push(element);out_data0_el[e]=t},contentName=function(e){return iteratedObject[key2]==e},elementContentStrValue=function(e,t){return iteratedObject[key2]===e&&element[0].data==t},getElement=function(){return element};for(const key3 in rules)if(Object.hasOwnProperty.call(rules,key3)){const rule=rules[key3],segregateObject=rule["v-wf:segregateObject"],segregateElement=rule["v-wf:segregateElement"],grouping=rule["v-wf:grouping"];let res,group_key;if(segregateObject&&(res=eval(segregateObject[0].data),0==res))continue;if(segregateElement&&(res=eval(segregateElement[0].data),0==res))continue;if(grouping){let e=!1;for(const t in grouping)if(Object.hasOwnProperty.call(grouping,t)){const i=grouping[t].data;"@"==i?e=!0:group_key=i}out_data0_el=out_data0[group_key],out_data0_el||(out_data0_el={},out_data0_el["@"]=e?individual["@"]:Util$2.genUri()+"-tr")}else out_data0_el={},out_data0_el["@"]=Util$2.genUri()+"-tr";const agregate=rule["v-wf:aggregate"];for(let i2=0;i2<agregate.length;i2++)eval(agregate[i2].data);grouping?out_data0[group_key]=out_data0_el:out_data0[out_data0_el["@"]]=out_data0_el}}}const out_data=[];for(const e in out_data0)Object.hasOwnProperty.call(out_data0,e)&&out_data.push(out_data0[e]);return out_data}catch(e){console.log(e.stack)}};const BPMN={};veda.BPMN=BPMN,BPMN.addToJournal=function(e,t){veda.Backend.get_individual(veda.ticket,e).catch((t=>{throw console.error(`Journal not found: ${e}`),t})).then((()=>veda.Backend.put_individual(veda.ticket,t))).catch((e=>{throw console.error(`Failed to create journal record ${JSON.stringify(t)}`),e})).then((()=>{const i={"@":e,"v-s:childRecord":veda.Util.newUri(t["@"])};return veda.Backend.add_to_individual(veda.ticket,i)})).catch((i=>{throw console.error(`Failed to add record ${JSON.stringify(t)} to journal ${e}`),i}))},BPMN.addToGroup=function(e,t,i){const r="d:"+veda.Util.Sha256.hash("membership"+e+t+i);return veda.Backend.get_individual(veda.ticket,r).catch((()=>{const n={"@":r,"rdf:type":veda.Util.newUri("v-s:Membership"),"v-s:memberOf":veda.Util.newUri(e),"v-s:resource":veda.Util.newUri(t)};return i.toLowerCase().split("").forEach((e=>{let t;switch(e){case"c":t="v-s:canCreate";break;case"r":t="v-s:canRead";break;case"u":t="v-s:canUpdate";break;case"d":t="v-s:canDelete";break;default:return}n[t]=veda.Util.newBool(!0)})),veda.Backend.put_individual(veda.ticket,n)}))},BPMN.addRight=function(e,t,i){const r="d:"+veda.Util.Sha256.hash("permission statement"+e+t+i);return veda.Backend.get_individual(veda.ticket,r).catch((()=>{const n={"@":r,"rdf:type":veda.Util.newUri("v-s:PermissionStatement"),"v-s:permissionSubject":veda.Util.newUri(e),"v-s:permissionObject":veda.Util.newUri(t)};return i.toLowerCase().split("").forEach((e=>{let t;switch(e){case"c":t="v-s:canCreate";break;case"r":t="v-s:canRead";break;case"u":t="v-s:canUpdate";break;case"d":t="v-s:canDelete";break;default:return}n[t]=veda.Util.newBool(!0)})),veda.Backend.put_individual(veda.ticket,n)}))};try{veda.ticket=get_env_str_var("$ticket"),AppModel.call(veda),veda.init("cfg:VedaSystem"),console.log("user:",veda.user.id,"| ticket:",veda.ticket)}catch(e){console.log("Veda init error",e.stack)}return veda}();
