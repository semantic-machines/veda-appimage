{"version":3,"sources":["../../../source-web/js/browser/install_sw.js"],"names":["veda","navigator","HTML","wrapper","document","createElement","id","innerHTML","body","insertBefore","firstChild","serviceWorker","register","scope","window","location","pathname","then","registration","console","log","on","update","reload","error","addEventListener","event","data","ready","active","postMessage","showAddToHomeScreen","installApp","getElementById","installBtn","rejectInstallBtn","style","display","addToHomeScreen","rejectInstall","deferredPrompt","prompt","userChoice","choiceResult","outcome","localStorage","rejectedInstall","e","preventDefault"],"mappings":"yHAEOA,C,gCAEH,iBAAmBC,CAAAA,S,GACfC,C,2yBASAC,C,CAAUC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,C,CAChBF,CAAO,CAACG,EAAR,CAAa,iB,CACbH,CAAO,CAACI,SAAR,CAAoBL,C,CACpBE,QAAQ,CAACI,IAAT,CAAcC,YAAd,CAA2BN,CAA3B,CAAoCC,QAAQ,CAACI,IAAT,CAAcE,UAAlD,C,CAGAT,SAAS,CAACU,aAAV,CAAwBC,QAAxB,CAAiC,eAAjC,CAAkD,CAACC,KAAK,CAAEC,MAAM,CAACC,QAAP,CAAgBC,QAAxB,CAAlD,EACGC,IADH,CACQ,SAACC,CAAD,CAAkB,CAGtB;AAFAC,OAAO,CAACC,GAAR,CAAY,4BAAZ,CAA0CF,CAAY,CAACL,KAAvD,CADsB,CAItBb,CAAI,CAACqB,EAAL,CAAQ,QAAR,CAAkB,UAAY,CAC5BH,CAAY,CAACI,MAAb,YACSH,OAAO,CAACC,GADjB,EAEGH,IAFH,CAEQ,UAAwB,CAC5BH,MAAM,CAACC,QAAP,CAAgBQ,MAAhB,EACD,CAJH,CAKD,CAND,CAOD,CAZH,WAaS,SAACC,CAAD,QAAWL,CAAAA,OAAO,CAACC,GAAR,oCAAwCI,CAAxC,EAAX,CAbT,C,CAgBAvB,SAAS,CAACU,aAAV,CAAwBc,gBAAxB,CAAyC,SAAzC,CAAoD,SAACC,CAAD,CAAW,CAC7DP,OAAO,CAACC,GAAR,yCAA6CM,CAAK,CAACC,IAAnD,EACD,CAFD,C,CAKA1B,SAAS,CAACU,aAAV,CAAwBiB,KAAxB,CAA8BX,IAA9B,CAAmC,SAACC,CAAD,CAAkB,CACnDA,CAAY,CAACW,MAAb,CAAoBC,WAApB,CAAgC,cAAhC,CACD,CAFD,C,CAKMC,C,CAAsB,UAAM,IAC1BC,CAAAA,CAAU,CAAG5B,QAAQ,CAAC6B,cAAT,CAAwB,aAAxB,CADa,CAE1BC,CAAU,CAAG9B,QAAQ,CAAC6B,cAAT,CAAwB,aAAxB,CAFa,CAG1BE,CAAgB,CAAG/B,QAAQ,CAAC6B,cAAT,CAAwB,oBAAxB,CAHO,CAIhCD,CAAU,CAACI,KAAX,CAAiBC,OAAjB,CAA2B,OAJK,CAKhCH,CAAU,CAACT,gBAAX,CAA4B,OAA5B,CAAqCa,CAArC,CALgC,CAMhCH,CAAgB,CAACV,gBAAjB,CAAkC,OAAlC,CAA2Cc,CAA3C,CACD,C,CAEKD,C,CAAkB,UAAM,CAC5B,GAAMN,CAAAA,CAAU,CAAG5B,QAAQ,CAAC6B,cAAT,CAAwB,aAAxB,CAAnB,CACmC;AACV;AADzBD,CAAU,CAACI,KAAX,CAAiBC,OAAjB,CAA2B,MAFC,CAG5BG,CAAc,CAACC,MAAf,EAH4B,CAI5BD,CAAc,CAACE,UAAf,CACGzB,IADH,CACQ,SAAC0B,CAAD,CAAkB,CACO,UAAzB,GAAAA,CAAY,CAACC,OADK,CAEpBzB,OAAO,CAACC,GAAR,CAAY,8BAAZ,CAFoB,CAIpBD,OAAO,CAACC,GAAR,CAAY,+BAAZ,CAJoB,CAMtBoB,CAAc,CAAG,IAClB,CARH,CASD,C,CAEKD,C,CAAgB,UAAM,CAC1B,GAAMP,CAAAA,CAAU,CAAG5B,QAAQ,CAAC6B,cAAT,CAAwB,aAAxB,CAAnB,CACAD,CAAU,CAACI,KAAX,CAAiBC,OAAjB,CAA2B,MAFD,CAG1BQ,YAAY,CAACC,eAAb,GACD,C,CAGDhC,MAAM,CAACW,gBAAP,CAAwB,qBAAxB,CAA+C,SAACsB,CAAD,CAAO,CACpD;AAEA;AADAA,CAAC,CAACC,cAAF,EAFoD,CAIpDR,CAAc,CAAGO,CAJmC,CAK/CF,YAAY,CAACC,eALkC,EAMlDf,CAAmB,EAEtB,CARD,C","sourcesContent":["// Register service worker and install PWA\n\nimport veda from '../common/veda.js';\n\nif ('serviceWorker' in navigator) {\n  const HTML = `\n    <div class=\"container margin-xl\" id=\"install-app\" style=\"display:none;\">\n      <div class=\"well well-sm text-center no-margin bg-white\">\n        Установить приложение на главный экран? Install the application on the main screen?\n        <button id=\"install-btn\" class=\"btn btn-sm btn-primary margin-md margin-md-h\">Установить / Install</button>\n        <button id=\"reject-install-btn\" class=\"btn btn-sm btn-link\" style=\"margin-left:0;padding-left:0;\">Отказаться / Refuse</button>\n      </div>\n    </div>\n  `;\n  const wrapper = document.createElement('div');\n  wrapper.id = 'install-wrapper';\n  wrapper.innerHTML = HTML;\n  document.body.insertBefore(wrapper, document.body.firstChild);\n\n  // Install SW\n  navigator.serviceWorker.register('/sw-simple.js', {scope: window.location.pathname})\n    .then((registration) => {\n      console.log('Service worker registered:', registration.scope);\n\n      // Update application on `update` event\n      veda.on('update', function () {\n        registration.update()\n          .catch(console.log)\n          .then(function (registration) {\n            window.location.reload();\n          });\n      });\n    })\n    .catch((error) => console.log(`Registration failed with ${error}`));\n\n  // Receive and log server worker `veda_version` value\n  navigator.serviceWorker.addEventListener('message', (event) => {\n    console.log(`Service worker veda_version = ${event.data}`);\n  });\n\n  // Ask server worker the value of its veda_version\n  navigator.serviceWorker.ready.then((registration) => {\n    registration.active.postMessage('veda_version');\n  });\n\n  // Install application prompt\n  const showAddToHomeScreen = () => {\n    const installApp = document.getElementById('install-app');\n    const installBtn = document.getElementById('install-btn');\n    const rejectInstallBtn = document.getElementById('reject-install-btn');\n    installApp.style.display = 'block';\n    installBtn.addEventListener('click', addToHomeScreen);\n    rejectInstallBtn.addEventListener('click', rejectInstall);\n  };\n\n  const addToHomeScreen = () => {\n    const installApp = document.getElementById('install-app');\n    installApp.style.display = 'none'; // Hide the prompt\n    deferredPrompt.prompt(); // Wait for the user to respond to the prompt\n    deferredPrompt.userChoice\n      .then((choiceResult) => {\n        if (choiceResult.outcome === 'accepted') {\n          console.log('User accepted install prompt');\n        } else {\n          console.log('User dismissed install prompt');\n        }\n        deferredPrompt = null;\n      });\n  };\n\n  const rejectInstall = () => {\n    const installApp = document.getElementById('install-app');\n    installApp.style.display = 'none';\n    localStorage.rejectedInstall = true;\n  };\n\n  let deferredPrompt;\n  window.addEventListener('beforeinstallprompt', (e) => {\n    // Prevent Chrome 67 and earlier from automatically showing the prompt\n    e.preventDefault();\n    // Stash the event so it can be triggered later.\n    deferredPrompt = e;\n    if (!localStorage.rejectedInstall) {\n      showAddToHomeScreen();\n    }\n  });\n}\n"],"file":"install_sw.js"}