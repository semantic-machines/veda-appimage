// Veda browser utility functions
'use strict';System.register(["../common/veda.js","../common/individual_model.js","../common/backend.js","../browser/notify.js","../common/lib/riot.js"],function(_export,_context){"use strict";function _instanceof(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}/**
 * Synchronous get individual
 * @param {string} ticket
 * @param {string} uri
 * @return {Object} - individual properties object
 */function getSync(a,b){var c=new XMLHttpRequest;if(c.open("GET","get_individual?uri="+b+"&ticket="+a,!1),c.send(),200===c.status)return JSON.parse(c.responseText);throw Error(c)}/**
 * Трансформировать указанные индивидуалы по заданным правилам
 * @param {string|IndividualModel} individuals - один или несколько IndividualModel или их идентификаторов
 * @param {string|IndividualModel} transform - применяемая трансформация
 * @return {Array}
 */var veda,IndividualModel,Backend,Notify,riot,Util;return{setters:[function(a){veda=a.default},function(a){IndividualModel=a.default},function(a){Backend=a.default},function(a){Notify=a.default},function(a){riot=a.default}],execute:function(){// Escape function for css (jQuery) selectors
/**
 * Create specified report
 * @param {string} report - uri of report to create
 * @param {Object} params - parameters to pass to report
 */ /**
 * Show user's rights for individual
 * @param {IndividualModel} individual - authorization subject
 */ /**
 * Start workflow process
 *   - Apply transformation and redirect to start form.
 * @param {IndividualModel} individual
 * @param {template} template - reference to individual view where 'send' was invoked
 * @param {string} transformId - id of a transformation for start form
 * @param {string} _modal - obsolete
 * @param {string} startFormTemplate - id of a start form template
 * @return {void}
 */ /**
 * Build start form using transformation
 * @param {IndividualModel} individual - individual to transform
 * @param {IndividualModel} transformation - transformation individual
 * @return {IndividualModel} - start form
 */Util=veda.Util||{},_export("default",veda.Util=Util),Util.registerHandler=function(a,b,c,d){a.on(c,d),b.one("remove",function(){a.off(c,d)})},Util.escape4$=function(a){return a?a.replace(/([ #;?%&,.+*~\':"!^$[\]()=>|\/@])/g,"\\$1"):a},Util.toTTL=function(a,b){var c={},d=function(a,b){var c,d=veda.ontology.ontologies,e=/^([a-z-0-9]+:)[a-zA-Z0-9-_]*$/.exec(a),f=e?e[1]:null;return"dc"===f?c="http://purl.org/dc/elements/1.1/":"grddl"===f?c="http://www.w3.org/2003/g/data-view#":d[f]&&(c=d[f]["v-s:fullUrl"][0].toString()),c?(b[f]=c,a):"<"+a+">"},e=a.map(function(a){var b="";for(var e in a.properties)if(Object.hasOwnProperty.call(a.properties,e)){var f=a.properties[e];if("@"===e)b=f+"\n"+b,d(f,c);else{var g=f.reduce(function(a,b){var e;switch(b.type){case"Boolean":case"Integer":case"Decimal":e=b.data;break;case"Uri":e=d(b.data,c);break;case"Datetime":e=_instanceof(b.data,Date)?"\""+b.data.toISOString()+"\"^^xsd:dateTime":"\""+b.data+"\"^^xsd:dateTime",d("xsd:",c);break;case"String":e=/("|\n)/.test(b.data)?"\"\"\""+b.data+"\"\"\"":"\""+b.data+"\"",void 0!==b.lang&&"NONE"!==b.lang&&(e+="@"+b.lang.toLowerCase());}return a.length?a+", "+e:e},"");b+="  "+e+" "+g+" ;\n",d(e,c)}}return b+".\n"}).join("\n");for(var f in e="\n"+e,c)Object.hasOwnProperty.call(c,f)&&(e=["@prefix",f,"<"+c[f]+">"].join(" ")+".\n"+e);b(void 0,e)},Util.exportTTL=function(a){System.import("filesaver").then(function(b){var c=b.default;Util.toTTL(a,function(a,b){var d=new Blob([b],{type:"text/plain;charset=utf-8"});c(d,"exported_graph.ttl")})})},Util.createReport=function(a,b){("string"==typeof a||_instanceof(a,String))&&(a=new IndividualModel(a));var c=new IndividualModel("cfg:jasperServerAddress");Promise.all([a.load(),c.load()]).then(function(a){var c=a[0],d=a[1],e=d["rdf:value"][0],f=document.createElement("form");f.setAttribute("method","post"),f.setAttribute("action",e+"flow.html?_flowId=viewReportFlow&reportUnit="+encodeURIComponent(c["v-s:reportPath"][0])+"&output="+encodeURIComponent(c["v-s:reportFormat"][0])+"&documentId="+encodeURIComponent(b.id)+"&ticket="+veda.ticket),f.setAttribute("target","Report"),Object.getOwnPropertyNames(b.properties).forEach(function(a){if("@"!==a&&b.hasValue(a)){var c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name",a.replace(":","_"));var d=b.get(a).map(function(a){return _instanceof(a,IndividualModel)?a.id:_instanceof(a,Date)?a.toISOString():a}).join(",");c.setAttribute("value",d),f.appendChild(c)}});// Set client timezone parameter
var g=new Date().getTimezoneOffset(),h=document.createElement("input");h.setAttribute("type","hidden"),h.setAttribute("name","timezone"),h.setAttribute("value",g),f.appendChild(h),document.body.appendChild(f),window.open("","Report"),f.submit()})},Util.showRights=function(a){var b=$("#individual-modal-template").html(),c=$(b),d=$(".modal-body",c);c.modal(),c.on("hidden.bs.modal",function(){c.remove()}),$("body").append(c),a.present(d,"v-ui:PermissionsTemplate")},Util.showModal=function(a,b,c){$("body").hasClass("modal-open")&&$(".modal").modal("hide").remove();var d=$($("#notification-modal-template").html());d.modal(),$("body").append(d);var e=$(".modal-body",d);return"string"==typeof a&&(a=new IndividualModel(a)),a.present(e,b,c),d.find("#follow").click(function(){var a=d.find("[resource]").first(),b=a.attr("resource"),c=a.data("mode");d.modal("hide"),riot.route(["#",b,"#main",void 0,c].join("/"))}),$(".action#cancel",d).click(function(){d.modal("hide")}),d.on("hidden.bs.modal",function(){d.remove()}),d},Util.showSmallModal=function(a,b,c){var d=$($("#minimal-modal-template").html());d.modal(),$("body").append(d);var e=$(".modal-body",d);return a.present(e,b,c),$(".action#cancel",d).click(function(){d.modal("hide")}),d.on("hidden.bs.modal",function(){d.remove()}),d},Util.confirm=function(a,b,c){var d=$($("#confirm-modal-template").html());d.modal(),d.on("hidden.bs.modal",function(){d.remove()}),$("body").append(d);var e=$(".modal-body",d);return a.present(e,b,c).then(function(){return new Promise(function(a){$(".modal-footer > .ok",d).click(function(){a(!0)}),$(".modal-footer > .cancel",d).click(function(){a(!1)})})})},Util.send=function(a,b,c,d,e){c?("edit"===b.data("mode")?a.isSync(!1)||b.data("save")():Promise.resolve()).then(function(){var b=new IndividualModel(c);return b.load().then(function(b){return Util.buildStartFormByTransformation(a,b).then(function(a){return Util.showModal(a,e,"edit")})})}).catch(function(a){var b=new Notify,c=new IndividualModel("v-s:SendError");throw c.load().then(function(a){b("danger",{name:a})}),console.log("Save before send error:",a.stack),a}):(a["v-wf:hasStatusWorkflow"]=[new IndividualModel("v-wf:ToBeSent")],b.data("save")().then(function(){b.closest(".modal").modal("hide").remove();var a=new Notify,c=new IndividualModel("v-s:SendSuccess");c.load().then(function(b){a("success",{name:b})})}).catch(function(a){var b=new Notify,c=new IndividualModel("v-s:SendError");throw c.load().then(function(a){b("danger",{name:a})}),console.log("Send error:",a.stack),a}))},Util.buildStartFormByTransformation=function(a,b){var c=[a.load(),b.load()];return Promise.all(c).then(function(a){return Util.transformation(a[0].properties,a[1].properties)}).then(function(a){var b=new IndividualModel(a[0]);return b.isNew(!0),b.isSync(!1),b.init()})},Util.transformation=function(individuals,transform){Array.isArray(individuals)||(individuals=[individuals]);var rules=transform["v-wf:transformRule"].map(function(a){return a.data});return rules.length?Backend.get_individuals(veda.ticket,rules).then(function(rules){var out_data0={},out_data0_el={},putFieldOfObject=function(){return function(a,b){var c;c=out_data0_el[a],c||(c=[]),c.push(individual[b]),out_data0_el[a]=c}}(),putUri=function(){return function(a,b){var c;c=out_data0_el[a],c||(c=[]),c.push({data:b,type:"Uri"}),out_data0_el[a]=c}}(),setUri=function(a,b){out_data0_el[a]=[{data:b,type:"Uri"}]},putString=function(){return function(a,b){var c;c=out_data0_el[a],c||(c=[]),c.push({data:b,type:"String"}),out_data0_el[a]=c}}(),setString=function(){return function(a,b){var c=[];c.push({data:b,type:"String"}),out_data0_el[a]=c}}(),setDatetime=function(){return function(a,b){var c=[];c.push({data:b,type:"Datetime"}),out_data0_el[a]=c}}(),putDatetime=function(){return function(a,b){var c;c=out_data0_el[a],c||(c=[]),c.push({data:b,type:"Datetime"}),out_data0_el[a]=c}}(),putBoolean=function(){return function(a,b){var c;c=out_data0_el[a],c||(c=[]),c.push({data:b,type:"Boolean"}),out_data0_el[a]=c}}(),setBoolean=function(){return function(a,b){var c=[];c.push({data:b,type:"Boolean"}),out_data0_el[a]=c}}(),putInteger=function(){return function(a,b){var c=out_data0_el[a];c||(c=[]),c.push({data:b,type:"Integer"}),out_data0_el[a]=c}}(),setInteger=function(){return function(a,b){var c=[];c.push({data:b,type:"Integer"}),out_data0_el[a]=c}}();/* PUT functions [END] */for(var key in individuals)Object.hasOwnProperty.call(individuals,key)&&function(){// print("#1 key=", key);
for(var individual=individuals[key],objectContentStrValue=function(){return function(a,b){if(individual[a]){var c=!1;for(var d in individual[a])b===individual[a][d].data&&(c=!0);return c}}}(),iteratedObject=Object.keys(individual),_loop=function(key2){var element=individual[iteratedObject[key2]],putValue=function(){return function(a){var b=out_data0_el[a];if(b||(b=[]),"@"==iteratedObject[key2])b.push({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(var c in element)Object.hasOwnProperty.call(element,c)&&b.push(element[c]);else b.push(element);out_data0_el[a]=b}}(),putValueFrom=function(){return function(a,b){var c=out_data0_el[a];c||(c=[]);var d=!0===Array.isArray(element)?Util.getUri(element):element.data?element.data:element;var e=getSync(veda.ticket,d);for(var f=0;f<b.length-1;f++){if(!e||!e[b[f]])return;var g=Array.isArray(e[b[f]])&&e[b[f]][0].data?e[b[f]][0].data:e[b[f]];e=getSync(veda.ticket,g)}e&&e[b[b.length-1]]&&(c=c.concat(e[b[b.length-1]]),out_data0_el[a]=c)}}(),putFrontValue=function(){return function(a){var b=out_data0_el[a];if(b||(b=[]),"@"==iteratedObject[key2])b.unshift({data:element,type:"Uri"});else if(!0===Array.isArray(element))for(var c in element)Object.hasOwnProperty.call(element,c)&&b.unshift(element[c]);else b.unshift(element);out_data0_el[a]=b}}(),putElement=function(){return function(){var a=iteratedObject[key2];if("@"!=a){var b=[];if(b=out_data0_el[a],b||(b=[]),!0===Array.isArray(element))for(var c in element)Object.hasOwnProperty.call(element,c)&&b.push(element[c]);else b.push(element);out_data0_el[a]=b}}}(),contentName=function(){return function(a){return iteratedObject[key2]==a}}(),elementContentStrValue=function(){return function(a,b){if(iteratedObject[key2]!==a)return!1;var c=element[0].data;return c==b}}(),getElement=function(){return function(){return element}}();// выполняем все rules
for(var key3 in rules)if(Object.hasOwnProperty.call(rules,key3)){var rule=rules[key3],segregateObject=rule["v-wf:segregateObject"],segregateElement=rule["v-wf:segregateElement"],grouping=rule["v-wf:grouping"],res=void 0;// 1. v-wf:segregateObject
if(segregateObject&&(res=eval(segregateObject[0].data),!1==res))continue;if(segregateElement&&(res=eval(segregateElement[0].data),!1==res))continue;// 3. v-wf:aggregate
var group_key=void 0;if(!grouping)out_data0_el={},out_data0_el["@"]=Util.genUri()+"-tr";else{var useExistsUid=!1;for(var i in grouping)if(Object.hasOwnProperty.call(grouping,i)){var gk=grouping[i].data;"@"==gk?useExistsUid=!0:group_key=gk}out_data0_el=out_data0[group_key],out_data0_el||(out_data0_el={},out_data0_el["@"]=useExistsUid?individual["@"]:Util.genUri()+"-tr")}for(var agregate=rule["v-wf:aggregate"],i2=0;i2<agregate.length;i2++)eval(agregate[i2].data);grouping?out_data0[group_key]=out_data0_el:out_data0[out_data0_el["@"]]=out_data0_el}},key2=0;key2<iteratedObject.length;key2++)_loop(key2)}();var out_data=[];for(var _key in out_data0)Object.hasOwnProperty.call(out_data0,_key)&&out_data.push(out_data0[_key]);return out_data}).catch(function(a){console.log(a)}):Promise.resolve()}}}});
//# sourceMappingURL=util.js.map