// Veda application authentication
'use strict';System.register(["../common/veda.js","../common/backend.js","../common/individual_model.js","../common/lib/sha256.js","jquery","../browser/dom_helpers.js"],function(a){"use strict";function b(){/**
   * Submit credentials handler
   * @param {Event} event
   * @return {void}
   */function a(a){a.preventDefault();var b=n.querySelector("#password"),c=n.querySelector("#login").value,g=b.value,h=f.hash(g);b.value="";var k=new e("cfg:NTLMAuthProvider",!0,!1);return k.load().then(function(a){var b=!a.hasValue("v-s:deleted",!0)&&a.hasValue("rdf:value")&&a.get("rdf:value")[0];return b?new Promise(function(a,b){var d=new XMLHttpRequest;d.open("POST","/ad",!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),d.responseType="json",d.onload=function(){200===d.status?a(d.response):b(Error("AD form auth failed"))},d.onerror=b,d.onabort=b,d.send("login=".concat(c,"&password=").concat(g))}):Promise.reject(Error("AD provider is not defined"))})["catch"](function(a){return console.log(a),d.authenticate(c,h)}).then(j)["catch"](i)}/**
   * Initialize CAPTCHA
   * @param {Function} onSuccess
   * @param {Function} onExpired
   * @param {Function} onError
   * @return {void}
   */function b(a,b,c){if(!q){var d=new e("cfg:reCAPTCHA_client_key");d.load().then(function(d){window.captchaCallback=function(){grecaptcha.render("recaptcha",{sitekey:d.get("rdf:value")[0].toString(),theme:"light",callback:a,"expired-callback":b,"error-callback":c}),q=!0};var e=document.createElement("script");e.src="https://www.google.com/recaptcha/api.js?onload=captchaCallback&render=explicit",document.head.appendChild(e)})}else grecaptcha.reset()}/**
   * Login error handler
   * @param {Error} error
   * @return {void}
   */function i(a){var c=n.querySelector("#enter-login-password");c.style.display="none";var d=n.querySelector("#enter-new-password");d.style.display="none";var e=n.querySelector("#invalid-secret-warning"),f=n.querySelector("#empty-password-warning"),g=n.querySelector("#equal-password-warning"),h=n.querySelector("#invalid-password-warning"),i=n.querySelector("#frequent-pass-change-warning"),j=n.querySelector("#pass-change-not-allowed-warning"),k=n.querySelector("#secret-expired-warning"),l=n.querySelector("#password-expired-error"),m=n.querySelector("#login-failed-error"),o=n.querySelector("#auth-locked-error"),q=n.querySelector("#pass-change-locked-error"),r=n.querySelector("#unavailable-error"),s=n.querySelector("#secret-request-info"),t=n.querySelectorAll(".alert");Array.prototype.forEach.call(t,function(a){return a.style.display="none"});var u=n.querySelectorAll("input:not(#login)");Array.prototype.forEach.call(u,function(a){return a.value=""});var v=n.querySelector(".btn.ok");v.style.display="none";var w=function okHandler(){},x=function(){Array.prototype.forEach.call(n.querySelectorAll(".alert, fieldset"),function(a){return a.style.display="none"}),c.style.display="block"};switch(a.code){case 423:i.style.display="block",v.style.display="block",w=function okHandler(){i.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 429:o.style.display="block",v.style.display="block",w=function _okHandler(){o.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 430:q.style.display="block",v.style.display="block",w=function _okHandler2(){q.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 463:j.style.display="block",v.style.display="block",w=function _okHandler3(){j.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 464:k.style.display="block",v.style.display="block",w=function _okHandler4(){k.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 465:f.style.display="block",v.style.display="block",w=function _okHandler5(){f.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 466:g.style.display="block",v.style.display="block",w=function _okHandler6(){g.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 467:h.style.display="block",v.style.display="block",w=function _okHandler7(){h.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 468:e.style.display="block",v.style.display="block",w=function _okHandler8(){e.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};break;case 469:p?(d.style.display="block",s.style.display="block"):(l.style.display="block",s.style.display="block",v.style.display="block",w=function _okHandler9(){l.style.display="none",d.style.display="block",v.removeEventListener("click",w),v.style.display="none"});break;case 472:// Not authorized
case 473:m.style.display="block",c.style.display="none",b(x,void 0,x);break;default:r.style.display="block",v.style.display="block",w=function _okHandler10(){r.style.display="none",c.style.display="block",v.removeEventListener("click",w),v.style.display="none"};}v.addEventListener("click",w)}/**
   * Login success handler
   * @param {Object} authResult
   * @return {void}
   */function j(a){var b=n.querySelector("#enter-login-password"),d=n.querySelectorAll(".alert");Array.prototype.forEach.call(d,function(a){return a.style.display="none"});var e=n.querySelectorAll("input:not(#login)");Array.prototype.forEach.call(e,function(a){return a.value=""});var f=n.querySelector(".btn.ok");f.style.display="none",b.style.display="block",c.trigger("login:success",a)}/**
   * Set ticket cookie
   * @param {string} ticket
   * @param {number} expires
   * @return {void}
   */function k(a,b){var c="ticket="+a+"; expires="+new Date(parseInt(b)).toGMTString()+"; samesite=strict; path=/;"+("https:"===window.location.protocol?"secure;":"");document.cookie=c}/**
   * Delete ticket cookie
   * @return {void}
   */function l(){k(null,0)}var m=window.localStorage,n=document.getElementById("login-form");// Login invitation
n.querySelector("#submit-login-password").addEventListener("click",a),h(n,"keyup","#login, #password",function(b){"Enter"===b.key&&a(b)}),h(n,"click",".show-password",function(){var a=n.querySelectorAll(".password");a.forEach(function(a){return a.type="password"===a.type?"text":"password"})}),h(n,"input","#new-password, #confirm-new-password, #secret",/**
   * Validate new password
   * @param {Event} event
   * @return {void}
   */function(){var a=n.querySelector("#submit-new-password"),b=n.querySelector("#new-password"),c=n.querySelector("#confirm-new-password"),d=n.querySelector(".password-strength"),e=n.querySelector(".password-must-match"),f=n.querySelector("#secret"),g=n.querySelector(".enter-secret"),h=o.test(b.value),i=c.value===b.value,j=!!f.value;d.style.display=h?"none":"block",e.style.display=i?"none":"block",g.style.display=j?"none":"block",h&&i&&j?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});var o=/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{6,})/;n.querySelector("#submit-new-password").addEventListener("click",function(a){a.preventDefault();var b=n.querySelector("#login").value,c=n.querySelector("#new-password").value,e=n.querySelector("#secret").value,g=f.hash(c);d.authenticate(b,g,e).then(j)["catch"](i).then(function(){n.querySelector("#new-password").value="",n.querySelector("#confirm-new-password").value=""})});var p;n.querySelector("#change-password").addEventListener("click",function(a){a.preventDefault(),p=!0;var b=n.querySelector("#login").value;d.authenticate(b,void 0,"?").then(j)["catch"](i)});// CAPTCHA already rendered flag
var q=!1;c.on("login:failed",function(){if(g("#app").empty(),delete m.ticket,delete m.user_uri,delete m.end_time,l(),m.logout)return n.style.display="block",void delete m.logout;// NTLM auth using iframe
var a=new e("cfg:NTLMAuthProvider",!0,!1);a.load().then(function(a){var b=!a.hasValue("v-s:deleted",!0)&&a.hasValue("rdf:value")&&a.get("rdf:value")[0];if(b){var d=document.createElement("iframe");d.classList.add("hidden"),n.appendChild(d),d.addEventListener("load",function(){try{n.style.display="none";var a=d.contentWindow.document,b=a.getElementById("ticket").textContent,e=a.getElementById("user_uri").textContent,f=a.getElementById("end_time").textContent;if(b&&e&&f)c.trigger("login:success",{ticket:b,user_uri:e,end_time:f});else throw Error("auto ntlm auth failed")}catch(a){console.log(a),n.style.display="block"}}),document.domain=document.domain,d.setAttribute("src",b)}else n.style.display="block"})}),c.on("login:success",function(a){// Re-login on ticket expiration
if(n.style.display="none",c.user_uri=m.user_uri=a.user_uri,c.ticket=m.ticket=a.ticket,c.end_time=m.end_time=a.end_time,k(c.ticket,c.end_time),c.end_time){var b=parseInt(c.end_time)-Date.now(),d=Math.floor(b/1e3/60/60),e=Math.floor(b/1e3/60-60*d);console.log("Ticket will expire in %d hrs. %d mins.",d,e),setTimeout(function(){console.log("Ticket expired, re-login."),c.trigger("login:failed")},b)}document.getElementById("load-indicator").style.display="block",c.init(c.user_uri).then(function(){document.getElementById("load-indicator").style.display="none",c.trigger("started")})}),h(document.body,"click","#logout, .logout",function(){delete m.ticket,delete m.user_uri,delete m.end_time,l(),m.logout=!0,window.location.reload()}),document.getElementById("load-indicator").style.display="block",c.init("cfg:Guest").then(function(){// Check if ticket is valid
var a=m.ticket,b=m.user_uri,c=new Date<new Date(parseInt(m.end_time))&&m.end_time;return!!(a&&b&&c)&&d.is_ticket_valid(a)}).then(function(a){if(a)c.trigger("login:success",{ticket:m.ticket,user_uri:m.user_uri,end_time:m.end_time});else{var b=new e("cfg:AuthRequired");b.load().then(function(a){a&&a.hasValue("rdf:value",!1)?c.trigger("login:success",{ticket:"",user_uri:"cfg:Guest",end_time:0}):c.trigger("login:failed")})}}).then(function(){document.getElementById("load-indicator").style.display="none"})}var c,d,e,f,g,h;return a("default",b),{setters:[function(a){c=a.default},function(a){d=a.default},function(a){e=a.default},function(a){f=a.default},function(a){g=a.default},function(a){h=a.delegateHandler}],execute:function(){}}});
//# sourceMappingURL=auth.js.map