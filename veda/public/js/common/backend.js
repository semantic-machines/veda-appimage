'use strict';System.register(["../common/veda.js","../browser/local_db.js"],function(a){"use strict";function b(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function c(a){"@babel/helpers - typeof";return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},c(a)}/**
 * Line status event handler
 * @param {string} state
 * @this AppModel
 */function d(a){p.line="online"===a?1:"offline"===a?0:p.line,p.ccus="ccus-online"===a?1:"ccus-offline"===a?0:p.ccus,m.status=p.line&&p.ccus?"online":p.line&&!p.ccus?"limited":"offline",this.trigger("status",m.status)}// Server errors
/**
 * Server errors constructor
 * @param {Error} result
 */function e(a){var b={0:"Server unavailable",200:"Ok",201:"Created",204:"No content",400:"Bad request",403:"Forbidden",404:"Not found",422:"Unprocessable entity",423:"Locked",429:"Too many requests",430:"Too many password change fails",463:"Password change is not allowed",464:"Secret expired",465:"Empty password",466:"New password is equal to old",467:"Invalid password",468:"Invalid secret",469:"Password expired",470:"Ticket not found",471:"Ticket expired",472:"Not authorized",473:"Authentication failed",474:"Not ready",475:"Fail open transaction",476:"Fail commit",477:"Fail store",500:"Internal server error",501:"Not implemented",503:"Service unavailable",904:"Invalid identifier",999:"Database modified error",1021:"Disk full",1022:"Duplicate key",1118:"Size too large",4e3:"Connect error"};this.code=a.status,this.name=b[this.code],this.status=a.status,this.message=b[this.code],this.stack=new Error().stack,(0===a.status||503===a.status||4e3===a.status)&&(j.trigger("offline"),m.check()),(470===a.status||471===a.status)&&j.trigger("login:failed")}/**
 * Common server call function
 * @param {Object} params
 * @return {Promise<Object>}
 */function f(a){var b=a.method,c=a.url,d=a.data,f=a.ticket,g=a.timeout||n,h=[],i=null;return new Promise(function(a,j){var k=new XMLHttpRequest;if(k.onload=function(){200==this.status?a(JSON.parse(this.response)):j(new e(this))},k.onerror=function(){j(new e(this))},k.ontimeout=function(){j(new e(this))},f&&h.push("ticket="+f),"GET"===b){for(var l in d)"undefined"!=typeof d[l]&&h.push(l+"="+encodeURIComponent(d[l]));h=h.join("&")}k.open(b,c+"?"+h,!0),k.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate"),k.timeout=g,"GET"!==b&&(k.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i=JSON.stringify(d)),k.send(i)})}/**
 * Common server PUT call function
 * @param {Object} params
 * @return {Promise<Object>}
 */function g(a){return f(a)["catch"](function(b){if(0===b.code||503===b.code||4e3===b.code)return h(a).then(function(a){return console.log("Offline operation added to queue, queue length = ",a.length),{op_id:0,result:200}});throw b})}// //////////////////////////////////////////////////////////////////////
/**
 * Enqueue failed PUT request to Offline queue to execute later
 * @param {Object} params
 * @return {Promise}
 */function h(a){"object"===c(a)&&(a.ticket=void 0);var b=new k;return b.then(function(b){return b.get("offline-queue").then(function(c){return c=c||[],c.push(JSON.stringify(a)),b.put("offline-queue",c)})})}/**
 * Execute enqueued requests
 * @return {Promise}
 */function i(){var a=new k;return a.then(function(a){return a.get("offline-queue").then(function(b){return b&&b.length?j.ticket?m.is_ticket_valid(j.ticket).then(function(c){return c?b.reduce(function(a,b){return a.then(function(){return b=JSON.parse(b),b.ticket=j.ticket,f(b)})["catch"](function(a){console.log("Offline queue operation failed:",b,a)})},Promise.resolve()).then(function(){return a.remove("offline-queue"),b.length}):Promise.reject(Error("Ticket is not valid, skip queue flushing."))}):Promise.reject(Error("No ticket, skip queue flushing.")):0})})}var j,k,l,m,n,o,p,q,r,s,t;return{setters:[function(a){j=a.default},function(a){k=a.default}],execute:function(){l={},m={},a("default",j.Backend="server"===j.env?l:m),l.status="limited",l.query=function(a,b,d,e,f,g,h){var i=a,j="object"===c(i);j&&(a=i.ticket,b=i.query,d=i.sort,e=i.databases,f=i.top,g=i.limit,h=i.from);try{return Promise.resolve(query(a,b,d,e,f,g,h))}catch(a){return Promise.reject(a)}},l.get_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.uri);try{var f=get_individual(a,b);return f?Promise.resolve(f):Promise.reject(Error("Not found"))}catch(a){return Promise.reject(a)}},l.reset_individual=l.get_individual,l.get_individuals=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.uris);try{return Promise.resolve(get_individuals(a,b))}catch(a){return Promise.reject(a)}},l.remove_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.uri);try{return Promise.resolve(remove_individual(a,b))}catch(a){return Promise.reject(a)}},l.put_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.individual);try{return Promise.resolve(put_individual(a,b))}catch(a){return Promise.reject(a)}},l.add_to_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.individual);try{return Promise.resolve(add_to_individual(a,b))}catch(a){return Promise.reject(a)}},l.set_in_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.individual);try{return Promise.resolve(set_in_individual(a,b))}catch(a){return Promise.reject(a)}},l.remove_from_individual=function(a,b){var d=a,e="object"===c(d);e&&(a=d.ticket,b=d.individual);try{return Promise.resolve(remove_from_individual(a,b))}catch(a){return Promise.reject(a)}},n=15e3,o=10*n,m.ping=function(){return new Promise(function(a,b){var c=new XMLHttpRequest;c.onload=function(){200==this.status?a(this):b(Error("ping failed"))},c.onerror=b,c.ontimeout=b,c.open("GET","/ping"),c.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate"),c.timeout=n,c.send()})},m.status="offline",p={};j.on("online offline ccus-online ccus-offline",d),r=n,s=function(){m.ping().then(function(){q=clearInterval(q),j.trigger("online")})["catch"](function(){j.trigger("offline")})},m.check=function(){q||(q=setInterval(s,r),!arguments.length&&s())},"undefined"!=typeof window&&(window.addEventListener("online",m.check),window.addEventListener("offline",m.check),j.on("ccus-online",m.check),j.on("ccus-offline",m.check)),e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,m.get_rights=function(a,b){var d=a,e="object"===c(d),g={method:"GET",url:"/get_rights",ticket:e?d.ticket:a,timeout:n,data:{uri:e?d.uri:b}};return f(g)["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code)return{"@":"_","rdf:type":[{data:"v-s:PermissionStatement",type:"Uri"}],"v-s:canCreate":[{data:!0,type:"Boolean"}],"v-s:canDelete":[{data:!1,type:"Boolean"}],"v-s:canRead":[{data:!0,type:"Boolean"}],"v-s:canUpdate":[{data:!0,type:"Boolean"}]};throw a})},m.get_rights_origin=function(a,b){var d=a,e="object"===c(d),g={method:"GET",url:"/get_rights_origin",ticket:e?d.ticket:a,timeout:n,data:{uri:e?d.uri:b}};return f(g)["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code)return[];throw a})},m.get_membership=function(a,b){var d=a,e="object"===c(d),g={method:"GET",url:"/get_membership",ticket:e?d.ticket:a,timeout:n,data:{uri:e?d.uri:b}};return f(g)["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code)return{"@":"_","rdf:type":[{data:"v-s:Membership",type:"Uri"}],"v-s:memberOf":[{data:"v-s:AllResourcesGroup",type:"Uri"}],"v-s:resource":[{data:e?d.uri:b,type:"Uri"}]};throw a})},m.authenticate=function(a,b,d){"VedaNTLMFilter"==a&&(a="cfg:Guest");var e=a,g="object"===c(e),h={method:"GET",url:"/authenticate",timeout:n,data:{login:g?e.login:a,password:g?e.password:b,secret:g?e.secret:d}};return f(h).then(function(a){return{ticket:a.id,user_uri:a.user_uri,end_time:Math.floor((a.end_time-621355968e9)/1e4)}})},m.get_ticket_trusted=function(a,b){var d=a,e="object"===c(d),g={method:"GET",url:"/get_ticket_trusted",ticket:e?d.ticket:a,timeout:n,data:{login:e?d.login:b}};return f(g)},m.is_ticket_valid=function(a){var b=a,d="object"===c(b),e={method:"GET",url:"/is_ticket_valid",ticket:d?b.ticket:a,timeout:n,data:{}};return f(e)["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code)return!0;throw a})},m.get_operation_state=function(a,b){var d=a,e="object"===c(d),g={method:"GET",url:"/get_operation_state",timeout:n,data:{module_id:e?d.module_id:a,wait_op_id:e?d.wait_op_id:b}};return f(g)},m.wait_module=function(a,b){for(var c,d=1,e=0;100>e&&(c=m.get_operation_state(a,b),!(c>=b));e++){for(var f=new Date().getTime()+d;new Date().getTime()<f;);d+=2}},m.query=function(a,b,d,e,g,h,i,j,l){var n=a,p="object"===c(n),q={method:"POST",url:"/query",ticket:p?n.ticket:a,timeout:o,data:{query:p?n.query:b,sort:p?n.sort:d,databases:p?n.databases:e,reopen:p?n.reopen:g,top:p?n.top:h,limit:p?n.limit:i,from:p?n.from:j,sql:p?n.sql:l}};return f(q)["catch"](function(c){if(999===c.code)return m.query(a,b,d,e,g,h,i,j,l);if(0===c.code||503===c.code||4e3===c.code){q.ticket=void 0;var f=new k;return f.then(function(a){return a.get(JSON.stringify(q))})}throw c}).then(function(a){if(a){q.ticket=void 0;var b=new k;b.then(function(b){b.put(JSON.stringify(q),a)})}else a={result:[],count:0,estimated:0,processed:0,cursor:0,result_code:200};return a})},m.get_individual=function(a,b,d){var e=a,g="object"===c(e),h={method:"GET",url:"/get_individual",ticket:g?e.ticket:a,timeout:n,data:{uri:g?e.uri:b,reopen:(g?e.reopen:d)||!1}};if("online"===m.status||"offline"===m.status){// Cache first
var i=new k;return i.then(function(a){return a.get(h.data.uri)}).then(function(a){return a||f(h).then(function(a){var b=new k;return b.then(function(b){b.put(a["@"],a)})["catch"](console.log),a})})}// Fetch second
return m.reset_individual(a,b,d)},m.reset_individual=function(a,b,d){var e=a,g="object"===c(e),h={method:"GET",url:"/get_individual",ticket:g?e.ticket:a,timeout:n,data:{uri:g?e.uri:b,reopen:(g?e.reopen:d)||!1}};// Fetch first
return f(h).then(function(a){var b=new k;return b.then(function(b){b.put(a["@"],a)}),a})["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code){// Cache second
var b=new k;return b.then(function(a){return a.get(h.data.uri)}).then(function(b){if(b)return b;throw a})}throw a})},m.get_individuals=function(a,b){var d=a,e="object"===c(d),g={method:"POST",url:"/get_individuals",ticket:e?d.ticket:a,timeout:n,data:{uris:e?d.uris:b}};if("online"===m.status||"offline"===m.status){// Cache first
var h=new k;return h.then(function(a){var b=[],c=[];return g.data.uris.reduce(function(d,e,f){return d.then(function(){return a.get(e).then(function(a){return"undefined"==typeof a?c.push(e):b[f]=a,b})["catch"](function(){return c.push(e),b})})},Promise.resolve(b)).then(function(){return c.length?(g.data.uris=c,f(g)):[]}).then(function(c){for(var d=0,e=0,f=c.length;d<f;d++){for(;b[e++];);// Fast forward to empty element
b[e-1]=c[d],a.put(c[d]["@"],c[d])}return b})["catch"](console.log)})}// Fetch second
return f(g).then(function(a){var b=new k;return b.then(function(b){a.reduce(function(a,c){a.then(function(){return b.put(c["@"],c)})},Promise.resolve())}),a})["catch"](function(a){if(0===a.code||503===a.code||4e3===a.code){// Cache fallback
var b=new k;return b.then(function(a){var b=g.data.uris.map(function(b){return a.get(b)});return Promise.all(b).then(function(a){return a.filter(Boolean)})})}throw a})},m.remove_individual=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/remove_individual",ticket:i?h.ticket:a,timeout:n,data:{uri:i?h.uri:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j).then(function(){var a=new k;return a.then(function(a){return a.remove(j.data.uri)})})},m.put_individual=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/put_individual",ticket:i?h.ticket:a,timeout:n,data:{individual:i?h.individual:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j).then(function(){var a=new k;a.then(function(a){a.put(j.data.individual["@"],j.data.individual)})["catch"](console.log)})},m.add_to_individual=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/add_to_individual",ticket:i?h.ticket:a,timeout:n,data:{individual:i?h.individual:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j)},m.set_in_individual=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/set_in_individual",ticket:i?h.ticket:a,timeout:n,data:{individual:i?h.individual:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j)},m.remove_from_individual=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/remove_from_individual",ticket:i?h.ticket:a,timeout:n,data:{individual:i?h.individual:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j)},m.put_individuals=function(a,b,d,e,f){var h=a,i="object"===c(h),j={method:"PUT",url:"/put_individuals",ticket:i?h.ticket:a,timeout:n,data:{individuals:i?h.individuals:b,assigned_subsystems:(i?h.assigned_subsystems:d)||0,prepare_events:!0,event_id:(i?h.event_id:e)||"",transaction_id:(i?h.transaction_id:f)||""}};return g(j).then(function(){var a=new k;a.then(function(a){j.data.individuals.forEach(function(b){a.put(b["@"],b)})})["catch"](console.log)})},m.uploadFile=function(a,c){return c="number"==typeof c?c:5,new Promise(function(c,d){var e=function(){d(Error("File upload error"))},f=a.file,g=a.path,h=a.uri,i=a.progress,j=new XMLHttpRequest,k=new FormData;j.open("POST","/files",!0),j.timeout=1e3*(10*60),j.upload.onprogress=i,j.onload=function done(){200===j.status?c(a):d(Error("File upload error"))},j.onerror=e,j.onabort=e,j.ontimeout=e,k.append("path",g),k.append("uri",h),b(f,File)?k.append("file",f):b(f,Image)&&k.append("content",f.src),j.send(k)})["catch"](function(b){if(0<c)return m.uploadFile(a,--c);throw b})},t=function(a){var b={};return function(){var c=0>=arguments.length?void 0:arguments[0];if(c in b)return b[c];var d=a(c);return b[c]=d,d}},m.loadFile=t(function(a){return new Promise(function(b,c){var d=function(){c(Error("File load error"))},e=new XMLHttpRequest;e.open("GET",a,!0),e.timeout=1e3*(60*10),e.onload=function done(){200===e.status?b(e.response):c(Error("File load error"))},e.onerror=d,e.onabort=d,e.ontimeout=d,e.send()})}),j.on("online started",function(){"online"===m.status&&(console.log("Veda 'online', flushing queue"),i().then(function(a){console.log("Done, queue flushed",a)})["catch"](console.log))})}}});
//# sourceMappingURL=backend.js.map