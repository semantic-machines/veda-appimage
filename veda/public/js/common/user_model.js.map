{"version":3,"sources":["../../../source-web/js/common/user_model.js"],"names":["UserModel","uri","IndividualModel","call","veda","prototype","Object","create","constructor","proto","getLanguage","preferences","language","keys","_init","load","then","initAspect","bind","initAppointment","initPreferences","initLanguage","id","save","error","console","log","stack","hasValue","aspect","aspect_id","loadedAspect","appointment","on","setAppointment","preferences_id","setLanguage","reduce","acc","lang","substr","indexOf","trigger","setDisplayedElements","displayedElements","updatePreferences","defaultLanguage"],"mappings":"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","sourcesContent":["// User Model\n\nimport veda from '../common/veda.js';\n\nimport IndividualModel from '../common/individual_model.js';\n\nexport default veda.UserModel = UserModel;\n\n/**\n * Application user\n * @param {string} uri\n * @return {UserModel}\n */\nfunction UserModel(uri) {\n  return IndividualModel.call(this, uri);\n};\n\nUserModel.prototype = Object.create(IndividualModel.prototype);\n\nUserModel.prototype.constructor = UserModel;\n\nconst proto = UserModel.prototype;\n\nproto.getLanguage = function () {\n  return this.preferences && this.preferences.language ? Object.keys(this.preferences.language) : undefined;\n};\n\nproto._init = function () {\n  return this.load()\n    .then(this.initAspect.bind(this))\n    .then(this.initAppointment.bind(this))\n    .then(this.initPreferences.bind(this))\n    .then(this.initLanguage.bind(this))\n    .then(() => {\n      if ( this.id !== 'cfg:Guest' ) {\n        return this.save();\n      }\n    })\n    .catch((error) => {\n      console.log('User init error', error.stack);\n    });\n};\n\nproto.initAspect = function () {\n  if ( this.hasValue('v-s:hasAspect') ) {\n    this.aspect = this['v-s:hasAspect'][0];\n    return this.aspect.load();\n  } else {\n    const aspect_id = this.id + '_aspect';\n    return new IndividualModel(aspect_id).load().then((loadedAspect) => {\n      if (loadedAspect.hasValue('rdf:type', 'rdfs:Resource')) {\n        this.aspect = new IndividualModel(aspect_id);\n        this.aspect['rdf:type'] = [new IndividualModel('v-s:PersonalAspect')];\n        this.aspect['v-s:owner'] = [this];\n        this.aspect['rdfs:label'] = ['PersonalAspect_' + this.id];\n        this['v-s:hasAspect'] = [this.aspect];\n        if ( this.id !== 'cfg:Guest' ) {\n          return this.aspect.save();\n        }\n      } else {\n        this.aspect = loadedAspect;\n        this['v-s:hasAspect'] = [this.aspect];\n        return this.aspect;\n      }\n    });\n  }\n};\n\nproto.initAppointment = function () {\n  if (this.hasValue('v-s:defaultAppointment')) {\n    veda.appointment = this['v-s:defaultAppointment'][0];\n  } else if (this.hasValue('v-s:hasAppointment')) {\n    this['v-s:defaultAppointment'] = [this['v-s:hasAppointment'][0]];\n    veda.appointment = this['v-s:defaultAppointment'][0];\n  } else {\n    return veda.appointment = undefined;\n  }\n  const setAppointment = () => {\n    const appointment = this.hasValue('v-s:defaultAppointment') && this['v-s:defaultAppointment'][0];\n    if (appointment) {\n      appointment.load().then((appointment) => {\n        veda.appointment = appointment;\n      });\n    }\n    this.save();\n  };\n  this.on('v-s:defaultAppointment', setAppointment);\n  return veda.appointment.load();\n};\n\nproto.initPreferences = function () {\n  if ( this.hasValue('v-ui:hasPreferences') ) {\n    this.preferences = this['v-ui:hasPreferences'][0];\n    return this.preferences.load();\n  } else {\n    const preferences_id = this.id + '_pref';\n    this.preferences = new IndividualModel(preferences_id);\n    this.preferences['v-s:owner'] = [this];\n    this.preferences['rdf:type'] = [new IndividualModel('v-ui:Preferences')];\n    this.preferences['rdfs:label'] = ['Preferences_' + this.id];\n    this['v-ui:hasPreferences'] = [this.preferences];\n    return this.preferences;\n  }\n};\n\nproto.initLanguage = function (preferences) {\n  const setLanguage = () => {\n    preferences.language = preferences['v-ui:preferredLanguage'].reduce( function (acc, lang) {\n      acc[lang.id.substr(lang.id.indexOf(':') + 1)] = lang;\n      return acc;\n    }, {});\n    veda.trigger('language:changed');\n  };\n  const setDisplayedElements = function () {\n    preferences.displayedElements = preferences['v-ui:displayedElements'][0] || 10;\n  };\n  const updatePreferences = () => {\n    if ( this.id !== 'cfg:Guest' ) {\n      return preferences.save();\n    }\n  };\n  if ( !preferences.hasValue('v-ui:preferredLanguage') || !preferences.hasValue('v-ui:displayedElements')) {\n    const defaultDisplayedElements = 10;\n    const defaultLanguage = new IndividualModel('v-ui:RU');\n    preferences['v-ui:preferredLanguage'] = [defaultLanguage];\n    preferences['v-ui:displayedElements'] = [defaultDisplayedElements];\n  }\n  preferences.on('v-ui:preferredLanguage', setLanguage);\n  preferences.on('v-ui:displayedElements', setDisplayedElements);\n  preferences.on('v-ui:preferredLanguage v-ui:displayedElements', updatePreferences);\n  setLanguage();\n  setDisplayedElements();\n  return updatePreferences();\n};\n"],"file":"user_model.js"}